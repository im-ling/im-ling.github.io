<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Ling">
    
    <title>
        
            千行代码构建个人文本编辑器（五）A text editor |
        
        Ling&#39;s blog
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="/images/l.svg">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#000000","avatar":"/images/avatar.png","favicon":"/images/l.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.0"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Ling&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">千行代码构建个人文本编辑器（五）A text editor</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Ling</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-03-05 22:01:55
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/C/">C</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/translation/">translation</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/C/">C</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Fun/">Fun</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/">文本编辑器</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="A-text-editor"><a href="#A-text-editor" class="headerlink" title="A text editor"></a>A text editor</h1><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p><a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/05.aTextEditor.html" >原文链接<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="Insert-ordinary-characters-插入原生字符"><a href="#Insert-ordinary-characters-插入原生字符" class="headerlink" title="Insert ordinary characters 插入原生字符"></a>Insert ordinary characters 插入原生字符</h2><p>让我们先写一个函数，在给定位置将单个字符插入到 <code>erow</code> 中。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<h3 id="Step-101"><a href="#Step-101" class="headerlink" title="Step 101"></a>Step 101</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt; row-&gt;size) at = row-&gt;size;</span><br><span class="line">  row-&gt;chars = <span class="built_in">realloc</span>(row-&gt;chars, row-&gt;size + <span class="number">2</span>);</span><br><span class="line">  memmove(&amp;row-&gt;chars[at + <span class="number">1</span>], &amp;row-&gt;chars[at], row-&gt;size - at + <span class="number">1</span>);</span><br><span class="line">  row-&gt;size++;</span><br><span class="line">  row-&gt;chars[at] = c;</span><br><span class="line">  editorUpdateRow(row);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/row-insert-char" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>memmove()</code> 来自 <code>&lt;string.h&gt;</code>。和 <code>memcpy()</code> 功能相似，但相比而言更安全，当新的字符串数据和旧的重叠时不会出问题。</p>
<p>首先，我们会对 <code>at</code> 进行验证，<code>at</code> 是我们要将字符插入其中的索引。请注意，允许 <code>at</code> 超出字符串末尾一个字符，在这种情况下，应将字符插入字符串末尾。</p>
<p>然后，我们再为 <code>erow</code> 的 <code>chars</code> 多分配一个字节（我们加 <code>2</code>，因为我们还必须为 <code>null</code> 腾出空间），并使用 <code>memmove()</code> 为新字符腾出空间。我们增加 <code>chars</code> 数组的 <code>size</code>，然后将字符实际分配给它在数组中的位置。最后，我们调用 <code>editorUpdateRow()</code> ，以便 <code>render</code> 和 <code>rsize</code> 使用新的行内容进行更新。</p>
<p>现在，我们创建一个名为 <code>/*** editor operations ***/</code> 的新部分。本节将包含将按键映射到各种文本编辑操作时从 <code>editorProcessKeypress()</code> 调用的函数。我们将在本节中添加一个名为 <code>editorInsertChar()</code> 的函数，该函数将使用一个字符，并使用 <code>editorRowInsertChar()</code> 将该字符插入光标所在的位置。</p>
<h3 id="Step-102"><a href="#Step-102" class="headerlink" title="Step 102"></a>Step 102</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertChar</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cy == E.numrows) &#123;</span><br><span class="line">    editorAppendRow(<span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  editorRowInsertChar(&amp;E.row[E.cy], E.cx, c);</span><br><span class="line">  E.cx++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-insert-char" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果 <code>E.cy == E.numrows</code>，则光标在文件末尾的波浪线处，因此我们需要在文件中添加新行，然后再在其中插入字符。插入字符后，我们将光标向前移动，以便用户插入的下一个字符将在刚插入的字符之后。</p>
<p>请注意，<code>editorInsertChar()</code> 不必担心修改 <code>erow</code> 的细节，而且 <code>editorRowInsertChar()</code> 不必担心光标在哪里。这就是 <code>/*** editor operations ***/</code> 部分中的功能与 <code>/*** row operations ***/</code> 部分中的功能之间的区别。</p>
<p>让我们在 <code>editorProcessKeypress</code> 函数中 <code>switch</code> 语句的 <code>default:</code> 下调用 <code>editorInsertChar()</code>。这样，所有未映射到其他编辑器功能的按键都可以直接插入正在编辑的文本中。</p>
<h3 id="Step-103"><a href="#Step-103" class="headerlink" title="Step 103"></a>Step 103</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      editorInsertChar(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/key-insert-char" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，我们正式的将文本阅读器变成了文本编辑器。<br><br><br><br></p>
<h2 id="Prevent-inserting-special-characters-防止插入特殊字符"><a href="#Prevent-inserting-special-characters-防止插入特殊字符" class="headerlink" title="Prevent inserting special characters 防止插入特殊字符"></a>Prevent inserting special characters 防止插入特殊字符</h2><p>现在，如果您按 <code>Backspace</code> 或 <code>Enter</code> 这样的键，这些字符将直接插入到文本中，这当然是我们所不希望的。让我们在 <code>editorProcessKeypress()</code> 中处理一些这样的特殊键，这样它们就不会按<code>default</code>的分支走 <code>editorInsertChar()</code> 函数。</p>
<h3 id="Step-104"><a href="#Step-104" class="headerlink" title="Step 104"></a>Step 104</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span></span><br><span class="line">  BACKSPACE = <span class="number">127</span>,</span><br><span class="line">  ARROW_LEFT = <span class="number">1000</span>,</span><br><span class="line">  ARROW_RIGHT,</span><br><span class="line">  ARROW_UP,</span><br><span class="line">  ARROW_DOWN,</span><br><span class="line">  DEL_KEY,</span><br><span class="line">  HOME_KEY,</span><br><span class="line">  END_KEY,</span><br><span class="line">  PAGE_UP,</span><br><span class="line">  PAGE_DOWN</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">      <span class="comment">/* TODO */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BACKSPACE:</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;h&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="keyword">case</span> DEL_KEY:</span></span><br><span class="line"><span class="function">      <span class="comment">/* TODO */</span></span></span><br><span class="line"><span class="function">      <span class="keyword">break</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;l&#x27;</span>)</span>:</span></span><br><span class="line">    case &#x27;\x1b&#x27;:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      editorInsertChar(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/block-special-chars" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>Backspace</code> 在C语言中没有易于理解的反斜杠转义表示形式（例如 <code>\n</code>，<code>\r</code> 等），因此我们将其设为 <code>editorKey</code> 枚举的一部分，并将其ASCII值分配为 <code>127</code>。</p>
<p>在 <code>editorProcessKeypress()</code>（）中，我们添加到switch语句的第一个新键是 <code>&#39;\r&#39;</code>，即 <code>Enter</code> 键。目前，我们忽略它，我们稍后会做一些事情，因此我们在注释中用 <code>TODO</code> 进行标记。</p>
<p>我们用类似的方式处理 <code>Backspace</code> 和 <code>Delete</code>，并使用 <code>TODO</code> 标记它们。我们之后处理 <code>Ctrl-H</code> 组合键，该组合键发送控制代码 <code>8</code>，这最初是 <code>Backspace</code>字符发送回的代码。如果查看ASCII表，您会发现ASCII码 <code>8</code> 命名为 <code>BS</code>, 也就是“backspace”的缩写；而ASCII码 <code>127</code> 的“删除”命名为 <code>DEL</code>。但是无论出于何种原因，在现代计算机中，<code>Backspace</code> 都映射到 <code>127</code>，而 <code>Delete</code> 键则映射到转义序列 <code>&lt;esc&gt;[3〜</code>，正如我们在 <a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/03.rawInputAndOutput.html#the-delete-key" >第3章<i class="fas fa-external-link-alt"></i></a> 末尾看到的那样。</p>
<p>最后，我们对 <code>Ctrl-L</code> 和 <code>Escape</code> 不进行任何操作。传统上，<code>Ctrl-L</code> 用于刷新终端程序中的屏幕。在我们的文本编辑器中，每次按键后屏幕都会刷新，因此我们无需执行任何其他操作即可实现该功能。我们忽略 <code>Escape</code> 键，因为有许多我们不处理的键转义序列（例如 <code>F1</code> - <code>F12</code> 键），而且根据我们编写的 <code>editorReadKey()</code>，按这些键等同于按 <code>Escape</code> 键。我们不希望用户不经意间在文本中插入转义字符 <code>27</code>，因此我们忽略这些按键。<br><br><br><br></p>
<h2 id="Save-to-disk-保存到硬盘"><a href="#Save-to-disk-保存到硬盘" class="headerlink" title="Save to disk 保存到硬盘"></a>Save to disk 保存到硬盘</h2><p>现在我们终于使文本可编辑了，让我们实现保存到硬盘的功能。首先，我们编写一个函数，将 <code>erow</code> 结构数组转换为单个字符串，以便将其写出到文件中。</p>
<h3 id="Step-105"><a href="#Step-105" class="headerlink" title="Step 105"></a>Step 105</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> totlen = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> j;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; E.numrows; j++)</span><br><span class="line">    totlen += E.row[j].size + <span class="number">1</span>;</span><br><span class="line">  *buflen = totlen;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(totlen);</span><br><span class="line">  <span class="keyword">char</span> *p = buf;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; E.numrows; j++) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(p, E.row[j].chars, E.row[j].size);</span><br><span class="line">    p += E.row[j].size;</span><br><span class="line">    *p = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    p++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/rows-to-string" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>首先，我们将每一行文本的长度加起来，对于每行的长度，我们需要加 <code>1</code> 来容纳一个换行符。之后，我们将总长度保存到buflen中，以告知调用方字符串的长度。</p>
<p>然后，在分配了所需的内存之后，我们遍历各行，并用 <code>memcpy()</code> 将每一行的内容循环到缓冲区的末尾，并在每行之后添加一个换行符。</p>
<p>我们返回 <code>buf</code>，这个 <code>buf</code> 由调用者调用 <code>free()</code> 释放内存。</p>
<p>现在，我们来实现 <code>editorSave()</code> 函数，该函数会将<code>editorRowsToString()</code> 返回的字符串写入磁盘。</p>
<h3 id="Step-106"><a href="#Step-106" class="headerlink" title="Step 106"></a>Step 106</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DEFAULT_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BSD_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  ftruncate(fd, len);</span><br><span class="line">  write(fd, buf, len);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/save" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>open()</code> ， <code>O_RDWR</code> ， 和 <code>O_CREAT</code> 来自 <code>&lt;fcntl.h&gt;</code>。 <code>ftruncate()</code> 和 <code>close()</code> 来自 <code>&lt;unistd.h&gt;</code>.</p>
<p>如果是新文件，则 <code>E.filename</code> 会是 <code>NULL</code>，并且我们不知道将文件保存在何处，因此我们暂时不做任何事情就返回了。稍后，我们将解决如何提示用户输入文件名这个问题。</p>
<p>如果不是新文件，我们将调用 <code>editorRowsToString()</code>，并将字符串写入<code>E.filename</code> 的路径。我们传参告诉 <code>open()</code> 函数， 在文件不存在情况下我们创建一个新文件（<code>O_CREAT</code>），以可读可写方式打开文件（<code>O_RDWR</code>）。因为我们使用了 <code>O_CREAT</code> 标志，所以我们必须传递一个额外的参数，其中包含新文件应具有的模式（权限）。<code>0644</code> 是您通常需要的文本文件标准权限。它授予文件所有者读取和写入的权限，其他所有人仅获得读取权限。</p>
<p><code>ftruncate()</code> 将文件的大小设置为指定的长度。如果文件大于该大小，它将在文件末尾切断所有数据以使其具有该长度。如果文件较短，它将在末尾不断添加字节<code>0</code>以使其具有该长度。</p>
<p>通常,复写文件的方法是将 <code>O_TRUNC</code> 标志传递给 <code>open()</code>，这会在将新数据写入文件之前将其完全截断，使其成为一个空文件。通过将截断文件来将文件长度和计划写入文件的长度相等，可以使整个复写操作更加安全，以防 <code>ftruncate()</code> 调用成功而 <code>write()</code> 调用失败。在这种情况下，文件仍将包含以前拥有的大多数数据。但是，如果通过 <code>open()</code> 调用将文件完全截断，然后 <code>write()</code> 失败，那么最终将丢失所有数据。</p>
<p>更高级的编辑器将写入一个新的临时文件，然后将该文件重命名为用户要要覆盖的实际文件，他们将在整个过程中仔细检查错误。</p>
<p>暂时不管其他的了，总之，我们现在要做的就是将一个键映射到 <code>editorSave()</code>，让我们开始吧！我们将使用 <code>Ctrl-S</code>。</p>
<h3 id="Step-107"><a href="#Step-107" class="headerlink" title="Step 107"></a>Step 107</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">      <span class="comment">/* TODO */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;s&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">editorSave</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BACKSPACE:</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;h&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="keyword">case</span> DEL_KEY:</span></span><br><span class="line"><span class="function">      <span class="comment">/* TODO */</span></span></span><br><span class="line"><span class="function">      <span class="keyword">break</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;l&#x27;</span>)</span>:</span></span><br><span class="line">    case &#x27;\x1b&#x27;:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      editorInsertChar(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/ctrl-s" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在编辑器中打开文件，插入一些字符，按Ctrl-S，然后重新打开文件,您应该能够看到所做的更改已保存。</p>
<p>让我们给 <code>editorSave()</code> 添加错误处理。</p>
<h3 id="Step-108"><a href="#Step-108" class="headerlink" title="Step 108"></a>Step 108</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len) != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(fd, buf, len) == len) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/save-errors" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>open()</code> 和 <code>ftruncate()</code> 均在错误时返回 <code>-1</code>。我们期望 <code>write()</code> 返回我们告诉它写入的字节数。无论是否发生错误，我们都确保关闭文件并释放 <code>buf</code> 指向的内存。</p>
<p>让我们用 <code>editorSetStatusMessage()</code> 通知用户保存是否成功。在此过程中，我们将 <code>Ctrl-S</code> 键绑定添加到在 <code>main()</code> 中的帮助消息中。</p>
<h3 id="Step-109"><a href="#Step-109" class="headerlink" title="Step 109"></a>Step 109</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len) != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(fd, buf, len) == len) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;%d bytes written to disk&quot;</span>, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;Can&#x27;t save! I/O error: %s&quot;</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line">  initEditor();</span><br><span class="line">  <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    editorOpen(argv[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;HELP: Ctrl-S = save | Ctrl-Q = quit&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/save-status-message" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>strerror()</code> 来自 <code>&lt;string.h&gt;</code>。</p>
<p><code>strerror()</code> 和 我们在 <code>die()</code> 中用的 <code>perror()</code>一样，但是它使用 <code>errno</code> 值作为参数并返回该错误代码的可读字符串；所以，我们可以使这个字符串成为错误消息的一部分来展示给用户。</p>
<p>上面的代码实际上并不能编译，因为我们试图在定义 <code>editorSetStatusMessage()</code> 之前先调用它 。您无法在C中做到这一点，因为C是一种可以通过 <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/One-pass_compiler" >single pass<i class="fas fa-external-link-alt"></i></a> 就可以编译的语言，这意味着对于程序的每个部分，而无需知道程序后面的内容就可以编译。</p>
<p>当我们用C调用函数时，编译器需要知道该函数的参数和返回值。我们可以通过在文件顶部附近声明一个函数原型来告诉编译器有关 <code>editorSetStatusMessage()</code> 的信息。这使我们可以在定义函数之前调用它。我们将添加一个新的 <code>/*** prototypes ***/</code> 部分，并将声明放在其下。</p>
<h3 id="Step-110"><a href="#Step-110" class="headerlink" title="Step 110"></a>Step 110</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/prototypes" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<br>
<br>

<h2 id="Dirty-flag-脏标志"><a href="#Dirty-flag-脏标志" class="headerlink" title="Dirty flag 脏标志"></a>Dirty flag 脏标志</h2><p>我们持续跟踪编辑器中加载的文本与文件中的文本是否不同。然后，当他们尝试退出时，我们可以警告用户他们可能会丢失未保存的更改。</p>
<p>如果自打开或保存文件以来对文本缓冲区进行了修改，我们将其称为“脏”。让我们向全局编辑器状态添加一个 <code>dirty</code> 变量，并将其初始化为0。</p>
<h3 id="Step-111"><a href="#Step-111" class="headerlink" title="Step 111"></a>Step 111</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rx;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> coloff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="keyword">int</span> dirty;</span><br><span class="line">  <span class="keyword">char</span> *filename;</span><br><span class="line">  <span class="keyword">char</span> statusmsg[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">time_t</span> statusmsg_time;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line">  E.dirty = <span class="number">0</span>;</span><br><span class="line">  E.filename = <span class="literal">NULL</span>;</span><br><span class="line">  E.statusmsg[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.statusmsg_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">  E.screenrows -= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/dirty" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>让我们在状态栏中显示 <code>E.dirty</code> 的状态，在文件被修改后显示（<code>modified</code>）。</p>
<h3 id="Step-112"><a href="#Step-112" class="headerlink" title="Step 112"></a>Step 112</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">char</span> status[<span class="number">80</span>], rstatus[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(status, <span class="keyword">sizeof</span>(status), <span class="string">&quot;%.20s - %d lines %s&quot;</span>,</span><br><span class="line">    E.filename ? E.filename : <span class="string">&quot;[No Name]&quot;</span>, E.numrows,</span><br><span class="line">    E.dirty ? <span class="string">&quot;(modified)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">int</span> rlen = <span class="built_in">snprintf</span>(rstatus, <span class="keyword">sizeof</span>(rstatus), <span class="string">&quot;%d/%d&quot;</span>,</span><br><span class="line">    E.cy + <span class="number">1</span>, E.numrows);</span><br><span class="line">  <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">  abAppend(ab, status, len);</span><br><span class="line">  <span class="keyword">while</span> (len &lt; E.screencols) &#123;</span><br><span class="line">    <span class="keyword">if</span> (E.screencols - len == rlen) &#123;</span><br><span class="line">      abAppend(ab, rstatus, rlen);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">      len++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/show-dirty" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，让我们对每行的每个操作，将 <code>E.dirty</code> 加一。</p>
<h3 id="Step-113"><a href="#Step-113" class="headerlink" title="Step 113"></a>Step 113</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> at = E.numrows;</span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line">  editorUpdateRow(&amp;E.row[at]);</span><br><span class="line"></span><br><span class="line">  E.numrows++;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt; row-&gt;size) at = row-&gt;size;</span><br><span class="line">  row-&gt;chars = <span class="built_in">realloc</span>(row-&gt;chars, row-&gt;size + <span class="number">2</span>);</span><br><span class="line">  memmove(&amp;row-&gt;chars[at + <span class="number">1</span>], &amp;row-&gt;chars[at], row-&gt;size - at + <span class="number">1</span>);</span><br><span class="line">  row-&gt;size++;</span><br><span class="line">  row-&gt;chars[at] = c;</span><br><span class="line">  editorUpdateRow(row);</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/increment-dirty" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们可以使用 <code>E.dirty = 1</code> 代替 <code>E.dirty++</code>，但是通过增加它，我们可以感觉到文件有多 “脏”，这可能很有用。 （在本教程中，我们仅将 <code>E.dirty</code> 视为布尔值，因此它并不重要。）</p>
<p>如果此时打开文件，您会发现在进行任何更改之前，立即会显示（<code>modified</code>）。这是因为 <code>editorOpen()</code> 调用 <code>editorAppendRow()</code> 会增加 <code>E.dirty</code>。要解决此问题，请在<code>editorOpen()</code> 末尾以及 <code>editorSave()</code> 中将 <code>E.dirty</code> 重置为 <code>0</code>。</p>
<h3 id="Step-114"><a href="#Step-114" class="headerlink" title="Step 114"></a>Step 114</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(E.filename);</span><br><span class="line">  E.filename = strdup(filename);</span><br><span class="line"></span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  <span class="keyword">while</span> ((linelen = getline(&amp;line, &amp;linecap, fp)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    editorAppendRow(line, linelen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  E.dirty = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len) != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(fd, buf, len) == len) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        E.dirty = <span class="number">0</span>;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;%d bytes written to disk&quot;</span>, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;Can&#x27;t save! I/O error: %s&quot;</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/reset-dirty" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，当您第一次插入字符时，您应该看到（<code>modified</code>）在状态栏中，当您将文件保存到磁盘时，您应该看到它消失了。<br><br><br><br></p>
<h2 id="Quit-confirmation-退出确认"><a href="#Quit-confirmation-退出确认" class="headerlink" title="Quit confirmation 退出确认"></a>Quit confirmation 退出确认</h2><p>现在，我们准备对用户尝试时未保存退出进行警告。如果设置了 <code>E.dirty</code>，我们将在状态栏中显示警告，并要求用户再按 <code>Ctrl-Q</code> 3次才能退出而不保存。</p>
<h3 id="Step-115"><a href="#Step-115" class="headerlink" title="Step 115"></a>Step 115</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> quit_times = KILO_QUIT_TIMES;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">      <span class="comment">/* TODO */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">if</span> <span class="params">(E.dirty &amp;&amp; quit_times &gt; <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;WARNING!!! File has unsaved changes. &quot;</span></span><br><span class="line">          <span class="string">&quot;Press Ctrl-Q %d more times to quit.&quot;</span>, quit_times);</span><br><span class="line">        quit_times--;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;s&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">editorSave</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BACKSPACE:</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;h&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="keyword">case</span> DEL_KEY:</span></span><br><span class="line"><span class="function">      <span class="comment">/* TODO */</span></span></span><br><span class="line"><span class="function">      <span class="keyword">break</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;l&#x27;</span>)</span>:</span></span><br><span class="line">    case &#x27;\x1b&#x27;:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      editorInsertChar(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  quit_times = KILO_QUIT_TIMES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/quit-confirmation" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们在 <code>editorProcessKeypress()</code> 中使用静态变量来跟踪用户按 <code>Ctrl-Q</code> 退出的次数。每次用按 <code>Ctrl-Q</code> 键进行未保存退出时，我们都会设置状态消息并减少 <code>quit_times</code>。当 <code>quit_times</code> 变为 <code>0</code> 时，允许程序退出。当他们按下 <code>Ctrl-Q</code> 以外的任何其他键时，<code>quit_times</code> 会在 <code>editorProcessKeypress()</code> 函数的末尾重置为 <code>3</code>。<br><br><br><br></p>
<h2 id="Simple-backspacing-简单退格"><a href="#Simple-backspacing-简单退格" class="headerlink" title="Simple backspacing 简单退格"></a>Simple backspacing 简单退格</h2><p>让我们接下来实现退格。我们先建一个 <code>editorRowDelChar()</code> 函数，用来在一行里删除一个字符。</p>
<h3 id="Step-116"><a href="#Step-116" class="headerlink" title="Step 116"></a>Step 116</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt;= row-&gt;size) <span class="keyword">return</span>;</span><br><span class="line">  memmove(&amp;row-&gt;chars[at], &amp;row-&gt;chars[at + <span class="number">1</span>], row-&gt;size - at);</span><br><span class="line">  row-&gt;size--;</span><br><span class="line">  editorUpdateRow(row);</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/row-del-char" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如您所见，除了我们不需要内存管理外，它与 <code>editorRowInsertChar()</code> 非常相似。我们只使用<code>memmove()</code> 用后面的字符覆盖已删除的字符（注意，结尾处的字节 <code>&#39;\0&#39;</code> 已包含在移动的字符串中）。然后，我们减小行的 <code>size</code>，调用 <code>editorUpdateRow()</code> 更新，最后增加 <code>E.dirty</code>。</p>
<p>现在，我们来实现 <code>editorDelChar()</code>，它使用 <code>editorRowDelChar</code> 删除光标左侧的字符。</p>
<h3 id="Step-117"><a href="#Step-117" class="headerlink" title="Step 117"></a>Step 117</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertChar</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cy == E.numrows) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  erow *row = &amp;E.row[E.cy];</span><br><span class="line">  <span class="keyword">if</span> (E.cx &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    editorRowDelChar(row, E.cx - <span class="number">1</span>);</span><br><span class="line">    E.cx--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-del-char" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果光标在文件末尾，则没有要删除的内容，我们会立即 <code>return</code>。否则，我们可以获得光标所在 <code>erow</code>，如果光标左侧有一个字符，则将其删除，然后将光标向左移动一个。</p>
<p>让我们将 <code>Backspace</code>，<code>Ctrl-H</code> 和 <code>Delete</code> 键映射到 <code>editorDelChar()</code>。</p>
<h3 id="Step-118"><a href="#Step-118" class="headerlink" title="Step 118"></a>Step 118</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> quit_times = KILO_QUIT_TIMES;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">      <span class="comment">/* TODO */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">if</span> <span class="params">(E.dirty &amp;&amp; quit_times &gt; <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;WARNING!!! File has unsaved changes. &quot;</span></span><br><span class="line">          <span class="string">&quot;Press Ctrl-Q %d more times to quit.&quot;</span>, quit_times);</span><br><span class="line">        quit_times--;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;s&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">editorSave</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BACKSPACE:</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;h&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="keyword">case</span> DEL_KEY:</span></span><br><span class="line"><span class="function">      <span class="title">if</span> <span class="params">(c == DEL_KEY)</span> <span class="title">editorMoveCursor</span><span class="params">(ARROW_RIGHT)</span></span>;</span><br><span class="line">      editorDelChar();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;l&#x27;</span>)</span>:</span></span><br><span class="line">    case &#x27;\x1b&#x27;:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      editorInsertChar(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  quit_times = KILO_QUIT_TIMES;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/key-del-char" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在我们的编辑器中，先按 <code>→</code> 键，然后按 <code>Backspace</code> 键，等效于在文本编辑器中按 <code>Delete</code> 键所期望的效果：它将删除光标右边的字符。这就是我们实现上述 <code>Delete</code> 键的方式。<br><br><br><br></p>
<h2 id="Backspacing-at-the-start-of-a-line-行首退格"><a href="#Backspacing-at-the-start-of-a-line-行首退格" class="headerlink" title="Backspacing at the start of a line 行首退格"></a>Backspacing at the start of a line 行首退格</h2><p>当前，当光标位于行首时，<code>editorDelChar()</code> 不会执行任何操作。当用户在行首退格时，我们希望将该行的内容附加到前一行，然后删除当前行。这个操作在两行之间删除了隐藏字符 <code>\n</code>，并将它们合并为一行。</p>
<p>因此，我们需要两个新的行操作：一个用于将字符串追加到行，另一个用于删除行。让我们从实现<code>editorDelRow()</code> 开始，它需要一个 <code>editorFreeRow()</code> 函数来释放要删除的 <code>erow</code> 所拥有的内存。</p>
<h3 id="Step-119"><a href="#Step-119" class="headerlink" title="Step 119"></a>Step 119</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(row-&gt;render);</span><br><span class="line">  <span class="built_in">free</span>(row-&gt;chars);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt;= E.numrows) <span class="keyword">return</span>;</span><br><span class="line">  editorFreeRow(&amp;E.row[at]);</span><br><span class="line">  memmove(&amp;E.row[at], &amp;E.row[at + <span class="number">1</span>], <span class="keyword">sizeof</span>(erow) * (E.numrows - at - <span class="number">1</span>));</span><br><span class="line">  E.numrows--;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/del-row" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>editorDelRow()</code> 看起来非常类似于 <code>editorRowDelChar()</code>，因为在两种情况下，我们都通过其索引从元素数组中删除单个元素。</p>
<p>首先，我们验证 <code>at</code> 索引。然后，使用 <code>editorFreeRow()</code> 释放该行所拥有的内存。然后，我们使用 <code>memmove()</code> 用后面的其余行覆盖已删除的行，并减少行数。最后，我们增加 <code>E.dirty</code>。</p>
<p>现在，让我们实现 <code>editorRowAppendString()</code>，它将一个字符串附加到一行的末尾。</p>
<h3 id="Step-120"><a href="#Step-120" class="headerlink" title="Step 120"></a>Step 120</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowAppendString</span><span class="params">(erow *row, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  row-&gt;chars = <span class="built_in">realloc</span>(row-&gt;chars, row-&gt;size + len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;row-&gt;chars[row-&gt;size], s, len);</span><br><span class="line">  row-&gt;size += len;</span><br><span class="line">  row-&gt;chars[row-&gt;size] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  editorUpdateRow(row);</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/row-append-string" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>该行的新大小为 <code>row-&gt; size + len + 1</code>（包括空字节），因此，我们首先为 <code>row-&gt;chars</code> 分配那么多的内存。然后我们简单地将给定的字符串用 <code>memcpy()</code> 移至 <code>row-&gt;chars</code> 内容的末尾, 更新 <code>row-&gt; size</code>，正常调用 <code>editorUpdateRow()</code>，增加 <code>E.dirty</code>。</p>
<p>现在，我们准备好使用 <code>editorDelChar()</code> 处理光标在行首的情况。</p>
<h3 id="Step-121"><a href="#Step-121" class="headerlink" title="Step 121"></a>Step 121</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertChar</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cy == E.numrows) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.cx == <span class="number">0</span> &amp;&amp; E.cy == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">  erow *row = &amp;E.row[E.cy];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.cx &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    editorRowDelChar(row, E.cx - <span class="number">1</span>);</span><br><span class="line">    E.cx--;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    E.cx = E.row[E.cy - <span class="number">1</span>].size;</span><br><span class="line">    editorRowAppendString(&amp;E.row[E.cy - <span class="number">1</span>], row-&gt;chars, row-&gt;size);</span><br><span class="line">    editorDelRow(E.cy);</span><br><span class="line">    E.cy--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/del-char-row" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果光标位于第一行的开头，则没有任何事可做，因此我们立即返回。否则，如果发现 <code>E.cx == 0</code>，则按我们的计划调用 <code>editorRowAppendString()</code>，然后调用 <code>editorDelRow()</code>。<code>row</code> 指向我们要删除的行，因此我们将 <code>row-&gt;chars</code> 追加到上一行，然后删除 <code>E.cy</code> 所在的行。我们将 <code>E.cx</code>设置为上一行未追加内容的末尾。这样，光标将结束于两条线的连接点。</p>
<p>请注意，行的结尾按 <code>Delete</code> 键与用户预期一致，将当前行与下一行连接在一起。这是因为将光标移动到行尾的右侧，会将其移动到下一行的开头。因此，使 <code>Delete</code> 键成为 <code>→ + Backspace</code>的别名。</p>
<br>
<br>

<h2 id="The-Enter-key-回车键"><a href="#The-Enter-key-回车键" class="headerlink" title="The Enter key 回车键"></a>The <code>Enter</code> key 回车键</h2><p>我们要实现的最后一个编辑器操作是 <code>Enter</code> 键。 <code>Enter</code> 键允许用户在文本中插入新行，或将一行拆分为两行。我们需要做的第一件事是将 <code>editorAppendRow(...)</code> 函数重命名为<code>editorInsertRow(int at，...)</code>。现在它将能够在新 <code>at</code> 参数指定的索引处插入一行。</p>
<h3 id="Step-122"><a href="#Step-122" class="headerlink" title="Step 122"></a>Step 122</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertRow</span><span class="params">(<span class="keyword">int</span> at, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt; E.numrows) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line">  memmove(&amp;E.row[at + <span class="number">1</span>], &amp;E.row[at], <span class="keyword">sizeof</span>(erow) * (E.numrows - at));</span><br><span class="line">  </span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line">  editorUpdateRow(&amp;E.row[at]);</span><br><span class="line"></span><br><span class="line">  E.numrows++;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowAppendString</span><span class="params">(erow *row, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/append-to-insert" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>就像 <code>editorRowInsertChar()</code> 一样，我们首先对 <code>at</code> 进行验证，然后为 <code>erow</code> 分配内存，然后使用 <code>memmove()</code> 在新行的指定索引处腾出空间。</p>
<p>我们还将删除旧行 <code>int at = ...</code>，因为 <code>at</code> 现在作为参数传递进来了。</p>
<p>现在，我们必须将对 <code>editorAppendRow(...)</code> 的所有调用替换为对 <code>editorInsertRow(E.numrows, ...)</code> 的调用。</p>
<h3 id="Step-123"><a href="#Step-123" class="headerlink" title="Step 123"></a>Step 123</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertChar</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cy == E.numrows) &#123;</span><br><span class="line">    editorInsertRow(E.numrows, <span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  editorRowInsertChar(&amp;E.row[E.cy], E.cx, c);</span><br><span class="line">  E.cx++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelChar</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(E.filename);</span><br><span class="line">  E.filename = strdup(filename);</span><br><span class="line"></span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  <span class="keyword">while</span> ((linelen = getline(&amp;line, &amp;linecap, fp)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    editorInsertRow(E.numrows, line, linelen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  E.dirty = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-insert-row" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在我们有了 <code>editorInsertRow()</code>，我们可以开始实现 <code>editorInsertNewline()</code> 了，它可以处理 <code>Enter</code> 键。</p>
<h3 id="Step-124"><a href="#Step-124" class="headerlink" title="Step 124"></a>Step 124</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertChar</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertNewline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cx == <span class="number">0</span>) &#123;</span><br><span class="line">    editorInsertRow(E.cy, <span class="string">&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    erow *row = &amp;E.row[E.cy];</span><br><span class="line">    editorInsertRow(E.cy + <span class="number">1</span>, &amp;row-&gt;chars[E.cx], row-&gt;size - E.cx);</span><br><span class="line">    row = &amp;E.row[E.cy];</span><br><span class="line">    row-&gt;size = E.cx;</span><br><span class="line">    row-&gt;chars[row-&gt;size] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    editorUpdateRow(row);</span><br><span class="line">  &#125;</span><br><span class="line">  E.cy++;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelChar</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/insert-newline" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果我们在一行的开头，我们所要做的就是在我们所在的行之前插入一个新的空白行。</p>
<p>否则，我们必须将当前行分成两行。首先，我们调用e <code>ditorInsertRow()</code> 并将当前行右边光标处的字符传递给它。这将在当前行之后创建一个具有正确内容的新行。然后，我们重新分配 <code>row</code> 指针，因为<code>editorInsertRow()</code> 调用 <code>realloc()</code>，这可能会在我们周围移动内存并使指针无效（类似）。然后，通过将当前行的大小设置为光标的位置来截断当前行的内容，并在被截断的行上调用<code>editorUpdateRow()</code>。 （ <code>editorInsertRow()</code> 已为新行调用 <code>editorUpdateRow()</code>。）</p>
<p>在这两种情况下，我们都将 <code>E.cy</code> 递增，并将 <code>E.cx</code> 设置为 <code>0</code>，以将光标移动到行的开头。</p>
<p>最后，让我们实际将 <code>Enter</code> 键映射到 <code>editorInsertNewline()</code> 操作。</p>
<h3 id="Step-125"><a href="#Step-125" class="headerlink" title="Step 125"></a>Step 125</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> quit_times = KILO_QUIT_TIMES;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">      editorInsertNewline();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">if</span> <span class="params">(E.dirty &amp;&amp; quit_times &gt; <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;WARNING!!! File has unsaved changes. &quot;</span></span><br><span class="line">          <span class="string">&quot;Press Ctrl-Q %d more times to quit.&quot;</span>, quit_times);</span><br><span class="line">        quit_times--;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;s&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">editorSave</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BACKSPACE:</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;h&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="keyword">case</span> DEL_KEY:</span></span><br><span class="line"><span class="function">      <span class="title">if</span> <span class="params">(c == DEL_KEY)</span> <span class="title">editorMoveCursor</span><span class="params">(ARROW_RIGHT)</span></span>;</span><br><span class="line">      editorDelChar();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;l&#x27;</span>)</span>:</span></span><br><span class="line">    case &#x27;\x1b&#x27;:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      editorInsertChar(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  quit_times = KILO_QUIT_TIMES;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/enter-key" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>至此，我们将要实现的所有文本编辑操作均已完成。如果你愿意，并且敢的化，现在就对接下来的教程，用此编辑器修改其源代码。如果你真的这样做了，我建议定期备份您的工作内容（使用 <code>git</code> 或类似管理工具），以防您在编辑器中发现bug。<br><br><br><br></p>
<h2 id="Save-as…-另存为"><a href="#Save-as…-另存为" class="headerlink" title="Save as… 另存为"></a>Save as… 另存为</h2><p>当前，当用户运行不带任何参数的  <code>./kilo</code> 时，他们将获得一个空白文件进行编辑，但无法保存。我们需要在保存新文件时提示用户输入文件名。让我们创建一个 <code>editorPrompt()</code> 函数，该函数在状态栏中显示提示，并让用户在提示后输入一行文本。</p>
<h3 id="Step-126"><a href="#Step-126" class="headerlink" title="Step 126"></a>Step 126</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorPrompt</span><span class="params">(<span class="keyword">char</span> *prompt)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> bufsize = <span class="number">128</span>;</span><br><span class="line">  <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(bufsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line">  buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorSetStatusMessage(prompt, buf);</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen != <span class="number">0</span>) &#123;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">iscntrl</span>(c) &amp;&amp; c &lt; <span class="number">128</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen == bufsize - <span class="number">1</span>) &#123;</span><br><span class="line">        bufsize *= <span class="number">2</span>;</span><br><span class="line">        buf = <span class="built_in">realloc</span>(buf, bufsize);</span><br><span class="line">      &#125;</span><br><span class="line">      buf[buflen++] = c;</span><br><span class="line">      buf[buflen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/prompt" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>用户的输入存储在 <code>buf</code> 中，这是一个动态分配的字符串，我们将其初始化为空字符串。然后，我们进入无限循环，该循环反复设置状态消息，刷新屏幕并等待按键处理。<code>prompt</code> 应为包含 <code>％s</code> 的格式字符串，该字符串将显示用户的输入。</p>
<p>当用户按下 <code>Enter</code> 键并且他们的输入不为空时，状态消息将被清除并返回他们的输入。否则，当他们输入可打印字符时，我们会将其附加到 <code>buf</code>。如果 <code>buflen</code> 达到了我们分配的最大容量（存储在<code>bufsize</code>中），则我们将 <code>bufsize</code> 加倍，重新分配内存 <code>buf</code> 之前分配的内存， 然后再追加字符。我们还确保 <code>buf</code> 以 <code>\0</code> 字符结尾，因为 <code>editorSetStatusMessage()</code> 和 <code>editorPrompt()</code> 的调用者都将使用它来知道何处是字符串的结尾。</p>
<p>请注意，我们必须确保输入键不是 <code>editorKey</code> 枚举中的特殊键之一，特殊键具有高整数值。为此，我们通过判断是否小于 <code>128</code> 来确认输入键是否在 <code>char</code> 范围内。</p>
<p>现在，当 <code>E.filename</code> 为 <code>NULL</code> 时，让我们在 <code>editorSave()</code> 提示用户输入文件名。</p>
<h3 id="Step-127"><a href="#Step-127" class="headerlink" title="Step 127"></a>Step 127</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorPrompt</span><span class="params">(<span class="keyword">char</span> *prompt)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    E.filename = editorPrompt(<span class="string">&quot;Save as: %s&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len) != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(fd, buf, len) == len) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        E.dirty = <span class="number">0</span>;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;%d bytes written to disk&quot;</span>, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;Can&#x27;t save! I/O error: %s&quot;</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/save-as" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>好的，我们现在具有基本的“另存为…”功能。接下来，让用户按下 <code>Escape</code> 键取消输入提示。</p>
<h3 id="Step-128"><a href="#Step-128" class="headerlink" title="Step 128"></a>Step 128</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorPrompt</span><span class="params">(<span class="keyword">char</span> *prompt)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> bufsize = <span class="number">128</span>;</span><br><span class="line">  <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(bufsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line">  buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorSetStatusMessage(prompt, buf);</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">      editorSetStatusMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="built_in">free</span>(buf);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen != <span class="number">0</span>) &#123;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">iscntrl</span>(c) &amp;&amp; c &lt; <span class="number">128</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen == bufsize - <span class="number">1</span>) &#123;</span><br><span class="line">        bufsize *= <span class="number">2</span>;</span><br><span class="line">        buf = <span class="built_in">realloc</span>(buf, bufsize);</span><br><span class="line">      &#125;</span><br><span class="line">      buf[buflen++] = c;</span><br><span class="line">      buf[buflen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/prompt-escape" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>当取消输入提示时，我们自己<code>free()</code> <code>buf</code> 并返回 <code>NULL</code>。因此，让我们中止保存操作并向用户显示“中止保存”消息，以便在 <code>editorSave()</code> 中处理 <code>NULL</code> 的返回值。</p>
<h3 id="Step-129"><a href="#Step-129" class="headerlink" title="Step 129"></a>Step 129</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    E.filename = editorPrompt(<span class="string">&quot;Save as: %s (ESC to cancel)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      editorSetStatusMessage(<span class="string">&quot;Save aborted&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len) != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(fd, buf, len) == len) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        E.dirty = <span class="number">0</span>;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;%d bytes written to disk&quot;</span>, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;Can&#x27;t save! I/O error: %s&quot;</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/abort-save" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>（注意：如果您使用的是 <strong>Bash on Windows</strong>，则必须按 <code>Escape</code> 3次才能获得一个<code>Escape</code>按键来注册到我们的程序中，因为 <code>editorReadKey()</code> 查找转义序列逻辑中 <code>read()</code> 来永远不会超时。 ）</p>
<p>现在，让我们允许用户在输入提示中按 <code>Backspace</code> 键（或 <code>Ctrl-H</code> 或<code>Delete</code>）。</p>
<h3 id="Step-130"><a href="#Step-130" class="headerlink" title="Step 130"></a>Step 130</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorPrompt</span><span class="params">(<span class="keyword">char</span> *prompt)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> bufsize = <span class="number">128</span>;</span><br><span class="line">  <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(bufsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> buflen = <span class="number">0</span>;</span><br><span class="line">  buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorSetStatusMessage(prompt, buf);</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line">    <span class="keyword">if</span> (c == DEL_KEY || c == CTRL_KEY(<span class="string">&#x27;h&#x27;</span>) || c == BACKSPACE) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen != <span class="number">0</span>) buf[--buflen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">      editorSetStatusMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="built_in">free</span>(buf);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen != <span class="number">0</span>) &#123;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">iscntrl</span>(c) &amp;&amp; c &lt; <span class="number">128</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buflen == bufsize - <span class="number">1</span>) &#123;</span><br><span class="line">        bufsize *= <span class="number">2</span>;</span><br><span class="line">        buf = <span class="built_in">realloc</span>(buf, bufsize);</span><br><span class="line">      &#125;</span><br><span class="line">      buf[buflen++] = c;</span><br><span class="line">      buf[buflen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/prompt-backspace" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在 <a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/06.search.html" >下一章<i class="fas fa-external-link-alt"></i></a> 中，我们将使用 <code>editorPrompt()</code> 在我们的编辑器中实现增量搜索功能。</p>

        </div>

        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/03/02/%E5%8D%83%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA%E4%B8%AA%E4%BA%BA%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%88%E5%9B%9B%EF%BC%89A-Text-Viewer/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">千行代码构建个人文本编辑器（四）A text viewer</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Ling</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.0</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>



<script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/dark-light-toggle.js"></script>







<div class="post-scripts">
    
</div>



</body>
</html>
