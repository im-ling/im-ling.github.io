<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Ling">
    
    <title>
        
            千行代码构建个人文本编辑器（四）A text viewer |
        
        Ling&#39;s blog
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="/images/l.svg">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#000000","avatar":"/images/avatar.png","favicon":"/images/l.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.0"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Ling&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">千行代码构建个人文本编辑器（四）A text viewer</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Ling</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-03-02 12:28:30
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/C/">C</a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/C/translation/">translation</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/translation/">translation</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/C/">C</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Fun/">Fun</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/">文本编辑器</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="A-text-viewer"><a href="#A-text-viewer" class="headerlink" title="A text viewer"></a>A text viewer</h1><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p><a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/04.aTextViewer.html" >原文链接<i class="fas fa-external-link-alt"></i></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<h2 id="A-line-viewer"><a href="#A-line-viewer" class="headerlink" title="A line viewer"></a>A line viewer</h2><p>让我们在编辑器中创建一种数据类型来存储一行文本。                                      </p>
<h3 id="Step-55"><a href="#Step-55" class="headerlink" title="Step 55"></a>Step 55</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">char</span> *chars;</span><br><span class="line">&#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow row;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/erow" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>erow</code> 代表 <code>编辑的行</code>，作为一个指针存储一行文本，指针指向一个数据结构，该结构记录着一个动态分配的字符串和其长度。这里我们使用了 <code>typedef</code>，我们可以将类型记做 <code>erow</code> 而不是 <code>struct erow</code>。</p>
<p>我们向编辑器的全局状态(数据结构)添加一个 <code>erow</code> 值，一个 <code>numrow</code> 变量。目前，编辑器仅显示一行文本，因此数字可以为 <code>0</code> 或 <code>1</code>。我们在 <code>initEditor()</code> 中将其初始化为 <code>0</code>。</p>
<p>现在让我们用一些文字填充一下 <code>eorw</code>。我们暂时考虑从文件中读取数据。我们先将“Hello，world”字符串硬编码到其中。</p>
<h3 id="Step-56"><a href="#Step-56" class="headerlink" title="Step 56"></a>Step 56</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *line = <span class="string">&quot;Hello, world!&quot;</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">  E.row.size = linelen;</span><br><span class="line">  E.row.chars = <span class="built_in">malloc</span>(linelen + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(E.row.chars, line, linelen);</span><br><span class="line">  E.row.chars[linelen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.numrows = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line">  initEditor();</span><br><span class="line">  editorOpen();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hello-world" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>malloc()</code> 来自 <code>&lt;stdlib.h&gt;</code>. <code>ssize_t</code> 来自 <code>&lt;sys/types.h&gt;</code>.</p>
<p><code>editorOpen()</code> 最终将用于从磁盘打开和读取文件，因此我们将其放在新的 <code>/*** 文件的I /O ***/</code> 部分中。要将“Hello，world”消息加载到编辑器的 <code>erow</code> 结构中，我们将 <code>size</code> 字段设置为消息的长度，用 <code>malloc()</code> 申请必要的内存，并用 <code>memcpy()</code> 将消息复制到 <code>chars</code> 中。最后，我们将 <code>E.numrows</code> 变量设置为 <code>1</code>，以指示该文本应在哪一行显示。</p>
<p>让我们现在来显示它。</p>
<h3 id="Step-57"><a href="#Step-57" class="headerlink" title="Step 57"></a>Step 57</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row.size;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, E.row.chars, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/draw-erow" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将前面的行绘制代码包在if语句中，该语句检查我们当前正在绘制的行是文本缓冲区（这里指hello，world文本）的一部分，还是在文本缓冲区的结尾之后的行。</p>
<p>要绘制一行属于文本缓冲区的行，我们只需写出 <code>erow</code> 的 `chars 字段即可。但是首先，我们先做一些截断处理，防止它超出了屏幕的边缘。</p>
<p>接下来，让用户打开一个实际文件。我们将阅读并显示文件的第一行。</p>
<h3 id="Step-58"><a href="#Step-58" class="headerlink" title="Step 58"></a>Step 58</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  linelen = getline(&amp;line, &amp;linecap, fp);</span><br><span class="line">  <span class="keyword">if</span> (linelen != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    E.row.size = linelen;</span><br><span class="line">    E.row.chars = <span class="built_in">malloc</span>(linelen + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(E.row.chars, line, linelen);</span><br><span class="line">    E.row.chars[linelen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    E.numrows = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line">  initEditor();</span><br><span class="line">  <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    editorOpen(argv[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/open-file" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>FILE</code>, <code>fopen()</code>, 和 <code>getline()</code> 均来自 <code>&lt;stdio.h&gt;</code>。</p>
<p><code>editorOpen()</code> 的核心不变，我们现在只是从 <code>getline()</code> 获取 <code>line</code> 和 <code>linelen</code> 值，而不是设定一个死值。</p>
<p><code>editorOpen()</code> 现在需要一个文件名参数，并使用<code>fopen()</code> 打开文件以进行读取。我们通过检查用户是否传入文件名参数，来允许用户选择要打开的文件。如果他们传递了文件名参数，我们将调用 <code>editorOpen()</code> 函数，并传递给函数以文件名。如果用户不带参数运行 <code>./kilo</code>，则不会调用 <code>editorOpen()</code> ，程序将从空白文件开始。</p>
<p>当我们读取文件，不知道为每行分配多少内存时，<code>getline()</code> 很有用。它为您管理内存。首先，我们为它传递一个空 <code>line</code> 指针，一个为 <code>0</code> 的 <code>linecap</code>（行容量）。这使得它为读取的下一行分配新的内存，并将 <code>line</code> 指向该内存，并设置 <code>linecap</code> 以让您知道它分配了多少内存。它的返回值是读取的行的长度，如果在文件末尾，并且没有更多的行可读取时，返回 <code>-1</code>。之后的内容，当 <code>editorOpen()</code> 读取文件的多行时，我们将反复将新的 <code>line</code> 和<code>linecap</code> 值传到到 <code>getline()</code> 中；并且尝试重用它，只要该 <code>line</code> 指向的内存的 <code>linecap</code> 足够大，可以容纳它读取的下一行。现在，我们只读取一行到 <code>E.row.chars</code> 中，然后对 <code>getline()</code> 分配的 <code>line</code> 进行 <code>free()</code>。</p>
<p>我们还将在行末删除换行符或回车符，然后再将其复制到行中。因为我们知道每行代表一行文本，因此在每行末尾存储换行符是没有用的。</p>
<p>如果您的编译器对 <code>getline()</code> 报警告，则可能需要定义一个 <a class="link"   target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Feature-Test-Macros.html" >feature test macro<i class="fas fa-external-link-alt"></i></a>。即使没有报警告，且可以正常编译，也请添加它们以使我们的代码更具可移植性。</p>
<h3 id="Step-59"><a href="#Step-59" class="headerlink" title="Step 59"></a>Step 59</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DEFAULT_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BSD_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/feature-test-macros" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将它们添加到 <code>includes</code> 的上方，因为包含的头文件会使用宏来决定要公开的功能。</p>
<p>现在，让我们快速修复一个错误。我们希望欢迎消息仅在用户不带参数的情况下启动程序时显示，而不在用户打开文件时显示，因为欢迎消息可能会妨碍显示文件。</p>
<h3 id="Step-60"><a href="#Step-60" class="headerlink" title="Step 60"></a>Step 60</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row.size;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, E.row.chars, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hide-welcome" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，仅在文本缓冲区完全为空时才显示欢迎消息。</p>
<br>
<br>

<h2 id="Multiple-lines-多行"><a href="#Multiple-lines-多行" class="headerlink" title="Multiple lines 多行"></a>Multiple lines 多行</h2><p>要存储多行，让我们将 <code>E.row</code> 变成一个 <code>erow</code> 的数组。这将是一个动态分配的数组，因此我们将其设置为一个指向 <code>erow</code> 的指针，并将该指针初始化为 <code>NULL</code>。 （这将破坏我们之前的代码逻辑结构，因此该程序将无法在接下来的几步中进行编译。）</p>
<h3 id="Step-61"><a href="#Step-61" class="headerlink" title="Step 61"></a>Step 61</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/erow-array" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>接下来，将 <code>editorOpen()</code> 中初始化 <code>E.row</code> 的代码移到 <code>editorAppendRow()</code> 的新函数中。我们将其放在一个新的部分，<code>/*** row operations ***/</code> 中。</p>
<h3 id="Step-62"><a href="#Step-62" class="headerlink" title="Step 62"></a>Step 62</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  E.row.size = len;</span><br><span class="line">  E.row.chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row.chars, s, len);</span><br><span class="line">  E.row.chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.numrows = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  linelen = getline(&amp;line, &amp;linecap, fp);</span><br><span class="line">  <span class="keyword">if</span> (linelen != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    editorAppendRow(line, linelen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/append-row" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>注意，我们将 <code>line</code> 和 <code>linelen</code> 变量重命名为 <code>s</code> 和 <code>len</code>，它们现在是 <code>editorAppendRow()</code>的参数。</p>
<p>我们希望 <code>editorAppendRow()</code> 为新的 <code>erow</code> 分配空间，然后在 <code>E.row</code> 数组的末尾将给定的字符串复制到新的 <code>erow</code>。让我现在开始这么做吧。</p>
<h3 id="Step-63"><a href="#Step-63" class="headerlink" title="Step 63"></a>Step 63</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> at = E.numrows;</span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.numrows++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/fix-append-row" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们必须告诉 <code>realloc()</code> 我们要分配多少个字节，因此我们将每个 <code>erow</code> 占用的字节数（<code>sizeof(erow)</code>）乘以所需的行数。然后，将 <code>at</code> 设置为要初始化的新行的索引，并用 <code>E.row[at]</code> 替换每次出现的 <code>E.row</code>。最后，我们将 <code>E.numrows = 1</code> 更改为 <code>E.numrows++</code>。</p>
<p>接下来，让我们更新 <code>editorDrawRows()</code> 以在打印当前行时使用 <code>E.row [y]</code> 而不是 <code>E.row</code>。</p>
<h3 id="Step-64"><a href="#Step-64" class="headerlink" title="Step 64"></a>Step 64</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (y &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[y].size;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, E.row[y].chars, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/draw-multiple-erows" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，代码应该可以编译，但是仍然只从文件中读取一行。让我们在 <code>whileEditorOpen()</code> 中添加一个 <code>while</code> 循环，以将整个文件读入 <code>E.row</code>。</p>
<h3 id="Step-65"><a href="#Step-65" class="headerlink" title="Step 65"></a>Step 65</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  <span class="keyword">while</span> ((linelen = getline(&amp;line, &amp;linecap, fp)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    editorAppendRow(line, linelen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/read-multiple-lines" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>while</code> 循环之所以有效，是因为 <code>getline()</code> 到达文件末尾时将返回 <code>-1</code>，并且不再需要读取任何行。</p>
<p>现在，在运行 <code>./kilo kilo.c</code> 时，您应该看到屏幕上充满了文本行。</p>
<br>
<br>

<h2 id="Vertical-scrolling"><a href="#Vertical-scrolling" class="headerlink" title="Vertical scrolling"></a>Vertical scrolling</h2><p>接下来，我们希望使用户能够滚动浏览整个文件，而不是仅仅能够看到文件的前几行。让我们向全局编辑器状态添加一个 <code>rowoff</code>（row offset）变量，该变量将跟踪用户当前滚动到文件的哪一行。</p>
<h3 id="Step-66"><a href="#Step-66" class="headerlink" title="Step 66"></a>Step 66</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/rowoff" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将其初始化为 <code>0</code>，这意味着默认情况下我们将滚动到文件顶部。</p>
<p>现在，让 <code>editorDrawRows()</code> 根据 <code>rowoff</code> 的值显示文件的正确行范围。</p>
<h3 id="Step-67"><a href="#Step-67" class="headerlink" title="Step 67"></a>Step 67</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].size;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, E.row[filerow].chars, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/filerow" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>为了获得要在每个 <code>y</code> 位置显示的文件行，我们将 <code>E.rowoff</code> 添加到 <code>y</code> 位置。因此，我们定义了一个包含该值的新变量 <code>filerow</code>，并将其用作 <code>E.row</code> 的索引。</p>
<p>现在我们在哪里设置 <code>E.rowoff</code> 的值？我们的策略是检查光标是否已移至可见窗口之外，如果是，调整 <code>E.rowoff</code> 以使光标位于可见窗口内。我们将此逻辑放在一个名为<code>editorScroll()</code> 的函数中，并在刷新屏幕之前立即调用它。</p>
<h3 id="Step-68"><a href="#Step-68" class="headerlink" title="Step 68"></a>Step 68</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &lt; E.rowoff) &#123;</span><br><span class="line">    E.rowoff = E.cy;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &gt;= E.rowoff + E.screenrows) &#123;</span><br><span class="line">    E.rowoff = E.cy - E.screenrows + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  editorScroll();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, E.cy + <span class="number">1</span>, E.cx + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-scroll" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>第一个 <code>if</code> 语句检查光标是否在可见窗口上方，如果是，则向上滚动到光标所在的位置。第二个<code>if</code> 语句检查光标是否在可见窗口的底部，并且包含稍微复杂的算术，因为E.rowoff指的是屏幕顶部的内容，我们必须让 <code>E.screenrows</code> 知道屏幕底部是什么。</p>
<p>现在，让光标移至屏幕底部（不是文件底部）。</p>
<h3 id="Step-69"><a href="#Step-69" class="headerlink" title="Step 69"></a>Step 69</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != E.screencols - <span class="number">1</span>) &#123;</span><br><span class="line">        E.cx++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/enable-vertical-scroll" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>运行 <code>./kilo  kilo.c</code> 时，您现在应该可以滚动浏览整个文件。 （如果文件包含制表符(<code>tab</code>)，则在绘制到屏幕上时，您会看到制表符所占用的字符没有被正确擦除。我们一会儿就要解决这个问题。此时使用该程序，请选择一个没有那么多制表符的文件。）</p>
<p>如果您尝试向上滚动，则可能会注意到光标位置不正确。这是因为E.cy不再指光标在屏幕上的位置。它指的是光标在文本文件中的位置。为了将光标定位在屏幕上，我们现在必须从 <code>E.cy</code> 的值中减去 <code>E.rowoff</code>。</p>
<h3 id="Step-70"><a href="#Step-70" class="headerlink" title="Step 70"></a>Step 70</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  editorScroll();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, (E.cy - E.rowoff) + <span class="number">1</span>, E.cx + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/fix-cursor-scrolling" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<br>
<br>

<h2 id="Horizontal-scrolling-水平滚动"><a href="#Horizontal-scrolling-水平滚动" class="headerlink" title="Horizontal scrolling 水平滚动"></a>Horizontal scrolling 水平滚动</h2><p>现在让我们做水平滚动。我们将以与实现垂直滚动相同的方式来实现它。首先向全局编辑器状态添加coloff（column offset）变量。</p>
<h3 id="Step-71"><a href="#Step-71" class="headerlink" title="Step 71"></a>Step 71</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> coloff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/coloff" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>要以列偏移量显示每一行，我们将使用 <code>E.coloff</code> 作为所显示的每个 <code>erow</code> 的 <code>chars</code> 的索引，并从行的长度中减去偏移量左侧的字符数。</p>
<h3 id="Step-72"><a href="#Step-72" class="headerlink" title="Step 72"></a>Step 72</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].size - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, &amp;E.row[filerow].chars[E.coloff], len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-coloff" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>请注意，从长度中减去 <code>E.coloff</code> 时，<code>len</code> 现在可以为负数，这意味着用户水平滚动超过了行尾。在这种情况下，我们将 <code>len</code> 设置为 <code>0</code>，以便该行不显示任何内容。</p>
<p>现在，让我们更新 <code>editorScroll()</code> 以处理水平滚动。</p>
<h3 id="Step-73"><a href="#Step-73" class="headerlink" title="Step 73"></a>Step 73</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &lt; E.rowoff) &#123;</span><br><span class="line">    E.rowoff = E.cy;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &gt;= E.rowoff + E.screenrows) &#123;</span><br><span class="line">    E.rowoff = E.cy - E.screenrows + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.cx &lt; E.coloff) &#123;</span><br><span class="line">    E.coloff = E.cx;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.cx &gt;= E.coloff + E.screencols) &#123;</span><br><span class="line">    E.coloff = E.cx - E.screencols + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-scroll-horizontal" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如您所见，它与垂直滚动代码完全一致。我们只用 <code>E.cx</code> 替换 <code>E.cy</code> ，用 <code>E.coloff</code> 替换 <code>E.rowoff</code>，用 <code>E.screencols</code> 替换 <code>E.screenrows</code>。</p>
<p>现在，让我们允许用户滚动到屏幕的右边缘外。</p>
<h3 id="Step-74"><a href="#Step-74" class="headerlink" title="Step 74"></a>Step 74</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != E.screencols - <span class="number">1</span>) &#123;</span><br><span class="line">      E.cx++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/enable-horizontal-scroll" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>您应该能够确认现在可以进行水平滚动。</p>
<p>接下来，让我们固定光标的位置，就像我们在垂直滚动中所做的内容一样。</p>
<h3 id="Step-75"><a href="#Step-75" class="headerlink" title="Step 75"></a>Step 75</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  editorScroll();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, (E.cy - E.rowoff) + <span class="number">1</span>,</span><br><span class="line">                                            (E.cx - E.coloff) + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/fix-cursor-scrolling-horizontal" >源代码<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="Limit-scrolling-to-the-right-右边缘滚动限制"><a href="#Limit-scrolling-to-the-right-右边缘滚动限制" class="headerlink" title="Limit scrolling to the right 右边缘滚动限制"></a>Limit scrolling to the right 右边缘滚动限制</h2><p>现在，<code>E.cx</code> 和 <code>E.cy</code> 都指的是光标在文件中的位置，而不是它在屏幕上的位置。因此，我们接下来的目标是将 <code>E.cx</code> 和 <code>E.cy</code> 的值限制为仅指向文件中的有效位置。否则，用户可以将光标移至行的右侧，然后开始在此处插入文本，这没有什么意义。 （此规则的唯一例外是 <code>E.cx</code> 可以将一个字符指向行末尾，以便可以在该行末尾插入字符，而 <code>E.cy</code> 可以将文件末尾指向一个行，因此可以轻松添加文件末尾的新行。）</p>
<p>首先，我们先不允许用户滚动到当前行的末尾。</p>
<h3 id="Step-76"><a href="#Step-76" class="headerlink" title="Step 76"></a>Step 76</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  erow *row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (row &amp;&amp; E.cx &lt; row-&gt;size) &#123;</span><br><span class="line">        E.cx++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/scroll-limits" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>由于 <code>E.cy</code> 允许指向文件的最后一行之后的行，所以我们使用三元运算符来检查光标是否在实际的行上。如果是，则行变量将指向光标所在的行，并且在允许光标向右移动之前，我们将检查 <code>E.cx</code> 是否位于该行末尾的左侧。<br><br><br><br></p>
<h2 id="Snap-cursor-to-end-of-line-固定光标到行尾"><a href="#Snap-cursor-to-end-of-line-固定光标到行尾" class="headerlink" title="Snap cursor to end of line 固定光标到行尾"></a>Snap cursor to end of line 固定光标到行尾</h2><p>但是，用户仍然可以将光标移到行尾之后。他们可以通过将光标移至长行的末尾，然后将其向下移至较短的下一行来做到这一点。 <code>E.cx</code> 值将保持不变，并且光标将位于其现在所在行的末尾的右侧。</p>
<p>让我们将一些代码添加到 <code>editorMoveCursor()</code> 中，以纠正 <code>E.cx</code>。</p>
<h3 id="Step-77"><a href="#Step-77" class="headerlink" title="Step 77"></a>Step 77</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  erow *row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (row &amp;&amp; E.cx &lt; row-&gt;size) &#123;</span><br><span class="line">        E.cx++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line">  <span class="keyword">int</span> rowlen = row ? row-&gt;size : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.cx &gt; rowlen) &#123;</span><br><span class="line">    E.cx = rowlen;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/snap-cursor" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们必须再次设置 <code>row</code>，因为 <code>E.cy</code> 可能指向与之前不同的行。如果 <code>E.cx</code> 在该行末尾的右侧，则将 <code>E.cx</code> 设置在该行末尾。还要注意，我们将 <code>NULL</code> 行的长度设为 <code>0</code>，这和我们的目的一致。<br><br><br><br></p>
<h2 id="Moving-left-at-the-start-of-a-line-行首左移"><a href="#Moving-left-at-the-start-of-a-line-行首左移" class="headerlink" title="Moving left at the start of a line 行首左移"></a>Moving left at the start of a line 行首左移</h2><p>让我们允许用户在行首按 <code>←</code> 移到前一行的末尾。</p>
<h3 id="Step-78"><a href="#Step-78" class="headerlink" title="Step 78"></a>Step 78</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  erow *row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (E.cy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (row &amp;&amp; E.cx &lt; row-&gt;size) &#123;</span><br><span class="line">        E.cx++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line">  <span class="keyword">int</span> rowlen = row ? row-&gt;size : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.cx &gt; rowlen) &#123;</span><br><span class="line">    E.cx = rowlen;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/moving-left" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在使用上述操作上移之前，我们确保不在第一行。</p>
<br>
<br>

<h2 id="Moving-right-at-the-end-of-a-line-行尾右移"><a href="#Moving-right-at-the-end-of-a-line-行尾右移" class="headerlink" title="Moving right at the end of a line 行尾右移"></a>Moving right at the end of a line 行尾右移</h2><p>同样，我们允许用户在一行末尾按 <code>→</code> 转到下一行的开头。</p>
<h3 id="Step-79"><a href="#Step-79" class="headerlink" title="Step 79"></a>Step 79</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  erow *row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (E.cy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (row &amp;&amp; E.cx &lt; row-&gt;size) &#123;</span><br><span class="line">        E.cx++;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (row &amp;&amp; E.cx == row-&gt;size) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">        E.cx = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  row = (E.cy &gt;= E.numrows) ? <span class="literal">NULL</span> : &amp;E.row[E.cy];</span><br><span class="line">  <span class="keyword">int</span> rowlen = row ? row-&gt;size : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.cx &gt; rowlen) &#123;</span><br><span class="line">    E.cx = rowlen;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/moving-right" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>同样，允许行尾右移时，我们必须确保此时不在文件末尾。<br><br><br><br></p>
<h2 id="Rendering-tabs-渲染制表符"><a href="#Rendering-tabs-渲染制表符" class="headerlink" title="Rendering tabs 渲染制表符"></a>Rendering tabs 渲染制表符</h2><p>如果您尝试使用 <code>./kilo Makefile</code> 打开 <code>Makefile</code>，则会注意到 <code>Makefile</code> 第二行的制表符占用8列左右的宽度。制表符的长度取决于所使用的终端的设置。我们想知道每个制表符的长度，我们还希望控制渲染制表符，因此我们将在 <code>erow</code> 结构中添加第二个字符串，包含实际要在屏幕上绘制的真是字符。目前，我们仅在制表符上使用render，但是之后，它可以用于将不可打印的控制字符呈现为 <code>^</code> 加一个其他字符，例如 <code>Ctrl-A</code> 字符的 <code>^A</code> （这是一种在终端中显示控制字符常见的方式）。</p>
<p>您可能还注意到，当终端显示 <code>Makefile</code> 中的制表符时，它不会擦除该制表符内的的字符。制表符所做的只是将光标向前移动到下一个制表符停止符，类似于回车或换行符。这就是为什么我们希望将制表符显示为多个空格的另一个原因，因为空格会擦除以前存在的任何字符。</p>
<p>因此，让我们从向erow结构中添加 <code>render</code> 和 <code>rsize</code>（表明 <code>render</code> 内容的大小）开始，然后在 <code>editorAppendRow()</code> 中对其进行初始化，这也是构造和初始化新的 <code>erow</code> 的地方。</p>
<h3 id="Step-80"><a href="#Step-80" class="headerlink" title="Step 80"></a>Step 80</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">int</span> rsize;</span><br><span class="line">  <span class="keyword">char</span> *chars;</span><br><span class="line">  <span class="keyword">char</span> *render;</span><br><span class="line">&#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> at = E.numrows;</span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  E.numrows++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/render" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>接下来，让我们创建一个 <code>editorUpdateRow()</code> 函数，该函数使用尾部的 <code>chars</code> 字符串填充 <code>render</code> 字符串的内容。我们将从字符中复制每个字符以进行渲染。我们现在还不需要担心如何呈现标签。</p>
<h3 id="Step-81"><a href="#Step-81" class="headerlink" title="Step 81"></a>Step 81</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(row-&gt;render);</span><br><span class="line">  row-&gt;render = <span class="built_in">malloc</span>(row-&gt;size + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> j;</span><br><span class="line">  <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++) &#123;</span><br><span class="line">    row-&gt;render[idx++] = row-&gt;chars[j];</span><br><span class="line">  &#125;</span><br><span class="line">  row-&gt;render[idx] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  row-&gt;rsize = idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> at = E.numrows;</span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line">  editorUpdateRow(&amp;E.row[at]);</span><br><span class="line"></span><br><span class="line">  E.numrows++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-update-row" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在 <code>for</code> 循环之后，<code>idx</code> 表明从 <code>row-&gt;render</code> 拷贝的字符数，因此我们将其分配给<code>row-&gt;rsize</code>。</p>
<p>现在，当我们显示每一个 <code>row</code> 时，我们用 <code>render</code> 和 <code>rsize</code> 替换 <code>editerDrawRows()</code> 中的 <code>chars</code> 和 <code>size</code>。</p>
<h3 id="Step-82"><a href="#Step-82" class="headerlink" title="Step 82"></a>Step 82</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, &amp;E.row[filerow].render[E.coloff], len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-render" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，文本查看器正在显示渲染中的字符。让我们将代码添加到 <code>editorUpdateRow()</code> 中，将制表符显示为多个空格字符。</p>
<h3 id="Step-83"><a href="#Step-83" class="headerlink" title="Step 83"></a>Step 83</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> tabs = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> j;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++)</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>) tabs++;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(row-&gt;render);</span><br><span class="line">  row-&gt;render = <span class="built_in">malloc</span>(row-&gt;size + tabs*<span class="number">7</span> + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">      row-&gt;render[idx++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">      <span class="keyword">while</span> (idx % <span class="number">8</span> != <span class="number">0</span>) row-&gt;render[idx++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      row-&gt;render[idx++] = row-&gt;chars[j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  row-&gt;render[idx] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  row-&gt;rsize = idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/tabs" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>首先，我们遍历该行的 <code>chars</code> 并记录制表符个数，以便知道为 <code>render</code> 分配多少内存。每个制表符需的最大字符数为8。<code>row-&gt;size</code> 已为每个制表符计数 <code>1</code>，因此我们将制表符个数乘以7，然后加上 <code>row-&gt;size</code> 以获取改行需要的最大内存容量量。</p>
<p>分配内存后，我们修改 <code>for</code> 循环以检查当前字符是否为制表符。如果是，我们将添加一个空格（因为每个制表符必须将光标向前至少向前移动一列），然后添加空格，直到到达一个制表位，也就是说该列的索引可以被8整除。</p>
<p>在这一点上，我们应该使制表符的长度为一个常量。</p>
<h3 id="Step-84"><a href="#Step-84" class="headerlink" title="Step 84"></a>Step 84</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> tabs = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> j;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++)</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>) tabs++;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(row-&gt;render);</span><br><span class="line">  row-&gt;render = <span class="built_in">malloc</span>(row-&gt;size + tabs*(KILO_TAB_STOP - <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">      row-&gt;render[idx++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">      <span class="keyword">while</span> (idx % KILO_TAB_STOP != <span class="number">0</span>) row-&gt;render[idx++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      row-&gt;render[idx++] = row-&gt;chars[j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  row-&gt;render[idx] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  row-&gt;rsize = idx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/tab-stop" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>这样可以使代码更清晰，也可以使制表符长度更易被配置。<br><br><br><br></p>
<h2 id="Tabs-and-the-cursor-制表符和光标"><a href="#Tabs-and-the-cursor-制表符和光标" class="headerlink" title="Tabs and the cursor 制表符和光标"></a>Tabs and the cursor 制表符和光标</h2><p>光标当前与之间之间的交互效果不佳。当我们将光标放在屏幕上时，我们仍然假设每个字符仅占据屏幕上的一列。为了解决这个问题，我们引入一个新的水平坐标变量 <code>E.rx</code> 。<code>E.cx</code> 是到 <code>erows</code> 的 <code>chars</code> 的索引，但 <code>E.rx</code> 变量将是到 <code>render</code> 的索引。如果当前行上没有制表符，则 <code>E.rx</code> 将与 <code>E.cx</code> 相同。如果有制表符时，则 <code>E.rx</code> 大于 <code>E.cx</code> ，大的空间和 制表符个数有关。</p>
<p>首先将 <code>rx</code> 添加到全局状态结构，并将其初始化为 <code>0</code>。</p>
<h3 id="Step-85"><a href="#Step-85" class="headerlink" title="Step 85"></a>Step 85</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rx;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> coloff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/rx" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将在 <code>editorScroll()</code> 函数开始设置 <code>E.rx</code> 的值。我们将其设置为与 <code>E.cx</code> 相同。之后，我们将在 <code>editorScroll()</code> 中用 <code>E.rx</code> 替换所有 <code>E.cx</code> ，因为滚动时应该使用实际渲染到屏幕上的字符和光标的渲染位置。</p>
<h3 id="Step-86"><a href="#Step-86" class="headerlink" title="Step 86"></a>Step 86</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.rx = E.cx;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.cy &lt; E.rowoff) &#123;</span><br><span class="line">    E.rowoff = E.cy;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &gt;= E.rowoff + E.screenrows) &#123;</span><br><span class="line">    E.rowoff = E.cy - E.screenrows + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.rx &lt; E.coloff) &#123;</span><br><span class="line">    E.coloff = E.rx;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.rx &gt;= E.coloff + E.screencols) &#123;</span><br><span class="line">    E.coloff = E.rx - E.screencols + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/rx-scroll" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，在 <code>editorRefreshScreen()</code> 中将 <code>E.cx</code> 更改为<code>E.rx</code>，来设置光标位置。</p>
<h3 id="Step-87"><a href="#Step-87" class="headerlink" title="Step 87"></a>Step 87</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  editorScroll();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, (E.cy - E.rowoff) + <span class="number">1</span>,</span><br><span class="line">                                            (E.rx - E.coloff) + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-rx" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>剩下要做的就是在 <code>editorScroll()</code> 中计算正确的 <code>E.rx</code> 值。让我们创建一个<code>editorRowCxToRx()</code> 函数来将 <code>chars</code> 索引转换为 <code>render</code> 索引。我们需要遍历 <code>cx</code> 左侧的所有字符，并找出每个制表符占用了多少空格。</p>
<h3 id="Step-8"><a href="#Step-8" class="headerlink" title="Step 8"></a>Step 8</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> j;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; cx; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">      rx += (KILO_TAB_STOP - <span class="number">1</span>) - (rx % KILO_TAB_STOP);</span><br><span class="line">    rx++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorAppendRow</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/cx-to-rx" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>对于每个字符，如果是制表符，则使用 <code>rx ％ KILO_TAB_STOP</code> 找出最后一个制表位右边的几列，然后用 <code>KILO_TAB_STOP - 1</code> 减去这些列， 来找出我们左边的几列下一个制表位。我们将该结果加到 <code>rx</code> 上，使其位于下一个制表位的左侧，然后无条件的进行 <code>rx++</code> 使我们直接位于下一个制表位。请注意，即使我们当前字符是制表符，这也可以正常工作。</p>
<p>让我们在 <code>editorScroll()</code> 顶部调用 <code>editorRowCxToRx()</code>，以将 <code>E.rx</code> 设置为其适当的值。</p>
<h3 id="Step-89"><a href="#Step-89" class="headerlink" title="Step 89"></a>Step 89</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &lt; E.numrows) &#123;</span><br><span class="line">    E.rx = editorRowCxToRx(&amp;E.row[E.cy], E.cx);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.cy &lt; E.rowoff) &#123;</span><br><span class="line">    E.rowoff = E.cy;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.cy &gt;= E.rowoff + E.screenrows) &#123;</span><br><span class="line">    E.rowoff = E.cy - E.screenrows + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.rx &lt; E.coloff) &#123;</span><br><span class="line">    E.coloff = E.rx;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (E.rx &gt;= E.coloff + E.screencols) &#123;</span><br><span class="line">    E.coloff = E.rx - E.screencols + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/set-rx" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，您应该能够确认光标可以在包含制表符的行中正确移动。<br><br><br><br></p>
<h2 id="Scrolling-with-Page-Up-and-Page-Down-使用Page-Up-和-Page-Down-滚动"><a href="#Scrolling-with-Page-Up-and-Page-Down-使用Page-Up-和-Page-Down-滚动" class="headerlink" title="Scrolling with Page Up and Page Down  使用Page Up 和 Page Down 滚动"></a>Scrolling with <code>Page Up</code> and <code>Page Down</code>  使用<code>Page Up</code> 和 <code>Page Down</code> 滚动</h2><p>现在，我们能滚动了，让我们再把 <code>Page Up</code> 和 <code>Page Down</code> 实现一下。</p>
<h3 id="Step-90"><a href="#Step-90" class="headerlink" title="Step 90"></a>Step 90</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      E.cx = E.screencols - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/page-up-down" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>要向上或向下滚动页面，我们将光标定位在屏幕的顶部或底部，然后模拟按下整个屏幕高度次数的 ↑ 或 ↓ 键。然后让 <code>editorMoveCursor()</code> 处理在移动光标时需要完成的所有边界检查和光标固定。<br><br><br><br></p>
<h2 id="Move-to-the-end-of-the-line-with-End-使用-End-移动到行尾"><a href="#Move-to-the-end-of-the-line-with-End-使用-End-移动到行尾" class="headerlink" title="Move to the end of the line with End  使用 End 移动到行尾"></a>Move to the end of the line with <code>End</code>  使用 <code>End</code> 移动到行尾</h2><p>现在，让我们用 <code>End</code> 键将光标移动到当前行的末尾。 （自从我们使E.cx相对于文件而不是相对于屏幕，<code>Home</code> 键将光标移动到该行的开头。）</p>
<h3 id="Step-91"><a href="#Step-91" class="headerlink" title="Step 91"></a>Step 91</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      <span class="keyword">if</span> (E.cy &lt; E.numrows)</span><br><span class="line">        E.cx = E.row[E.cy].size;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == PAGE_UP) &#123;</span><br><span class="line">          E.cy = E.rowoff;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == PAGE_DOWN) &#123;</span><br><span class="line">          E.cy = E.rowoff + E.screenrows - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (E.cy &gt; E.numrows) E.cy = E.numrows;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/end-key" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>End</code> 键将光标移到当前行的末尾。如果没有当前行，则 <code>E.cx</code> 为 <code>0</code>，也就是无需执行任何操作。</p>
<br>
<br>

<h2 id="Status-bar"><a href="#Status-bar" class="headerlink" title="Status bar"></a>Status bar</h2><p>在最终进行文本编辑之前，我们要添加的最后一件事是状态栏。这将显示有用的信息，例如文件名，文件中的多少行以及您当前所在的行。稍后，我们将添加一个标记，告诉您自上次保存文件以来是否已对其进行修改，并且在实现语法高亮时还将显示文件类型。</p>
<p>首先，我们只需要在屏幕底部为单行状态栏腾出空间即可。</p>
<h3 id="Step-92"><a href="#Step-92" class="headerlink" title="Step 92"></a>Step 92</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      abAppend(ab, &amp;E.row[filerow].render[E.coloff], len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">  E.screenrows -= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/status-bar-make-room" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们减少 <code>E.screenrows</code>，以使e <code>ditorDrawRows()</code> 不会尝试在屏幕底部绘制一行文本。我们还让 <code>editorDrawRows()</code> 在绘制的最后一行之后打印换行符，因为状态栏现在是屏幕上的最后一行。</p>
<p>请注意，这两个更改后，我们的文本查看器应该还是可以很好地工作的，包括滚动和光标移动，除保留最后一行为状态栏外，其余的将显示代码。</p>
<p>为了使状态栏脱颖而出，我们将其以反色显示：白色背景上的黑色文本。转义序列 <code>&lt;esc&gt;[7m</code> 切换为反色，而 <code>&lt;esc&gt;[m</code> 切换回普通格式。让我们绘制一个空白的白色状态栏，其中包含空格字符。</p>
<h3 id="Step-93"><a href="#Step-93" class="headerlink" title="Step 93"></a>Step 93</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (len &lt; E.screencols) &#123;</span><br><span class="line">    abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">    len++;</span><br><span class="line">  &#125;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  editorScroll();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line">  editorDrawStatusBar(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, (E.cy - E.rowoff) + <span class="number">1</span>,</span><br><span class="line">                                            (E.rx - E.coloff) + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/blank-status-bar" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>m</code> 命令（<a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt100-ug/chapter3.html#SGR" >Select Graphic Rendition<i class="fas fa-external-link-alt"></i></a>）使打印后的文本具有各种属性，包括粗体（<code>1</code>），下划线（<code>4</code>），闪烁（<code>5</code>）和反色（<code>7</code>）。例如，您可以使用命令 <code>&lt;esc&gt;[1;4;5;7m</code> 指定所有这些属性。参数 <code>0</code> 清除所有属性，是默认参数，因此我们使用 <code>&lt;esc&gt;[m</code> 返回普通文本格式。</p>
<p>因为我们要在状态栏中显示文件名，所以我们将文件名字符串添加到全局编辑器状态，并在打开文件时在其中保存文件名的副本。</p>
<h3 id="Step-94"><a href="#Step-94" class="headerlink" title="Step 94"></a>Step 94</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rx;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> coloff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="keyword">char</span> *filename;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(E.filename);</span><br><span class="line">  E.filename = strdup(filename);</span><br><span class="line"></span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  <span class="keyword">while</span> ((linelen = getline(&amp;line, &amp;linecap, fp)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    editorAppendRow(line, linelen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line">  E.filename = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">  E.screenrows -= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/filename" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>strdup()</code> 来自 <code>&lt;string.h&gt;</code>。它会根据给定的字符串，分配所需的内存并复制它，它会假设您将 <code>free()</code> 该内存。</p>
<p>我们将 <code>E.filename</code> 初始化为 <code>NULL</code> 指针，如果未打开文件，它将保持 <code>NULL</code>（在没有参数的情况下运行程序时会发生这种情况）。</p>
<p>现在，我们准备在状态栏中显示一些信息。我们显示一个最多20个字符的文件名，紧跟其后的是文件中的行数。如果没有文件名，我们将显示 <code>[No Name]</code>。</p>
<h3 id="Step-95"><a href="#Step-95" class="headerlink" title="Step 95"></a>Step 95</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">char</span> status[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(status, <span class="keyword">sizeof</span>(status), <span class="string">&quot;%.20s - %d lines&quot;</span>,</span><br><span class="line">    E.filename ? E.filename : <span class="string">&quot;[No Name]&quot;</span>, E.numrows);</span><br><span class="line">  <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">  abAppend(ab, status, len);</span><br><span class="line">  <span class="keyword">while</span> (len &lt; E.screencols) &#123;</span><br><span class="line">    abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">    len++;</span><br><span class="line">  &#125;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/status-bar-left" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们确保将状态字符串切短，以防超出窗口宽度。请注意，我们仍然如何使用在屏幕末端绘制空格的代码，从而使整个状态栏具有白色背景。</p>
<p>现在，让我们显示当前行号，并将其与屏幕的右边缘对齐。</p>
<h3 id="Step-96"><a href="#Step-96" class="headerlink" title="Step 96"></a>Step 96</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">char</span> status[<span class="number">80</span>], rstatus[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(status, <span class="keyword">sizeof</span>(status), <span class="string">&quot;%.20s - %d lines&quot;</span>,</span><br><span class="line">    E.filename ? E.filename : <span class="string">&quot;[No Name]&quot;</span>, E.numrows);</span><br><span class="line">  <span class="keyword">int</span> rlen = <span class="built_in">snprintf</span>(rstatus, <span class="keyword">sizeof</span>(rstatus), <span class="string">&quot;%d/%d&quot;</span>,</span><br><span class="line">    E.cy + <span class="number">1</span>, E.numrows);</span><br><span class="line">  <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">  abAppend(ab, status, len);</span><br><span class="line">  <span class="keyword">while</span> (len &lt; E.screencols) &#123;</span><br><span class="line">    <span class="keyword">if</span> (E.screencols - len == rlen) &#123;</span><br><span class="line">      abAppend(ab, rstatus, rlen);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">      len++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/status-bar-right" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>当前行存储在 <code>E.cy</code> 中，由于 <code>E.cy</code> 的索引为 <code>0</code>，因此我们将其加 <code>1</code>。在打印第一个状态栏字符串之后，我们要保留打印空间，直到到达 要打印第二个状态栏字符串的位置 为止，因为第二个状态栏字符串应紧靠屏幕的右边缘。当 <code>E.screencols-len</code> 等于第二个状态字符串的长度时，就是我们要的状态。此时，我们打印第二个状态栏字符串，打印完第二个状态栏字符串后，我们实际已经打印了整个状态栏，然后我们就可以退出循环。<br><br><br><br></p>
<h2 id="Status-message-状态信息"><a href="#Status-message-状态信息" class="headerlink" title="Status message 状态信息"></a>Status message 状态信息</h2><p>我们将在状态栏下方再添加一行。这行将用于向用户显示消息，并在进行搜索时提示用户输入信息。我们将当前信息存储在名为 <code>statusmsg</code> 的字符串中，并将其置于全局编辑器状态中。我们还将存储一个信息的时间戳，以便在显示信息几秒钟后将其删除。</p>
<h3 id="Step-97"><a href="#Step-97" class="headerlink" title="Step 97"></a>Step 97</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DEFAULT_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BSD_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rx;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> coloff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="keyword">char</span> *filename;</span><br><span class="line">  <span class="keyword">char</span> statusmsg[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">time_t</span> statusmsg_time;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line">  E.filename = <span class="literal">NULL</span>;</span><br><span class="line">  E.statusmsg[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.statusmsg_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">  E.screenrows -= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/status-message" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>time_t</code> 来自 <code>&lt;time.h&gt;</code>。</p>
<p>我们将 <code>E.statusmsg</code> 初始化为空字符串，因此默认情况下不会显示任何消息。设置状态信息时，<code>E.statusmsg_time</code> 将包含时间戳。</p>
<p>让我们定义一个 <code>editorSetStatusMessage()</code> 函数。此函数将需要一个格式字符串和一个可变数量的参数，和 <code>printf()</code> 系列函数类似。</p>
<h3 id="Step-98"><a href="#Step-98" class="headerlink" title="Step 98"></a>Step 98</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DEFAULT_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BSD_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">  va_list ap;</span><br><span class="line">  va_start(ap, fmt);</span><br><span class="line">  vsnprintf(E.statusmsg, <span class="keyword">sizeof</span>(E.statusmsg), fmt, ap);</span><br><span class="line">  va_end(ap);</span><br><span class="line">  E.statusmsg_time = time(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line">  initEditor();</span><br><span class="line">  <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    editorOpen(argv[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;HELP: Ctrl-Q = quit&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/set-status-message" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>va_list</code>, <code>va_start()</code>, 和 <code>va_end()</code> 来自 <code>&lt;stdarg.h&gt;</code>。 <code>vsnprintf()</code> 来自 <code>&lt;stdio.h&gt;</code>. <code>time()</code> 来自 <code>&lt;time.h&gt;</code>.</p>
<p>在 <code>main()</code> 函数中，我们将初始状态消息设置为 文本编辑器的使用帮助（当前内容，<code>Ctrl-Q</code> 退出）。</p>
<p><code>vsnprintf()</code> 帮助我们创建自己的 <code>printf()</code> 样式的函数。我们将结果字符串存储在 <code>E.statusmsg</code> 中，并将 <code>E.statusmsg_time</code> 设置为当前时间(这可以通过将 <code>NULL</code> 传递给 <code>time()</code> 来获得)。 （它以整数形式返回自 <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Unix_time" >midnight, January 1, 1970 <i class="fas fa-external-link-alt"></i></a> 以来经过的秒数。）</p>
<p><code>...</code> 参数使 <code>editorSetStatusMessage()</code> 成为可变参数函数(<a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Variadic_function" >variadic function<i class="fas fa-external-link-alt"></i></a>)，这意味着它可以接受任意数量的参数。 C处理这些参数的方式是让您对 <code>va_list</code> 类型的值调用 <code>va_start()</code> 和 <code>va_end()</code> 。必须将 <code>...</code> 之前的最后一个参数（在本例中为 <code>fmt</code>）传递给 <code>va_start()</code> ，以便知道下一个参数的地址。 然后，在 <code>va_start()</code> 和 <code>va_end()</code> 之间，您将调用 <code>va_arg()</code> 并向其传递下一个参数的类型（通常从给定的格式字符串中获取），然后它将返回该参数的值。此处，我们将 <code>fmt</code> 和 <code>ap</code> 传递给 <code>vsnprintf()</code> ，它负责读取格式字符串并调用 <code>va_arg()</code> 来获取每个参数。</p>
<p>现在，我们将显示一条状态消息，让我们在状态栏下方的第二行留出空间，以便在该行中显示该消息。</p>
<h3 id="Step-99"><a href="#Step-99" class="headerlink" title="Step 99"></a>Step 99</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">char</span> status[<span class="number">80</span>], rstatus[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(status, <span class="keyword">sizeof</span>(status), <span class="string">&quot;%.20s - %d lines&quot;</span>,</span><br><span class="line">    E.filename ? E.filename : <span class="string">&quot;[No Name]&quot;</span>, E.numrows);</span><br><span class="line">  <span class="keyword">int</span> rlen = <span class="built_in">snprintf</span>(rstatus, <span class="keyword">sizeof</span>(rstatus), <span class="string">&quot;%d/%d&quot;</span>,</span><br><span class="line">    E.cy + <span class="number">1</span>, E.numrows);</span><br><span class="line">  <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">  abAppend(ab, status, len);</span><br><span class="line">  <span class="keyword">while</span> (len &lt; E.screencols) &#123;</span><br><span class="line">    <span class="keyword">if</span> (E.screencols - len == rlen) &#123;</span><br><span class="line">      abAppend(ab, rstatus, rlen);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">      len++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line">  E.filename = <span class="literal">NULL</span>;</span><br><span class="line">  E.statusmsg[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.statusmsg_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">  E.screenrows -= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/message-bar-make-room" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们再次将 <code>E.screenrows</code> 减一，并在第一个状态栏后打印换行符。现在，我们又有一个空白的最后一行。<br>让我们在新的 <code>editorDrawMessageBar()</code> 函数中绘制消息栏。</p>
<h3 id="Step-100"><a href="#Step-100" class="headerlink" title="Step 100"></a>Step 100</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">int</span> msglen = <span class="built_in">strlen</span>(E.statusmsg);</span><br><span class="line">  <span class="keyword">if</span> (msglen &gt; E.screencols) msglen = E.screencols;</span><br><span class="line">  <span class="keyword">if</span> (msglen &amp;&amp; time(<span class="literal">NULL</span>) - E.statusmsg_time &lt; <span class="number">5</span>)</span><br><span class="line">    abAppend(ab, E.statusmsg, msglen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  editorScroll();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line">  editorDrawStatusBar(&amp;ab);</span><br><span class="line">  editorDrawMessageBar(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, (E.cy - E.rowoff) + <span class="number">1</span>,</span><br><span class="line">                                            (E.rx - E.coloff) + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/draw-message-bar" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>首先，我们用 <code>&lt;esc&gt;[K</code> 转义序列清除消息栏。然后，我们确保该消息将适合屏幕的宽度，再之后，确定消息的显示时间小于5秒后显示该消息。</p>
<p>现在启动程序时，您应该在底部看到帮助消息。 5秒钟后按一个键，它将消失。请记住，我们仅在每次按键后刷新屏幕。</p>
<p>在 <a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/05.aTextEditor.html" >下一章<i class="fas fa-external-link-alt"></i></a> 中，我们将把文本查看器变成文本编辑器，从而允许用户插入和删除字符并将其更改、保存到磁盘。</p>

        </div>

        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/02/27/%E5%8D%83%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA%E4%B8%AA%E4%BA%BA%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%88%E4%B8%89%EF%BC%89Raw-input-and-output/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">千行代码构建个人文本编辑器（三）Raw input and output</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Ling</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.0</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>



<script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/dark-light-toggle.js"></script>







<div class="post-scripts">
    
</div>



</body>
</html>
