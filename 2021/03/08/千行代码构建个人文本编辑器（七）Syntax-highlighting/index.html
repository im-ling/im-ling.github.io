<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Ling">
    
    <title>
        
            千行代码构建个人文本编辑器（七）Syntax highlighting |
        
        Ling&#39;s blog
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="/images/l.svg">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#000000","avatar":"/images/avatar.png","favicon":"/images/l.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.0"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Ling&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">千行代码构建个人文本编辑器（七）Syntax highlighting</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Ling</span>
                        
                            <span class="author-label">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-03-08 13:14:21
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/C/">C</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/translation/">translation</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/C/">C</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Fun/">Fun</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/">文本编辑器</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="Syntax-highlighting"><a href="#Syntax-highlighting" class="headerlink" title="Syntax highlighting"></a>Syntax highlighting</h1><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p><a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/07.syntaxHighlighting.html" >原文链接<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="Colorful-digits"><a href="#Colorful-digits" class="headerlink" title="Colorful digits"></a>Colorful digits</h2><p>让我们从尽可能简单地在屏幕上获得一些颜色开始。我们将尝试通过将每个数字字符渲染成红色来高亮数字。&nbsp;&nbsp;&nbsp;&nbsp;</p>
<h3 id="Step-142"><a href="#Step-142" class="headerlink" title="Step 142"></a>Step 142</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      <span class="keyword">char</span> *c = &amp;E.row[filerow].render[E.coloff];</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isdigit</span>(c[j])) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[31m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-digits" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们不能只再是将要打印的 <code>render</code> 的子字符串直接输入到 <code>abAppend()</code> 中。从现在开始，我们必须逐个字符地进行操作。因此，我们遍历字符并在每个字符上使用 <code>isdigit()</code> 来测试它是否为数字字符。如果是的话，我们在其前面加上 <code>&lt;esc&gt;[31m</code> 转义序列，并在其后跟随 <code>&lt;esc&gt;[39m</code> 序列。</p>
<p>以前，我们使用 <code>m</code> 命令（<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#SGR" >Select Graphic Rendition<i class="fas fa-external-link-alt"></i></a>）使用反色绘制状态栏。现在，我们使用它来设置文本颜色。<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html" > VT100 User Guide<i class="fas fa-external-link-alt"></i></a> 没有颜色说明，因此让我们转到有关 <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ANSI_escape_code" >ANSI escape codes<i class="fas fa-external-link-alt"></i></a> 的Wikipedia文章。它包含一个大表，其中包含可以在各种终端上与 <code>m</code> 命令一起使用的所有不同的变量代码。它还包括具有8种前/背景色的ANSI颜色表。</p>
<p>第一个表说我们可以使用代码 <code>30</code> 到 <code>37</code> 设置文本颜色，并使用 <code>39</code> 将其重置为默认颜色。颜色表上说明 <code>0</code> 是黑色，<code>1</code> 是红色，依此类推，最多可以是 <code>7</code>，是白色。将它们放在一起，我们可以使用<code>31</code> 作为 <code>m</code> 命令的参数将文本颜色设置为红色。打印完数字后，我们使用 <code>39</code> 作为<code>m</code> 的参数将文本颜色设置回正常。<br><br><br><br></p>
<h2 id="Refactor-syntax-highlighting-重构语法高亮"><a href="#Refactor-syntax-highlighting-重构语法高亮" class="headerlink" title="Refactor syntax highlighting 重构语法高亮"></a>Refactor syntax highlighting 重构语法高亮</h2><p>现在我们知道了如何为文本加上颜色，但是我们将不得不做更多的工作来真正高亮显示整个字符串，关键字，注释等。我们不能像每个数字一样根据每个字符的类别来决定使用哪种颜色。我们想要做的是在显示每行文本之前弄清楚如何进行高亮显示，然后在每行更改时重新高亮它。为此，我们需要将每行的高亮显示存储在数组中。让我们向erow结构添加一个名为 <code>hl</code> 的数组，该数组代表“高亮（highlight）”。</p>
<h3 id="Step-143"><a href="#Step-143" class="headerlink" title="Step 143"></a>Step 143</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">int</span> rsize;</span><br><span class="line">  <span class="keyword">char</span> *chars;</span><br><span class="line">  <span class="keyword">char</span> *render;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> *hl;</span><br><span class="line">&#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowRxToCx</span><span class="params">(erow *row, <span class="keyword">int</span> rx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertRow</span><span class="params">(<span class="keyword">int</span> at, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt; E.numrows) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line">  memmove(&amp;E.row[at + <span class="number">1</span>], &amp;E.row[at], <span class="keyword">sizeof</span>(erow) * (E.numrows - at));</span><br><span class="line"></span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line">  E.row[at].hl = <span class="literal">NULL</span>;</span><br><span class="line">  editorUpdateRow(&amp;E.row[at]);</span><br><span class="line">  </span><br><span class="line">  E.numrows++;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(row-&gt;render);</span><br><span class="line">  <span class="built_in">free</span>(row-&gt;chars);</span><br><span class="line">  <span class="built_in">free</span>(row-&gt;hl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowAppendString</span><span class="params">(erow *row, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-refactoring" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>hl</code> 是一个 <code>unsigned char</code> 值的数组，<code>unsigned char</code> 表示值介于 <code>0</code> 到 <code>255</code>之间的整数。数组中的每个值将对应于 <code>render</code> 中的一个字符，并告诉您该字符是否是字符串或注释的一部分，或者一个数字，依此类推。让我们创建一个枚举，包含 <code>hl</code> 数组可以包含的所有可能值。</p>
<h3 id="Step-144"><a href="#Step-144" class="headerlink" title="Step 144"></a>Step 144</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span></span><br><span class="line">  HL_NORMAL = <span class="number">0</span>,</span><br><span class="line">  HL_NUMBER</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/highlight-enum" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>目前，我们仅关注高亮的数字。因此，我们希望作为数字一部分的每个字符在 <code>hl</code> 数组中都具有一个对应的 <code>HL_NUMBER</code> 值，并且我们希望 <code>hl</code> 中的所有其他值都为 <code>HL_NORMAL</code>。</p>
<p>让我们创建一个新的 <code>/*** syntax highlighting ***/</code> 部分，并在其中创建一个 <code>editorUpdateSyntax()</code> 函数。此功能将遍历一个 <code>erow</code> 的所有字符，并通过设置 <code>hl</code> 数组中的每个值来高亮显示它们。</p>
<h3 id="Step-145"><a href="#Step-145" class="headerlink" title="Step 145"></a>Step 145</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; row-&gt;rsize; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isdigit</span>(row-&gt;render[i])) &#123;</span><br><span class="line">      row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-update-syntax" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>memset()</code> 来自 <code>&lt;string.h&gt;</code>。</p>
<p>首先，我们 <code>realloc()</code> 所需的内存，因为这可能是新行，或者该行可能比上次高亮显示行大。请注意，<code>hl</code> 数组的大小与 <code>render</code> 数组的大小相同，因此我们将 <code>rsize</code> 用作分配给 <code>hl</code> 的内存量。</p>
<p>然后，我们使用 <code>memset()</code> 将所有字符默认设置为 <code>HL_NORMAL</code>，然后遍历字符并将数字设置为<code>HL_NUMBER</code>。 （放心，我们之后会采用一种更好的方式来尽快识别数字，但现在我们将重点放在重构上。）</p>
<p>现在，让我们实际调用 <code>editorUpdateSyntax()</code>。</p>
<h3 id="Step-146"><a href="#Step-146" class="headerlink" title="Step 146"></a>Step 146</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowRxToCx</span><span class="params">(erow *row, <span class="keyword">int</span> rx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> tabs = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> j;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++)</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>) tabs++;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(row-&gt;render);</span><br><span class="line">  row-&gt;render = <span class="built_in">malloc</span>(row-&gt;size + tabs*(KILO_TAB_STOP - <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; row-&gt;size; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (row-&gt;chars[j] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">      row-&gt;render[idx++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">      <span class="keyword">while</span> (idx % KILO_TAB_STOP != <span class="number">0</span>) row-&gt;render[idx++] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      row-&gt;render[idx++] = row-&gt;chars[j];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  row-&gt;render[idx] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  row-&gt;rsize = idx;</span><br><span class="line"></span><br><span class="line">  editorUpdateSyntax(row);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertRow</span><span class="params">(<span class="keyword">int</span> at, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowAppendString</span><span class="params">(erow *row, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/call-update-syntax" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>只要行的文本发生更改，<code>editorUpdateRow()</code> 就已经可以更新 <code>render</code> 数组，也就是要更新 <code>hl</code> 数组的时机。因此，在更新 <code>render</code> 数组之后，我们调用 <code>editorUpdateSyntax()</code>。</p>
<p>接下来，让我们创建一个 <code>editorSyntaxToColor()</code> 函数，该函数将 <code>hl</code> 中的值映射到我们要用来绘制它们的实际ANSI颜色代码。</p>
<h3 id="Step-147"><a href="#Step-147" class="headerlink" title="Step 147"></a>Step 147</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (hl) &#123;</span><br><span class="line">    <span class="keyword">case</span> HL_NUMBER: <span class="keyword">return</span> <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/map-colors" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>对于数字，我们返回ANSI代码，“前景红色”，对于其他字符，返回“前景白色”。 （我们之后将单独处理HL_NORMAL，因此 <code>editorSyntaxToColor()</code> 不需要处理。）</p>
<p>现在，最后，让我们将高亮显示的文本绘制到屏幕上！</p>
<h3 id="Step-148"><a href="#Step-148" class="headerlink" title="Step 148"></a>Step 148</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      <span class="keyword">char</span> *c = &amp;E.row[filerow].render[E.coloff];</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">char</span> *hl = &amp;E.row[filerow].hl[E.coloff];</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hl[j] == HL_NORMAL) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> color = editorSyntaxToColor(hl[j]);</span><br><span class="line">          <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line">          <span class="keyword">int</span> clen = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%dm&quot;</span>, color);</span><br><span class="line">          abAppend(ab, buf, clen);</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-hl" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>首先，我们得到一个指向 <code>hl</code> 数组的子数组的指针<code>hl</code>，该指针与我们正在打印的 <code>render</code> 子数组指针相对应。然后，对于每个字符，如果它是 <code>HL_NORMAL</code> 字符，则使用 <code>&lt;esc&gt;[39m</code> 确保在打印之前使用默认文本颜色。如果不是 <code>HL_NORMAL</code>，则我们使用 <code>snprintf()</code> 将转义序列写入缓冲区，然后在附加实际字符之前将其传递给 <code>abAppend()</code>。最后，在完成所有字符的循环并显示它们之后，我们打印最终的 <code>&lt;esc&gt;[39m</code> 转义序列，以确保将文本颜色重置为默认值。</p>
<p>这行得通，但是我们真的必须在每个字符之前写出一个转义序列吗？实际上，大多数字符将与前一个字符具有相同的颜色，因此大多数转义序列是多余的。在循环浏览字符时，让我们跟踪当前的文本颜色，并仅在颜色更改时打印出转义序列。</p>
<h3 id="Step-149"><a href="#Step-149" class="headerlink" title="Step 149"></a>Step 149</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      <span class="keyword">char</span> *c = &amp;E.row[filerow].render[E.coloff];</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">char</span> *hl = &amp;E.row[filerow].hl[E.coloff];</span><br><span class="line">      <span class="keyword">int</span> current_color = <span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hl[j] == HL_NORMAL) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current_color != <span class="number">-1</span>) &#123;</span><br><span class="line">            abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">            current_color = <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> color = editorSyntaxToColor(hl[j]);</span><br><span class="line">          <span class="keyword">if</span> (color != current_color) &#123;</span><br><span class="line">            current_color = color;</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">int</span> clen = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%dm&quot;</span>, color);</span><br><span class="line">            abAppend(ab, buf, clen);</span><br><span class="line">          &#125;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/current-color" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>当我们想要默认的文本颜色时，<code>current_color</code> 为 <code>-1</code>，否则将其设置为 <code>editorSyntaxToColor()</code> 最后返回的值。当颜色更改时，我们将输出该颜色的转义序列，并将 <code>current_color</code> 设置为新颜色。当我们从高亮显示的文本返回到 <code>HL_NORMAL</code> 文本时，我们打印出<code>&lt;esc&gt;[39m</code> 转义序列，并将 <code>current_color</code> 设置为 <code>-1</code>。</p>
<p>到此，我们重构了语法高亮系统。<br><br><br><br></p>
<h2 id="Colorful-search-results"><a href="#Colorful-search-results" class="headerlink" title="Colorful search results"></a>Colorful search results</h2><p>在开始高亮显示字符串和关键字以及所有这些内容之前，让我们使用高亮显示系统高亮显示搜索结果。首先，将 <code>HL_MATCH</code> 添加到 <code>editorHighlight</code> 枚举，然后在 <code>editorSyntaxToColor()</code> 中将其映射到蓝色（<code>34</code>）。</p>
<h3 id="Step-150"><a href="#Step-150" class="headerlink" title="Step 150"></a>Step 150</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span></span><br><span class="line">  HL_NORMAL = <span class="number">0</span>,</span><br><span class="line">  HL_NUMBER,</span><br><span class="line">  HL_MATCH</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (hl) &#123;</span><br><span class="line">    <span class="keyword">case</span> HL_NUMBER: <span class="keyword">return</span> <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_MATCH: <span class="keyword">return</span> <span class="number">34</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hl-match" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，我们要做的就是在我们的搜索代码中用 <code>memset()</code> 将匹配到的子字符串设置成 <code>HL_MATCH</code>。</p>
<h3 id="Step-151"><a href="#Step-151" class="headerlink" title="Step 151"></a>Step 151</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFindCallback</span><span class="params">(<span class="keyword">char</span> *query, <span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> last_match = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> direction = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (key == <span class="string">&#x27;\r&#x27;</span> || key == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    last_match = <span class="number">-1</span>;</span><br><span class="line">    direction = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key == ARROW_RIGHT || key == ARROW_DOWN) &#123;</span><br><span class="line">    direction = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key == ARROW_LEFT || key == ARROW_UP) &#123;</span><br><span class="line">    direction = <span class="number">-1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    last_match = <span class="number">-1</span>;</span><br><span class="line">    direction = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (last_match == <span class="number">-1</span>) direction = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> current = last_match;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; E.numrows; i++) &#123;</span><br><span class="line">    current += direction;</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="number">-1</span>) current = E.numrows - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == E.numrows) current = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    erow *row = &amp;E.row[current];</span><br><span class="line">    <span class="keyword">char</span> *match = <span class="built_in">strstr</span>(row-&gt;render, query);</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">      last_match = current;</span><br><span class="line">      E.cy = current;</span><br><span class="line">      E.cx = editorRowRxToCx(row, match - row-&gt;render);</span><br><span class="line">      E.rowoff = E.numrows;</span><br><span class="line">      <span class="built_in">memset</span>(&amp;row-&gt;hl[match - row-&gt;render], HL_MATCH, <span class="built_in">strlen</span>(query));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFind</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/search-highlighting" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>match - row-&gt;render</code> 是 <code>render</code> 的索引，表示匹配串的开头， 我们用它作为 <code>hl</code> 的索引。<br><br><br><br></p>
<h2 id="Restore-syntax-highlighting-after-search-搜索完高亮恢复"><a href="#Restore-syntax-highlighting-after-search-搜索完高亮恢复" class="headerlink" title="Restore syntax highlighting after search 搜索完高亮恢复"></a>Restore syntax highlighting after search 搜索完高亮恢复</h2><p>当前，即使在用户使用搜索功能完成操作后，搜索结果仍以蓝色高亮显示。我们希望在每次搜索后将 <code>hl</code> 恢复为其先前的值。为此，我们将 <code>hl</code> 的原始内容保存在 <code>editorFindCallback()</code> 中名为 <code>saved_hl</code> 的静态变量中，并将 <code>hl</code> 还原到回调顶部的 <code>save_hl</code> 的内容。</p>
<h3 id="Step-152"><a href="#Step-152" class="headerlink" title="Step 152"></a>Step 152</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFindCallback</span><span class="params">(<span class="keyword">char</span> *query, <span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> last_match = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> direction = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> saved_hl_line;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> *saved_hl = <span class="literal">NULL</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (saved_hl) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(E.row[saved_hl_line].hl, saved_hl, E.row[saved_hl_line].rsize);</span><br><span class="line">    <span class="built_in">free</span>(saved_hl);</span><br><span class="line">    saved_hl = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (key == <span class="string">&#x27;\r&#x27;</span> || key == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    last_match = <span class="number">-1</span>;</span><br><span class="line">    direction = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key == ARROW_RIGHT || key == ARROW_DOWN) &#123;</span><br><span class="line">    direction = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key == ARROW_LEFT || key == ARROW_UP) &#123;</span><br><span class="line">    direction = <span class="number">-1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    last_match = <span class="number">-1</span>;</span><br><span class="line">    direction = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (last_match == <span class="number">-1</span>) direction = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> current = last_match;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; E.numrows; i++) &#123;</span><br><span class="line">    current += direction;</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="number">-1</span>) current = E.numrows - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == E.numrows) current = <span class="number">0</span>;</span><br><span class="line">    erow *row = &amp;E.row[current];</span><br><span class="line">    <span class="keyword">char</span> *match = <span class="built_in">strstr</span>(row-&gt;render, query);</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">      last_match = current;</span><br><span class="line">      E.cy = current;</span><br><span class="line">      E.cx = editorRowRxToCx(row, match - row-&gt;render);</span><br><span class="line">      E.rowoff = E.numrows;</span><br><span class="line"></span><br><span class="line">      saved_hl_line = current;</span><br><span class="line">      saved_hl = <span class="built_in">malloc</span>(row-&gt;rsize);</span><br><span class="line">      <span class="built_in">memcpy</span>(saved_hl, row-&gt;hl, row-&gt;rsize);</span><br><span class="line">      <span class="built_in">memset</span>(&amp;row-&gt;hl[match - row-&gt;render], HL_MATCH, <span class="built_in">strlen</span>(query));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFind</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/restore-hl" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们使用另一个名为 <code>saved_hl_line</code> 的静态变量来了解需要恢复哪一行的 <code>hl</code>。<code>saved_hl</code> 是一个动态分配的数组，当没有任何要还原的内容时，它指向 <code>NULL</code>。如果有要还原的内容，我们用 <code>memcpy()</code> 将其还原到已保存行的 <code>hl</code>，然后将 <code>saved_hl</code> 销毁并将其指针设置回 <code>NULL</code>。</p>
<p>注意， 要确保 <code>malloc()</code> 的内存会被 <code>free()</code>的，因为当用户通过按 <code>Enter</code> 或 <code>Escape</code> 关闭搜索提示时， <code>editorPrompt()</code> 会调用我们的回调，从而在 <code>editPrompt()</code> 最终返回之前恢复 <code>hl</code>之前内容。另请注意，我们确保了<code>save_hl</code> 不可能在其旧值 <code>free()</code> 之前 <code>malloc()</code>，因为我们总是在函数顶部将其 <code>free()</code> 释放它。最后，在保存和还原 <code>hl</code> 之间，用户无法编辑文件，因此我们可以安全地将 <code>saved_hl_line</code> 用作 <code>E.row</code> 的索引。（考虑这些事情很重要。）<br><br><br><br></p>
<h2 id="Colorful-numbers"><a href="#Colorful-numbers" class="headerlink" title="Colorful numbers"></a>Colorful numbers</h2><p>好吧，让我们开始正确地高亮显示数字。首先，我们将 <code>editorUpdateSyntax()</code> 中的 <code>for</code> 循环更改为 <code>while</code> 循环，以允许我们在每次迭代中消耗多个字符。 （对于数字，我们现在一次只消耗一个字符，但这以后将很有用。）</p>
<h3 id="Step-153"><a href="#Step-153" class="headerlink" title="Step 153"></a>Step 153</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isdigit</span>(c)) &#123;</span><br><span class="line">      row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-while" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在让我们定义一个 <code>is_separator()</code> 函数，该函数接受一个字符，如果是分隔符，则返回 true。</p>
<h3 id="Step-154"><a href="#Step-154" class="headerlink" title="Step 154"></a>Step 154</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">isspace</span>(c) || c == <span class="string">&#x27;\0&#x27;</span> || <span class="built_in">strchr</span>(<span class="string">&quot;,.()+-/*=~%&lt;&gt;[];&quot;</span>, c) != <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/is-separator" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>strchr()</code> 来自 <code>&lt;string.h&gt;</code>。它查找字符串中字符的第一个匹配项，并返回指向字符串中匹配字符的指针。如果字符串不包含字符，则 <code>strchr()</code> 返回 <code>NULL</code>。</p>
<p>现在，即使它们是标识符的一部分（例如 <code>int32_t</code> 中的 <code>32</code>），数字也会高亮显示。为了解决这个问题，我们要求数字前面必须有一个分隔符，其中包括空格或标点符号。我们还包括空字节（ <code>&#39;\0&#39;</code> ），因为这样我们就可以将每行末尾的空字节作为分隔符进行计数，这将使将来的某些代码更简单。</p>
<p>让我们向 <code>editorUpdateSyntax()</code> 添加一个 <code>prev_sep</code> 变量，该变量可跟踪先前的字符是否为分隔符。然后，正确使用它来识别并高亮数字。</p>
<h3 id="Step-155"><a href="#Step-155" class="headerlink" title="Step 155"></a>Step 155</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">      row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">      i++;</span><br><span class="line">      prev_sep = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/prev-sep" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将 <code>prev_sep</code> 初始化为 <code>1</code>（意思是 <code>true</code>），因为我们认为该行的开头是分隔符。 （否则，该行开头的数字将不会高亮显示。）</p>
<p><code>prev_hl</code> 设置为上一个字符的高亮显示类型。对于 <code>hl</code> 中标记 <code>HL_NUMBER</code> 的数字，我们现在要求前一个字符是分隔符，或者也是高亮数字才会高亮显示。</p>
<p>当我们决定以某种方式高亮显示当前字符时（在这种情况下为HL_NUMBER），我们将 <code>i</code> 递增以“使用”该字符，将 <code>prev_sep</code> 设置为 <code>0</code> 以指示我们正处于高亮显示过程中，然后 <code>continue</code> 循环。我们将对所有的高亮显示使用这种模式。</p>
<p>如果最后确认当前字符不需要高亮显示，那么我们将在 <code>while</code> 循环的底部，根据当前字符是否为分隔符设置 <code>prev_sep</code>，并增加 <code>i</code> 以使用该字符。我们在函数顶部执行的 <code>memset()</code> 意味着未高亮显示的字符的 <code>hl</code> 值将为<code>HL_NORMAL</code>。</p>
<p>现在，让我们支持高亮显示包含小数点的数字。</p>
<h3 id="Step-156"><a href="#Step-156" class="headerlink" title="Step 156"></a>Step 156</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">        (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">      row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">      i++;</span><br><span class="line">      prev_sep = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/decimal-point" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>一个 <code>.</code> 字符出现在高亮数字字符之后，将会被视为数字的一部分。<br><br><br><br></p>
<h2 id="Detect-filetype-文件类型检测"><a href="#Detect-filetype-文件类型检测" class="headerlink" title="Detect filetype 文件类型检测"></a>Detect filetype 文件类型检测</h2><p>在继续高亮其他内容之前，我们将添加文件类型检测到我们的编辑器中。这可以让我们根据不同类型的文件来制定不同的高亮策略。例如，文本文件不应高亮显示，而C文件则应高亮显示数字，字符串，C/C++样式的注释以及许多特定于C的关键字。</p>
<p>让我们创建一个 <code>editorSyntax</code> 结构，其中将包含特定文件类型的所有语法高亮信息。</p>
<h3 id="Step-157"><a href="#Step-157" class="headerlink" title="Step 157"></a>Step 157</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *filetype;</span><br><span class="line">  <span class="keyword">char</span> **filematch;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/editor-syntax" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>filetype</code> 字段是将在状态栏中显示给用户的文件类型的名称。 <code>filematch</code> 是一个字符串数组，其中每个字符串都包含一个与文件名匹配的模式（用来识别文件）。如果文件名匹配，则文件将被识别为具有该文件类型。最后， <code>flags</code> 是一个位域，其中包含对于该文件类型 是否高亮显示数字、字符串的标志。现在，我们仅定义 <code>HL_HIGHLIGHT_NUMBERS</code> 标志位。</p>
<p>现在，让我们构建一组内联的 <code>editorSyntax</code> 结构，并为其添加一个C语言。</p>
<h3 id="Step-158"><a href="#Step-158" class="headerlink" title="Step 158"></a>Step 158</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="keyword">char</span> *C_HL_extensions[] = &#123; <span class="string">&quot;.c&quot;</span>, <span class="string">&quot;.h&quot;</span>, <span class="string">&quot;.cpp&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> <span class="title">HLDB</span>[] =</span> &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;c&quot;</span>,</span><br><span class="line">    C_HL_extensions,</span><br><span class="line">    HL_HIGHLIGHT_NUMBERS</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HLDB_ENTRIES (sizeof(HLDB) / sizeof(HLDB[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hldb" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>HLDB</code> 代表“高亮数据库(highlight database)”。我们针对C语言的 <code>editorSyntax</code> 结构包含用于文件类型字段的字符串 <code>&quot;c&quot;</code>，用于文件匹配字段的扩展名 <code>&quot;.c&quot;</code>，<code>&quot;.h&quot;</code> 和 <code>&quot;.cpp&quot;</code>（该数组必须以 <code>NULL</code> 终止），以及 <code>HL_HIGHLIGHT_NUMBERS</code> 标志在 <code>flags</code> 中打开。</p>
<p>然后，我们定义一个 <code>HLDB_EN​​TRIES</code> 常量来存储 <code>HLDB</code> 数组的长度。</p>
<p>现在，让我们在全局编辑器状态下添加一个指向当前 <code>editorSyntax</code> 结构的指针，并将其初始化为 <code>NULL</code>。</p>
<h3 id="Step-159"><a href="#Step-159" class="headerlink" title="Step 159"></a>Step 159</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> rx;</span><br><span class="line">  <span class="keyword">int</span> rowoff;</span><br><span class="line">  <span class="keyword">int</span> coloff;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="keyword">int</span> numrows;</span><br><span class="line">  erow *row;</span><br><span class="line">  <span class="keyword">int</span> dirty;</span><br><span class="line">  <span class="keyword">char</span> *filename;</span><br><span class="line">  <span class="keyword">char</span> statusmsg[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">time_t</span> statusmsg_time;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> *<span class="title">syntax</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  E.rx = <span class="number">0</span>;</span><br><span class="line">  E.rowoff = <span class="number">0</span>;</span><br><span class="line">  E.coloff = <span class="number">0</span>;</span><br><span class="line">  E.numrows = <span class="number">0</span>;</span><br><span class="line">  E.row = <span class="literal">NULL</span>;</span><br><span class="line">  E.dirty = <span class="number">0</span>;</span><br><span class="line">  E.filename = <span class="literal">NULL</span>;</span><br><span class="line">  E.statusmsg[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  E.statusmsg_time = <span class="number">0</span>;</span><br><span class="line">  E.syntax = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">  E.screenrows -= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123; … &#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/e-syntax" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>当 <code>E.syntax</code> 为 <code>NULL</code> 时，这意味着当前文件没有文件类型，不会进行任何高亮显示。</p>
<p>让我们在状态栏中显示当前文件类型。如果 <code>E.syntax</code> 为 <code>NULL</code>，则我们将显示 <code>no ft</code>（“ no filetype”）。</p>
<h3 id="Step-160"><a href="#Step-160" class="headerlink" title="Step 160"></a>Step 160</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">char</span> status[<span class="number">80</span>], rstatus[<span class="number">80</span>];</span><br><span class="line">  <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(status, <span class="keyword">sizeof</span>(status), <span class="string">&quot;%.20s - %d lines %s&quot;</span>,</span><br><span class="line">    E.filename ? E.filename : <span class="string">&quot;[No Name]&quot;</span>, E.numrows,</span><br><span class="line">    E.dirty ? <span class="string">&quot;(modified)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">int</span> rlen = <span class="built_in">snprintf</span>(rstatus, <span class="keyword">sizeof</span>(rstatus), <span class="string">&quot;%s | %d/%d&quot;</span>,</span><br><span class="line">    E.syntax ? E.syntax-&gt;filetype : <span class="string">&quot;no ft&quot;</span>, E.cy + <span class="number">1</span>, E.numrows);</span><br><span class="line">  <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">  abAppend(ab, status, len);</span><br><span class="line">  <span class="keyword">while</span> (len &lt; E.screencols) &#123;</span><br><span class="line">    <span class="keyword">if</span> (E.screencols - len == rlen) &#123;</span><br><span class="line">      abAppend(ab, rstatus, rlen);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">      len++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/show-filetype" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，让我们更改 <code>editorUpdateSyntax()</code>，以把当前的 <code>E.syntax</code>值考虑在内。</p>
<h3 id="Step-161"><a href="#Step-161" class="headerlink" title="Step 161"></a>Step 161</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-filetype" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果未设置文件类型，则在 <code>memset()</code> 将整行设置为 <code>HL_NORMAL</code>之后，我们将立即 <code>return</code>。我们还将数字高亮显示代码包装在 <code>if</code> 语句中，该语句检查是否为当前文件类型高亮数字。</p>
<p>现在，我们将创建一个 <code>editorSelectSyntaxHighlight()</code> 函数，该函数尝试将当前文件名与 <code>HLDB</code> 中的 <code>filematch</code> 字段之一进行匹配。如果匹配，则将 <code>E.syntax</code> 设置为该文件类型。</p>
<h3 id="Step-162"><a href="#Step-162" class="headerlink" title="Step 162"></a>Step 162</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.syntax = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *ext = <span class="built_in">strrchr</span>(E.filename, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; HLDB_ENTRIES; j++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> *<span class="title">s</span> =</span> &amp;HLDB[j];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (s-&gt;filematch[i]) &#123;</span><br><span class="line">      <span class="keyword">int</span> is_ext = (s-&gt;filematch[i][<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((is_ext &amp;&amp; ext &amp;&amp; !<span class="built_in">strcmp</span>(ext, s-&gt;filematch[i])) ||</span><br><span class="line">          (!is_ext &amp;&amp; <span class="built_in">strstr</span>(E.filename, s-&gt;filematch[i]))) &#123;</span><br><span class="line">        E.syntax = s;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/select-syntax" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>strrchr()</code> 和 <code>strcmp()</code> 来自 <code>&lt;string.h&gt;</code>。 <code>strrchr()</code> 返回字符串中该字符最后一次出现的指针；<code>strcmp()</code>函数对两个给定的字符串，如果相等则返回0。</p>
<p>我们先将 <code>E.syntax</code> 设置为 <code>NULL</code>，这样，如果没有匹配项，或者没有文件名，那么就没有文件类型。</p>
<p>然后，使用 <code>strrchr()</code> 查找文件名的扩展名，文件名中最后出现的 <code>.</code> 的位置。如果没有扩展名，则 <code>ext</code> 将为 <code>NULL</code>。</p>
<p>最后，我们遍历 <code>HLDB</code> 数组中的每个 <code>editorSyntax</code> 结构，对于其中的每一个元素，我们遍历其 <code>filematch</code> 数组中的每个模式。如果有这么个模式：以 <code>.</code> 开头，则为文件扩展名模式，我们使用 <code>strcmp()</code> 来查看文件名是否以该扩展名结尾。如果它不是文件扩展名模式，则只需使用strstr（）检查该模式是否存在于文件名中的任何位置。如果文件名根据这些规则匹配到了，则将 <code>E.syntax</code> 设置为当前 <code>editorSyntax</code> 结构，然后返回。</p>
<p>我们希望在所有更改 <code>E.filename</code> 的任何地方调用<code>editorSelectSyntaxHighlight()</code>。也就是在 <code>editorOpen()</code> 和 <code>editorSave()</code> 中。</p>
<h3 id="Step-163"><a href="#Step-163" class="headerlink" title="Step 163"></a>Step 163</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">editorRowsToString</span><span class="params">(<span class="keyword">int</span> *buflen)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorOpen</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(E.filename);</span><br><span class="line">  E.filename = strdup(filename);</span><br><span class="line"></span><br><span class="line">  editorSelectSyntaxHighlight();</span><br><span class="line">  </span><br><span class="line">  FILE *fp = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!fp) die(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">size_t</span> linecap = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">ssize_t</span> linelen;</span><br><span class="line">  <span class="keyword">while</span> ((linelen = getline(&amp;line, &amp;linecap, fp)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (linelen &gt; <span class="number">0</span> &amp;&amp; (line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span> ||</span><br><span class="line">                           line[linelen - <span class="number">1</span>] == <span class="string">&#x27;\r&#x27;</span>))</span><br><span class="line">      linelen--;</span><br><span class="line">    editorInsertRow(E.numrows, line, linelen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(line);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  E.dirty = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    E.filename = editorPrompt(<span class="string">&quot;Save as: %s (ESC to cancel)&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      editorSetStatusMessage(<span class="string">&quot;Save aborted&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    editorSelectSyntaxHighlight();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">  <span class="keyword">char</span> *buf = editorRowsToString(&amp;len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fd = open(E.filename, O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ftruncate(fd, len) != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(fd, buf, len) == len) &#123;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">        E.dirty = <span class="number">0</span>;</span><br><span class="line">        editorSetStatusMessage(<span class="string">&quot;%d bytes written to disk&quot;</span>, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  editorSetStatusMessage(<span class="string">&quot;Can&#x27;t save! I/O error: %s&quot;</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/detect-filetype" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>此时，当在编辑器中打开C文件时，应该看到数字高亮显示，并且在显示文件类型的状态栏中应该看到c。当您不带任何参数启动编辑器并以 <code>.c</code> 结尾的文件名保存文件时，您应该在状态栏中看到文件类型从 <code>no ft</code> 满意的（😄）变为 <code>c</code>。但是，文件中可能包含的任何数字都不会高亮显示！不开心😔！</p>
<p>在 <code>editorEditSyntaxHighlight()</code> 中设置 <code>E.syntax</code> 后，让我们重新高亮渲染整个文件。</p>
<h3 id="Step-164"><a href="#Step-164" class="headerlink" title="Step 164"></a>Step 164</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.syntax = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (E.filename == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *ext = <span class="built_in">strrchr</span>(E.filename, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; HLDB_ENTRIES; j++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> *<span class="title">s</span> =</span> &amp;HLDB[j];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (s-&gt;filematch[i]) &#123;</span><br><span class="line">      <span class="keyword">int</span> is_ext = (s-&gt;filematch[i][<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((is_ext &amp;&amp; ext &amp;&amp; !<span class="built_in">strcmp</span>(ext, s-&gt;filematch[i])) ||</span><br><span class="line">          (!is_ext &amp;&amp; <span class="built_in">strstr</span>(E.filename, s-&gt;filematch[i]))) &#123;</span><br><span class="line">        E.syntax = s;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> filerow;</span><br><span class="line">        <span class="keyword">for</span> (filerow = <span class="number">0</span>; filerow &lt; E.numrows; filerow++) &#123;</span><br><span class="line">          editorUpdateSyntax(&amp;E.row[filerow]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/rehighlight" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们仅仅需要循环遍历文件中的每一行，然后在其上调用 <code>editorUpdateSyntax()</code>。现在，当文件类型更改时，高亮显示立即生效。<br><br><br><br></p>
<h2 id="Colorful-strings-多色字符窜"><a href="#Colorful-strings-多色字符窜" class="headerlink" title="Colorful strings 多色字符窜"></a>Colorful strings 多色字符窜</h2><p>终于将以上内容结束了， 我们终于可以来高亮更多内容了。让我们从字符串开始吧。</p>
<h3 id="Step-165"><a href="#Step-165" class="headerlink" title="Step 165"></a>Step 165</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span></span><br><span class="line">  HL_NORMAL = <span class="number">0</span>,</span><br><span class="line">  HL_STRING,</span><br><span class="line">  HL_NUMBER,</span><br><span class="line">  HL_MATCH</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (hl) &#123;</span><br><span class="line">    <span class="keyword">case</span> HL_STRING: <span class="keyword">return</span> <span class="number">35</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_NUMBER: <span class="keyword">return</span> <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_MATCH: <span class="keyword">return</span> <span class="number">34</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hl-string" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将字符串渲染成品红色（35）。</p>
<p>现在，让我们加一个 <code>HL_HIGHLIGHT_STRINGS</code> 标志位添加到 <code>editorSyntax</code> 结构的 <code>flags</code> 中，并在高亮显示C文件时打开该标志位。</p>
<h3 id="Step-166"><a href="#Step-166" class="headerlink" title="Step 166"></a>Step 166</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_STRINGS (1&lt;&lt;1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="keyword">char</span> *C_HL_extensions[] = &#123; <span class="string">&quot;.c&quot;</span>, <span class="string">&quot;.h&quot;</span>, <span class="string">&quot;.cpp&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> <span class="title">HLDB</span>[] =</span> &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;c&quot;</span>,</span><br><span class="line">    C_HL_extensions,</span><br><span class="line">    HL_HIGHLIGHT_NUMBERS | HL_HIGHLIGHT_STRINGS</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HLDB_ENTRIES (sizeof(HLDB) / sizeof(HLDB[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/string-flag" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在要实际的高亮代码了。我们将使用 <code>in_string</code> 变量来跟踪我们当前是否在字符串中。如果是这样，那么我们将继续高亮显示当前字符，直到结束引号为止。</p>
<h3 id="Step-167"><a href="#Step-167" class="headerlink" title="Step 167"></a>Step 167</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-strings" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如您所见，我们同时高亮显示了双引号和单引号的字符串（sorry, Lispers / Rustaceans）。实际上，我们将双引号（<code>&quot;</code>）或单引号（<code>&#39;</code>）字符存储为 <code>in_string</code> 的值，以便我们知道哪个字符关闭了字符串。</p>
<p>通观代码：如果设置了 <code>in_string</code>，那么我们知道可以使用 <code>HL_STRING</code> 高亮当前字符。然后，我们检查当前字符是否为右引号（<code>c == in_string</code>），如果是，则将 <code>in_string</code> 重置为 <code>0</code>。然后，由于高亮显示了当前字符，因此必须通过递增 <code>i</code> 并 <code>continue</code> 当前循环迭代。我们还将 <code>prev_sep</code> 设置为 <code>1</code>，以便在高亮显示字符串时，将结束引号视为分隔符。</p>
<p>如果当前不在字符串中，则必须通过检查双引号或单引号来检查是否在字符串的开头。如果是开头，我们将引号存储在 <code>in_string</code> 中，并用<code>HL_STRING</code>高亮显示并加一 <code>continue</code>。</p>
<p>在高亮字符串时，我们可能应该考虑转义的引号。如果字符串中出现序列 <code>\&#39; </code> 或 ‘&quot;‘，则转义的引号不会关闭绝大多数语言中的字符串。</p>
<h3 id="Step-168"><a href="#Step-168" class="headerlink" title="Step 168"></a>Step 168</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/string-escapes" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果我们在一个字符串中，并且当前字符是反斜杠（<code>\</code>），并且该行中的反斜杠之后至少还有一个字符，则可以使用 <code>HL_STRING</code> 高亮显示反斜杠之后的字符。我们将 <code>i</code> 加 <code>2</code> 以一次消耗两个字符。<br><br><br><br></p>
<h2 id="Colorful-single-line-comments-单行多彩注释"><a href="#Colorful-single-line-comments-单行多彩注释" class="headerlink" title="Colorful single-line comments 单行多彩注释"></a>Colorful single-line comments 单行多彩注释</h2><p>接下来，让我们高亮显示单行注释。 （由于复杂度的关系，我们将多行注释保留到最后。）</p>
<h3 id="Step-169"><a href="#Step-169" class="headerlink" title="Step 169"></a>Step 169</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span></span><br><span class="line">  HL_NORMAL = <span class="number">0</span>,</span><br><span class="line">  HL_COMMENT,</span><br><span class="line">  HL_STRING,</span><br><span class="line">  HL_NUMBER,</span><br><span class="line">  HL_MATCH</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_STRINGS (1&lt;&lt;1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (hl) &#123;</span><br><span class="line">    <span class="keyword">case</span> HL_COMMENT: <span class="keyword">return</span> <span class="number">36</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_STRING: <span class="keyword">return</span> <span class="number">35</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_NUMBER: <span class="keyword">return</span> <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_MATCH: <span class="keyword">return</span> <span class="number">34</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hl-comment" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>注释将以青色（36）高亮显示。</p>
<p>我们将让每种语言指定其自己的单行注释模式，因为它们之间的语言差异很大。我们将一个 <code>singleline_comment_start</code> 字符串添加到 <code>editorSyntax</code> 结构，并将其设置为C文件类型的 <code>&quot;//&quot;</code>。</p>
<h3 id="Step-170"><a href="#Step-170" class="headerlink" title="Step 170"></a>Step 170</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *filetype;</span><br><span class="line">  <span class="keyword">char</span> **filematch;</span><br><span class="line">  <span class="keyword">char</span> *singleline_comment_start;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="keyword">char</span> *C_HL_extensions[] = &#123; <span class="string">&quot;.c&quot;</span>, <span class="string">&quot;.h&quot;</span>, <span class="string">&quot;.cpp&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> <span class="title">HLDB</span>[] =</span> &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;c&quot;</span>,</span><br><span class="line">    C_HL_extensions,</span><br><span class="line">    <span class="string">&quot;//&quot;</span>,</span><br><span class="line">    HL_HIGHLIGHT_NUMBERS | HL_HIGHLIGHT_STRINGS</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HLDB_ENTRIES (sizeof(HLDB) / sizeof(HLDB[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/scs" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>好的，现在让我们来高亮代码。</p>
<h3 id="Step-171"><a href="#Step-171" class="headerlink" title="Step 171"></a>Step 171</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> *scs = E.syntax-&gt;singleline_comment_start;</span><br><span class="line">  <span class="keyword">int</span> scs_len = scs ? <span class="built_in">strlen</span>(scs) : <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (scs_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], scs, scs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_COMMENT, row-&gt;rsize - i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-comments" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>strncmp()</code> 来自 <code>&lt;string.h&gt;</code>。</p>
<p>如果您希望对特定文件类型的单行注释不进行高亮显示，则应该可以将<code>singleline_comment_start</code> 设置为 <code>NULL</code> 或空字符串（<code>&quot;&quot;</code>）。我们使 <code>scs</code> 成为 <code>E.syntax-&gt;singleline_comment_start</code> 的别名，以便于键入（和可读性，也许吗？）。然后，将 <code>scs_len</code> 设置为字符串的长度，如果字符串为 <code>NULL</code>，则将其设置为 <code>0</code>。这使我们可以使用<code>scs_len</code> 作为布尔值来知道是否应高亮显示单行注释。</p>
<p>因此，我们将注释高亮显示代码包装在if语句中，该语句检查scs_len并确保我们不在字符串中，因为我们将此代码置于字符串高亮显示代码上方（此函数的顺序很重要）。</p>
<p>如果这些检查通过了，那么我们将使用 <code>strncmp()</code> 来检查此字符是否是单行注释的开始。如果是这样，那么我们只需使用 <code>HL_COMMENT</code> 来对行的其余部分进行 <code>memset()</code>，<code>break</code>高亮显示循环。这样，我们就高亮显示了该行。<br><br><br><br></p>
<h2 id="Colorful-keywords-关键字多彩"><a href="#Colorful-keywords-关键字多彩" class="headerlink" title="Colorful keywords 关键字多彩"></a>Colorful keywords 关键字多彩</h2><p>现在，我们来高亮关键字。我们将允许语言指定两种类型的关键字，这些关键字将以不同的颜色高亮。 （在C语言中，我们将用一种颜色高亮显示实际的关键字，并用另一种颜色高亮显示常用的类型。）</p>
<h3 id="Step-172"><a href="#Step-172" class="headerlink" title="Step 172"></a>Step 172</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span></span><br><span class="line">  HL_NORMAL = <span class="number">0</span>,</span><br><span class="line">  HL_COMMENT,</span><br><span class="line">  HL_KEYWORD1,</span><br><span class="line">  HL_KEYWORD2,</span><br><span class="line">  HL_STRING,</span><br><span class="line">  HL_NUMBER,</span><br><span class="line">  HL_MATCH</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_STRINGS (1&lt;&lt;1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (hl) &#123;</span><br><span class="line">    <span class="keyword">case</span> HL_COMMENT: <span class="keyword">return</span> <span class="number">36</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_KEYWORD1: <span class="keyword">return</span> <span class="number">33</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_KEYWORD2: <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_STRING: <span class="keyword">return</span> <span class="number">35</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_NUMBER: <span class="keyword">return</span> <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_MATCH: <span class="keyword">return</span> <span class="number">34</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hl-keywords" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将用于高亮关键字的两种颜色是黄色（<code>33</code>）和绿色（<code>32</code>）。</p>
<p>让我们将一个 <code>keywords</code> 数组添加到 <code>editorSyntax</code> 结构中。这将是一个以 <code>NULL</code> 终止的字符串数组，每个字符串都包含一个关键字。为了区分两种类型的关键字，我们将使用竖线（ <code>|</code> ）作为第二种类型的关键字的结尾。</p>
<h3 id="Step-173"><a href="#Step-173" class="headerlink" title="Step 173"></a>Step 173</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *filetype;</span><br><span class="line">  <span class="keyword">char</span> **filematch;</span><br><span class="line">  <span class="keyword">char</span> **keywords;</span><br><span class="line">  <span class="keyword">char</span> *singleline_comment_start;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="keyword">char</span> *C_HL_extensions[] = &#123; <span class="string">&quot;.c&quot;</span>, <span class="string">&quot;.h&quot;</span>, <span class="string">&quot;.cpp&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *C_HL_keywords[] = &#123;</span><br><span class="line">  <span class="string">&quot;switch&quot;</span>, <span class="string">&quot;if&quot;</span>, <span class="string">&quot;while&quot;</span>, <span class="string">&quot;for&quot;</span>, <span class="string">&quot;break&quot;</span>, <span class="string">&quot;continue&quot;</span>, <span class="string">&quot;return&quot;</span>, <span class="string">&quot;else&quot;</span>,</span><br><span class="line">  <span class="string">&quot;struct&quot;</span>, <span class="string">&quot;union&quot;</span>, <span class="string">&quot;typedef&quot;</span>, <span class="string">&quot;static&quot;</span>, <span class="string">&quot;enum&quot;</span>, <span class="string">&quot;class&quot;</span>, <span class="string">&quot;case&quot;</span>,</span><br><span class="line">  <span class="string">&quot;int|&quot;</span>, <span class="string">&quot;long|&quot;</span>, <span class="string">&quot;double|&quot;</span>, <span class="string">&quot;float|&quot;</span>, <span class="string">&quot;char|&quot;</span>, <span class="string">&quot;unsigned|&quot;</span>, <span class="string">&quot;signed|&quot;</span>,</span><br><span class="line">  <span class="string">&quot;void|&quot;</span>, <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> <span class="title">HLDB</span>[] =</span> &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;c&quot;</span>,</span><br><span class="line">    C_HL_extensions,</span><br><span class="line">    C_HL_keywords,</span><br><span class="line">    <span class="string">&quot;//&quot;</span>,</span><br><span class="line">    HL_HIGHLIGHT_NUMBERS | HL_HIGHLIGHT_STRINGS</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HLDB_ENTRIES (sizeof(HLDB) / sizeof(HLDB[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/c-keywords" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如前所述，我们将C的常见类型作为次要关键字高亮显示，因此我们在每个次要关键字末尾都加上 <code>|</code> 字符。</p>
<p>现在，让我们高亮显示它们。</p>
<h3 id="Step-174"><a href="#Step-174" class="headerlink" title="Step 174"></a>Step 174</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> **keywords = E.syntax-&gt;keywords;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *scs = E.syntax-&gt;singleline_comment_start;</span><br><span class="line">  <span class="keyword">int</span> scs_len = scs ? <span class="built_in">strlen</span>(scs) : <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scs_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], scs, scs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_COMMENT, row-&gt;rsize - i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_sep) &#123;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; keywords[j]; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> klen = <span class="built_in">strlen</span>(keywords[j]);</span><br><span class="line">        <span class="keyword">int</span> kw2 = keywords[j][klen - <span class="number">1</span>] == <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (kw2) klen--;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], keywords[j], klen) &amp;&amp;</span><br><span class="line">            is_separator(row-&gt;render[i + klen])) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], kw2 ? HL_KEYWORD2 : HL_KEYWORD1, klen);</span><br><span class="line">          i += klen;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (keywords[j] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-keywords" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>首先，在函数顶部，我们将 <code>keywords</code> 作为 <code>E.syntax-&gt;keywords</code> 的别名，因为我们将大量使用它，而且是在一些非常密集的代码中使用。</p>
<p>关键字在关键字之前和之后均需要分隔符。否则，<code>avoid</code>， <code>voided</code> 或者 <code>voidable</code> 中的 <code>void</code> 将被高亮显示为关键字，这绝对是我们要避免的情况。</p>
<p>因此，在循环遍历每个可能的关键字之前，我们检查 <code>prev_sep</code> 以确保在关键字之前的是个分隔符。对于每个关键字，我们将长度存储在 <code>klen</code> 中，是否是次要关键字存储在 <code>kw2</code> 中，如果是次要关键字，我们将 <code>klen</code> 递减以得到除去 <code>|</code> 的关键字。</p>
<p>然后，我们使用 <code>strncmp()</code> 来检查关键字是否存在于文本中的当前位置，并检查关键字后面是否有分隔符。由于 <code>\0</code> 被认为是分隔符，因此如果关键字在行的最后，这也是行的通的。</p>
<p>如果所有这些都通过了，那么我们高亮它。我们使用 <code>memset()</code> 高亮整个关键字，并根据 <code>kw2</code> 的值使用 <code>HL_KEYWORD1</code> 或 <code>HL_KEYWORD2</code> 高亮整个关键字。然后，我们通过将 <code>i</code> 增加关键字的长度来跳过整个关键字。然后我们中断而不是继续，因为我们处于一个内部循环中，因此我们必须先中断该循环，然后再继续外部循环。这就是为什么在 <code>for</code> 循环之后，我们通过查看循环是否达到终止 <code>NULL</code> 值来检查循环是否中断，如果没有中断，则继续。<br><br><br><br></p>
<h2 id="Nonprintable-characters-不可打印字符"><a href="#Nonprintable-characters-不可打印字符" class="headerlink" title="Nonprintable characters 不可打印字符"></a>Nonprintable characters 不可打印字符</h2><p>在高亮多行注释之前，让我们先从 <code>editorUpdateSyntax()</code>出来稍作休息。</p>
<p>我们想更加用户友好的方式显示不可打印的字符。当前，不可打印的字符完全弄乱了我们的编辑器的渲染效果。请尝试运行 <code>kilo</code> 并将其作为参数传递给自己。也就是说，使用 <code>kilo</code> 打开 <code>kilo</code> 可执行文件。并尝试移动光标，然后打字。编辑器的渲染效果很不好。每次按键都会导致终端响起，这是因为正在打印出铃声字符（<code>7</code>）。我们代码中包含终端转义序列的字符串将作为实际的转义序列打印出来，因为原始可执行文件中就是这么储存它们的。</p>
<p>为了防止所有这些情况，我们将把不可打印的字符转换为可打印的字符。我们将字母控制字符（ <code>Ctrl-A</code> = <code>1</code>，<code>Ctrl-B</code> = <code>2</code>，…，<code>Ctrl-Z</code> = <code>26</code>）呈现为大写字母 <code>A</code> 到 <code>Z</code>。我们还将字节 <code>0</code> 像控制字符一样呈现。 <code>Ctrl-@</code> =​​ <code>0</code>，因此我们将其呈现为 <code>@</code> 符号。最后，我们将其他所有不可打印的字符显示为问号（<code>？</code>）。为了将这些字符与可打印的字符区分开来，我们将使用反色（白底黑字）对它们进行渲染。</p>
<h3 id="Step-175"><a href="#Step-175" class="headerlink" title="Step 175"></a>Step 175</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      <span class="keyword">char</span> *c = &amp;E.row[filerow].render[E.coloff];</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">char</span> *hl = &amp;E.row[filerow].hl[E.coloff];</span><br><span class="line">      <span class="keyword">int</span> current_color = <span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">iscntrl</span>(c[j])) &#123;</span><br><span class="line">          <span class="keyword">char</span> sym = (c[j] &lt;= <span class="number">26</span>) ? <span class="string">&#x27;@&#x27;</span> + c[j] : <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">          abAppend(ab, &amp;sym, <span class="number">1</span>);</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hl[j] == HL_NORMAL) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current_color != <span class="number">-1</span>) &#123;</span><br><span class="line">            abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">            current_color = <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> color = editorSyntaxToColor(hl[j]);</span><br><span class="line">          <span class="keyword">if</span> (color != current_color) &#123;</span><br><span class="line">            current_color = color;</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">int</span> clen = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%dm&quot;</span>, color);</span><br><span class="line">            abAppend(ab, buf, clen);</span><br><span class="line">          &#125;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/nonprintables" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们使用 <code>iscntrl()</code> 来检查当前字符是否为控制字符。如果是这样，我们可以通过将其值添加 <code>@</code>（在ASCII中，大写字母在 <code>@</code> 字符之后）将其转换为可打印的字符，或使用 <code>?</code> 字符（如果不在字母范围内）。</p>
<p>然后，在打印翻译的符号之前，我们使用 <code>&lt;esc&gt;[7m</code> 转义序列切换为反色。之后我们使用 <code>&lt;esc&gt;[m</code> 再次关闭反色。</p>
<p>不幸的是，<code>&lt;esc&gt;[m</code> 关闭了所有文本格式，包括颜色。因此，让我们随后为当前颜色打印转义序列。</p>
<h3 id="Step-176"><a href="#Step-176" class="headerlink" title="Step 176"></a>Step 176</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorScroll</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">int</span> filerow = y + E.rowoff;</span><br><span class="line">    <span class="keyword">if</span> (filerow &gt;= E.numrows) &#123;</span><br><span class="line">      <span class="keyword">if</span> (E.numrows == <span class="number">0</span> &amp;&amp; y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">        <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">          <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">        <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">          padding--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">        abAppend(ab, welcome, welcomelen);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> len = E.row[filerow].rsize - E.coloff;</span><br><span class="line">      <span class="keyword">if</span> (len &lt; <span class="number">0</span>) len = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; E.screencols) len = E.screencols;</span><br><span class="line">      <span class="keyword">char</span> *c = &amp;E.row[filerow].render[E.coloff];</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">char</span> *hl = &amp;E.row[filerow].hl[E.coloff];</span><br><span class="line">      <span class="keyword">int</span> current_color = <span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">iscntrl</span>(c[j])) &#123;</span><br><span class="line">          <span class="keyword">char</span> sym = (c[j] &lt;= <span class="number">26</span>) ? <span class="string">&#x27;@&#x27;</span> + c[j] : <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[7m&quot;</span>, <span class="number">4</span>);</span><br><span class="line">          abAppend(ab, &amp;sym, <span class="number">1</span>);</span><br><span class="line">          abAppend(ab, <span class="string">&quot;\x1b[m&quot;</span>, <span class="number">3</span>);</span><br><span class="line">          <span class="keyword">if</span> (current_color != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">int</span> clen = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%dm&quot;</span>, current_color);</span><br><span class="line">            abAppend(ab, buf, clen);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hl[j] == HL_NORMAL) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current_color != <span class="number">-1</span>) &#123;</span><br><span class="line">            abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">            current_color = <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> color = editorSyntaxToColor(hl[j]);</span><br><span class="line">          <span class="keyword">if</span> (color != current_color) &#123;</span><br><span class="line">            current_color = color;</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">int</span> clen = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%dm&quot;</span>, color);</span><br><span class="line">            abAppend(ab, buf, clen);</span><br><span class="line">          &#125;</span><br><span class="line">          abAppend(ab, &amp;c[j], <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\x1b[39m&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawStatusBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawMessageBar</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSetStatusMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/nonprintables-fix-color" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>您可以通过按 <code>Ctrl-A</code>，<code>Ctrl-B</code> 等将这些控制字符插入字符串或注释中来测试不可打印字符的颜色，并且应该看到它们与周围的字符具有相同的颜色，只是反转了。<br><br><br><br></p>
<h2 id="Colorful-multiline-comments"><a href="#Colorful-multiline-comments" class="headerlink" title="Colorful multiline comments"></a>Colorful multiline comments</h2><p>好的，让我们来实现的最后一个功能：多行注释高亮显示。首先，将<code>HL_MLCOMMENT</code> 添加到 <code>editorHighlight</code>枚举中。</p>
<h3 id="Step-177"><a href="#Step-177" class="headerlink" title="Step 177"></a>Step 177</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_TAB_STOP 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_QUIT_TIMES 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorHighlight</span> &#123;</span></span><br><span class="line">  HL_NORMAL = <span class="number">0</span>,</span><br><span class="line">  HL_COMMENT,</span><br><span class="line">  HL_MLCOMMENT,</span><br><span class="line">  HL_KEYWORD1,</span><br><span class="line">  HL_KEYWORD2,</span><br><span class="line">  HL_STRING,</span><br><span class="line">  HL_NUMBER,</span><br><span class="line">  HL_MATCH</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HL_HIGHLIGHT_STRINGS (1&lt;&lt;1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (hl) &#123;</span><br><span class="line">    <span class="keyword">case</span> HL_COMMENT:</span><br><span class="line">    <span class="keyword">case</span> HL_MLCOMMENT: <span class="keyword">return</span> <span class="number">36</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_KEYWORD1: <span class="keyword">return</span> <span class="number">33</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_KEYWORD2: <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_STRING: <span class="keyword">return</span> <span class="number">35</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_NUMBER: <span class="keyword">return</span> <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">case</span> HL_MATCH: <span class="keyword">return</span> <span class="number">34</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">37</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hl-multiline-comments" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们用单行注释相同的颜色（青色）来高亮显示多行注释。</p>
<p>现在，让我们添加两个字符串到 <code>editorSyntax</code> 结构: <code>multiline_comment_start</code> 和 <code>multiline_comment_end</code>. 在 C 中， 它们分别是 <code>&quot;/*&quot;</code> 和 <code>&quot;*/&quot;</code>。</p>
<h3 id="Step-178"><a href="#Step-178" class="headerlink" title="Step 178"></a>Step 178</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *filetype;</span><br><span class="line">  <span class="keyword">char</span> **filematch;</span><br><span class="line">  <span class="keyword">char</span> **keywords;</span><br><span class="line">  <span class="keyword">char</span> *singleline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *multiline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *multiline_comment_end;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span> … &#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="keyword">char</span> *C_HL_extensions[] = &#123; <span class="string">&quot;.c&quot;</span>, <span class="string">&quot;.h&quot;</span>, <span class="string">&quot;.cpp&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *C_HL_keywords[] = &#123; … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> <span class="title">HLDB</span>[] =</span> &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;c&quot;</span>,</span><br><span class="line">    C_HL_extensions,</span><br><span class="line">    C_HL_keywords,</span><br><span class="line">    <span class="string">&quot;//&quot;</span>, <span class="string">&quot;/*&quot;</span>, <span class="string">&quot;*/&quot;</span>,</span><br><span class="line">    HL_HIGHLIGHT_NUMBERS | HL_HIGHLIGHT_STRINGS</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HLDB_ENTRIES (sizeof(HLDB) / sizeof(HLDB[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/mcs-mce" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，让我们再次打开 <code>editorUpdateSyntax()</code>。 正如我们给单行注释（single-line-comments）起别名 <code>scs</code> 一样，我们将加上别名 <code>mcs</code> 和 <code>mce</code>。 我们还要加上 <code>mcs_len</code> 和 <code>mce_len</code>。</p>
<h3 id="Step-179"><a href="#Step-179" class="headerlink" title="Step 179"></a>Step 179</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> **keywords = E.syntax-&gt;keywords;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *scs = E.syntax-&gt;singleline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mcs = E.syntax-&gt;multiline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mce = E.syntax-&gt;multiline_comment_end;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> scs_len = scs ? <span class="built_in">strlen</span>(scs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mcs_len = mcs ? <span class="built_in">strlen</span>(mcs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mce_len = mce ? <span class="built_in">strlen</span>(mce) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scs_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], scs, scs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_COMMENT, row-&gt;rsize - i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_sep) &#123;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; keywords[j]; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> klen = <span class="built_in">strlen</span>(keywords[j]);</span><br><span class="line">        <span class="keyword">int</span> kw2 = keywords[j][klen - <span class="number">1</span>] == <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (kw2) klen--;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], keywords[j], klen) &amp;&amp;</span><br><span class="line">            is_separator(row-&gt;render[i + klen])) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], kw2 ? HL_KEYWORD2 : HL_KEYWORD1, klen);</span><br><span class="line">          i += klen;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (keywords[j] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/mcs-mce-len" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在来高亮代码。我们不需要再担心多行注释了。</p>
<h3 id="Step-180"><a href="#Step-180" class="headerlink" title="Step 180"></a>Step 180</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> **keywords = E.syntax-&gt;keywords;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *scs = E.syntax-&gt;singleline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mcs = E.syntax-&gt;multiline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mce = E.syntax-&gt;multiline_comment_end;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> scs_len = scs ? <span class="built_in">strlen</span>(scs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mcs_len = mcs ? <span class="built_in">strlen</span>(mcs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mce_len = mce ? <span class="built_in">strlen</span>(mce) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> in_comment = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scs_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], scs, scs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_COMMENT, row-&gt;rsize - i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mcs_len &amp;&amp; mce_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_comment) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_MLCOMMENT;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], mce, mce_len)) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_MLCOMMENT, mce_len);</span><br><span class="line">          i += mce_len;</span><br><span class="line">          in_comment = <span class="number">0</span>;</span><br><span class="line">          prev_sep = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], mcs, mcs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_MLCOMMENT, mcs_len);</span><br><span class="line">        i += mcs_len;</span><br><span class="line">        in_comment = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_sep) &#123;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; keywords[j]; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> klen = <span class="built_in">strlen</span>(keywords[j]);</span><br><span class="line">        <span class="keyword">int</span> kw2 = keywords[j][klen - <span class="number">1</span>] == <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (kw2) klen--;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], keywords[j], klen) &amp;&amp;</span><br><span class="line">            is_separator(row-&gt;render[i + klen])) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], kw2 ? HL_KEYWORD2 : HL_KEYWORD1, klen);</span><br><span class="line">          i += klen;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (keywords[j] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/syntax-mlcomment" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>首先，我们添加了一个 <code>in_comment</code> 布尔变量，以跟踪我们当前是否在多行注释中（此变量不用于单行注释）。</p>
<p>接下来我们向下进入 <code>while</code> 循环，我们要求 <code>mcs</code> 和 <code>mce</code> 均为长度大于 <code>0</code> 的非 <code>NULL</code> 字符串，以便打开多行注释高亮显示。我们还会检查 <code>in_string</code> 以确保当前不在字符串中，因为在大多数语言中，字符串中包含 <code>/*</code> 不会引起注释。好吧，我会说：所有语言。</p>
<p>如果我们当前处于多行注释中，则可以使用 <code>HL_MLCOMMENT</code> 安全地突出显示当前字符。然后，通过将 <code>strncmp()</code> 与 <code>mce</code> 结合使用，以检查是否在多行注释的结尾。如果是结尾，我们使用 <code>memset()</code> 和 <code>HL_MLCOMMENT</code> 高亮显示整个 <code>mce</code> 字符串，然后跳过它。如果我们不在注释的末尾，则跳过当前已经高亮显示的字符。</p>
<p>如果我们当前不在多行注释中，则用 <code>strncmp()</code> 比对 <code>mcs</code> 以检查当前是否在多行注释的开头。如果是开头，我们使用 <code>memset()</code> 和 <code>HL_MLCOMMENT</code> 高亮显示整个 <code>mcs</code> 字符串，并将 <code>in_comment</code> 设置为<code>true</code>，并跳过整个 <code>mcs</code> 字符串。</p>
<p>现在，让我们解决多行注释添加的一些复杂问题：单行注释不应在多行注释中被识别。</p>
<h3 id="Step-181"><a href="#Step-181" class="headerlink" title="Step 181"></a>Step 181</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> **keywords = E.syntax-&gt;keywords;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> *scs = E.syntax-&gt;singleline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mcs = E.syntax-&gt;multiline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mce = E.syntax-&gt;multiline_comment_end;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> scs_len = scs ? <span class="built_in">strlen</span>(scs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mcs_len = mcs ? <span class="built_in">strlen</span>(mcs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mce_len = mce ? <span class="built_in">strlen</span>(mce) : <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> in_comment = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (scs_len &amp;&amp; !in_string &amp;&amp; !in_comment) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], scs, scs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_COMMENT, row-&gt;rsize - i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (mcs_len &amp;&amp; mce_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_comment) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_MLCOMMENT;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], mce, mce_len)) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_MLCOMMENT, mce_len);</span><br><span class="line">          i += mce_len;</span><br><span class="line">          in_comment = <span class="number">0</span>;</span><br><span class="line">          prev_sep = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], mcs, mcs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_MLCOMMENT, mcs_len);</span><br><span class="line">        i += mcs_len;</span><br><span class="line">        in_comment = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (prev_sep) &#123;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; keywords[j]; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> klen = <span class="built_in">strlen</span>(keywords[j]);</span><br><span class="line">        <span class="keyword">int</span> kw2 = keywords[j][klen - <span class="number">1</span>] == <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (kw2) klen--;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], keywords[j], klen) &amp;&amp;</span><br><span class="line">            is_separator(row-&gt;render[i + klen])) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], kw2 ? HL_KEYWORD2 : HL_KEYWORD1, klen);</span><br><span class="line">          i += klen;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (keywords[j] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/slcomment-within-mlcomment" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>好的，现在让我们着重强看一下跨越多行的多行注释。为此，我们需要知道上一行是否是多行注释未封闭的一部分。我们将 <code>hl_open_comment</code> 布尔变量添加到 <code>erow</code> 结构中。我们还添加一个 <code>idx</code> 整数变量，以便每个行都知道文件中自己的索引。这样一来，每一行都可以检查前一行的 <code>hl_open_comment</code> 值。</p>
<h3 id="Step-182"><a href="#Step-182" class="headerlink" title="Step 182"></a>Step 182</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorSyntax</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">erow</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> idx;</span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">int</span> rsize;</span><br><span class="line">  <span class="keyword">char</span> *chars;</span><br><span class="line">  <span class="keyword">char</span> *render;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> *hl;</span><br><span class="line">  <span class="keyword">int</span> hl_open_comment;</span><br><span class="line">&#125; erow;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowRxToCx</span><span class="params">(erow *row, <span class="keyword">int</span> rx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertRow</span><span class="params">(<span class="keyword">int</span> at, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt; E.numrows) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line">  memmove(&amp;E.row[at + <span class="number">1</span>], &amp;E.row[at], <span class="keyword">sizeof</span>(erow) * (E.numrows - at));</span><br><span class="line">  </span><br><span class="line">  E.row[at].idx = at;</span><br><span class="line">  </span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line">  E.row[at].hl = <span class="literal">NULL</span>;</span><br><span class="line">  E.row[at].hl_open_comment = <span class="number">0</span>;</span><br><span class="line">  editorUpdateRow(&amp;E.row[at]);</span><br><span class="line"></span><br><span class="line">  E.numrows++;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowAppendString</span><span class="params">(erow *row, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/idx-and-hloc" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在打开文件时，我们将 <code>idx</code> 初始化为文件中该行的索引。让我们确保每当将行插入文件或从文件中删除时，都更新每行的 <code>idx</code>。</p>
<h3 id="Step-183"><a href="#Step-183" class="headerlink" title="Step 183"></a>Step 183</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowCxToRx</span><span class="params">(erow *row, <span class="keyword">int</span> cx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorRowRxToCx</span><span class="params">(erow *row, <span class="keyword">int</span> rx)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorInsertRow</span><span class="params">(<span class="keyword">int</span> at, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt; E.numrows) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  E.row = <span class="built_in">realloc</span>(E.row, <span class="keyword">sizeof</span>(erow) * (E.numrows + <span class="number">1</span>));</span><br><span class="line">  memmove(&amp;E.row[at + <span class="number">1</span>], &amp;E.row[at], <span class="keyword">sizeof</span>(erow) * (E.numrows - at));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> j = at + <span class="number">1</span>; j &lt;= E.numrows; j++) E.row[j].idx++;</span><br><span class="line"></span><br><span class="line">  E.row[at].idx = at;</span><br><span class="line"></span><br><span class="line">  E.row[at].size = len;</span><br><span class="line">  E.row[at].chars = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(E.row[at].chars, s, len);</span><br><span class="line">  E.row[at].chars[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  E.row[at].rsize = <span class="number">0</span>;</span><br><span class="line">  E.row[at].render = <span class="literal">NULL</span>;</span><br><span class="line">  E.row[at].hl = <span class="literal">NULL</span>;</span><br><span class="line">  E.row[at].hl_open_comment = <span class="number">0</span>;</span><br><span class="line">  editorUpdateRow(&amp;E.row[at]);</span><br><span class="line"></span><br><span class="line">  E.numrows++;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorFreeRow</span><span class="params">(erow *row)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDelRow</span><span class="params">(<span class="keyword">int</span> at)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (at &lt; <span class="number">0</span> || at &gt;= E.numrows) <span class="keyword">return</span>;</span><br><span class="line">  editorFreeRow(&amp;E.row[at]);</span><br><span class="line">  memmove(&amp;E.row[at], &amp;E.row[at + <span class="number">1</span>], <span class="keyword">sizeof</span>(erow) * (E.numrows - at - <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> j = at; j &lt; E.numrows - <span class="number">1</span>; j++) E.row[j].idx--;</span><br><span class="line">  E.numrows--;</span><br><span class="line">  E.dirty++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowInsertChar</span><span class="params">(erow *row, <span class="keyword">int</span> at, <span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowAppendString</span><span class="params">(erow *row, <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRowDelChar</span><span class="params">(erow *row, <span class="keyword">int</span> at)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/update-idx" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>当进行插入和或者删除行时，<code>for</code> 循环更新每一行的索引。</p>
<p>现在，让我们完成最后一步。</p>
<h3 id="Step-184"><a href="#Step-184" class="headerlink" title="Step 184"></a>Step 184</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** filetypes ***/</span></span><br><span class="line"><span class="comment">/*** prototypes ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** syntax highlighting ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">is_separator</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorUpdateSyntax</span><span class="params">(erow *row)</span> </span>&#123;</span><br><span class="line">  row-&gt;hl = <span class="built_in">realloc</span>(row-&gt;hl, row-&gt;rsize);</span><br><span class="line">  <span class="built_in">memset</span>(row-&gt;hl, HL_NORMAL, row-&gt;rsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (E.syntax == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> **keywords = E.syntax-&gt;keywords;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *scs = E.syntax-&gt;singleline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mcs = E.syntax-&gt;multiline_comment_start;</span><br><span class="line">  <span class="keyword">char</span> *mce = E.syntax-&gt;multiline_comment_end;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> scs_len = scs ? <span class="built_in">strlen</span>(scs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mcs_len = mcs ? <span class="built_in">strlen</span>(mcs) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> mce_len = mce ? <span class="built_in">strlen</span>(mce) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> prev_sep = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> in_string = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> in_comment = (row-&gt;idx &gt; <span class="number">0</span> &amp;&amp; E.row[row-&gt;idx - <span class="number">1</span>].hl_open_comment);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; row-&gt;rsize) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = row-&gt;render[i];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> prev_hl = (i &gt; <span class="number">0</span>) ? row-&gt;hl[i - <span class="number">1</span>] : HL_NORMAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scs_len &amp;&amp; !in_string &amp;&amp; !in_comment) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], scs, scs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_COMMENT, row-&gt;rsize - i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mcs_len &amp;&amp; mce_len &amp;&amp; !in_string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_comment) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_MLCOMMENT;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], mce, mce_len)) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_MLCOMMENT, mce_len);</span><br><span class="line">          i += mce_len;</span><br><span class="line">          in_comment = <span class="number">0</span>;</span><br><span class="line">          prev_sep = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], mcs, mcs_len)) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;row-&gt;hl[i], HL_MLCOMMENT, mcs_len);</span><br><span class="line">        i += mcs_len;</span><br><span class="line">        in_comment = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_STRINGS) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_string) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_STRING;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; i + <span class="number">1</span> &lt; row-&gt;rsize) &#123;</span><br><span class="line">          row-&gt;hl[i + <span class="number">1</span>] = HL_STRING;</span><br><span class="line">          i += <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c == in_string) in_string = <span class="number">0</span>;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span> || c == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">          in_string = c;</span><br><span class="line">          row-&gt;hl[i] = HL_STRING;</span><br><span class="line">          i++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (E.syntax-&gt;flags &amp; HL_HIGHLIGHT_NUMBERS) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(c) &amp;&amp; (prev_sep || prev_hl == HL_NUMBER)) ||</span><br><span class="line">          (c == <span class="string">&#x27;.&#x27;</span> &amp;&amp; prev_hl == HL_NUMBER)) &#123;</span><br><span class="line">        row-&gt;hl[i] = HL_NUMBER;</span><br><span class="line">        i++;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev_sep) &#123;</span><br><span class="line">      <span class="keyword">int</span> j;</span><br><span class="line">      <span class="keyword">for</span> (j = <span class="number">0</span>; keywords[j]; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> klen = <span class="built_in">strlen</span>(keywords[j]);</span><br><span class="line">        <span class="keyword">int</span> kw2 = keywords[j][klen - <span class="number">1</span>] == <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (kw2) klen--;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(&amp;row-&gt;render[i], keywords[j], klen) &amp;&amp;</span><br><span class="line">            is_separator(row-&gt;render[i + klen])) &#123;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;row-&gt;hl[i], kw2 ? HL_KEYWORD2 : HL_KEYWORD1, klen);</span><br><span class="line">          i += klen;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (keywords[j] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        prev_sep = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prev_sep = is_separator(c);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> changed = (row-&gt;hl_open_comment != in_comment);</span><br><span class="line">  row-&gt;hl_open_comment = in_comment;</span><br><span class="line">  <span class="keyword">if</span> (changed &amp;&amp; row-&gt;idx + <span class="number">1</span> &lt; E.numrows)</span><br><span class="line">    editorUpdateSyntax(&amp;E.row[row-&gt;idx + <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorSyntaxToColor</span><span class="params">(<span class="keyword">int</span> hl)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorSelectSyntaxHighlight</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** row operations ***/</span></span><br><span class="line"><span class="comment">/*** editor operations ***/</span></span><br><span class="line"><span class="comment">/*** file i/o ***/</span></span><br><span class="line"><span class="comment">/*** find ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/propagate-highlight" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果上一行是未封闭的多行注释，则在 <code>editorUpdateSyntax()</code> 头部附近，我们将 <code>in_comment</code> 初始化为 <code>true</code>。这种情况下，那么当前行将开始以多行注释的形式高亮显示。</p>
<p>在 <code>editorUpdateSyntax()</code> 的底部，我们将当前行的 <code>hl_open_comment</code> 的值设置为处理完整行后 <code>in_comment</code>状态。这告诉我们该行是否以未封闭的多行注释结束。</p>
<p>然后，我们必须考虑更新文件中下一行的语法。到目前为止，我们仅在用户更改特定行时才更新该行的语法。但是有了多行注释，用户只需更改一行就可以注释掉整个文件。因此，似乎我们需要更新当前行之后所有行的语法。但是，我们知道如果此行的 <code>hl_open_comment</code> 的值未更改，则下一行的高亮显示不会更改。因此，我们检查它是否已更改，并且仅在 <code>hl_open_comment</code> 更改（并且文件中是否存在下一行）的情况下，才在下一行调用 <code>editorUpdateSyntax()</code> 。由于 <code>editorUpdateSyntax()</code>会不断调用下一行，因此更改将继续向下执行到越来越多的行，直到其中一行不变为止，这时我们知道该行之后的所有行也不该改变。<br><br><br><br></p>
<h2 id="You’re-done"><a href="#You’re-done" class="headerlink" title="You’re done"></a>You’re done</h2><p>这就是全部了！我们的文本编辑器完成了！ 在 <a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/08.appendices.html" >附录<i class="fas fa-external-link-alt"></i></a> 中，您可能会发现一些您可能想自己扩展文本编辑器功能的想法。</p>

        </div>

        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/03/08/%E5%8D%83%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA%E4%B8%AA%E4%BA%BA%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%88%E5%85%AD%EF%BC%89Search/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">千行代码构建个人文本编辑器（六）Search</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Ling</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.0</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>



<script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/dark-light-toggle.js"></script>







<div class="post-scripts">
    
</div>



</body>
</html>
