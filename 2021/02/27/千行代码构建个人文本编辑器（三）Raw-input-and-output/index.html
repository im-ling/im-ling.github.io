<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Ling">
    
    <title>
        
            千行代码构建个人文本编辑器（三）Raw input and output |
        
        Ling&#39;s blog
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="/images/l.svg">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#000000","avatar":"/images/avatar.png","favicon":"/images/l.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.0"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            <a class="logo-title" href="/">
                Ling&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">千行代码构建个人文本编辑器（三）Raw input and output</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Ling</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-02-27 18:21:00
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/C/">C</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/translation/">translation</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/C/">C</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Fun/">Fun</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/">文本编辑器</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="Raw-input-and-output"><a href="#Raw-input-and-output" class="headerlink" title="Raw input and output"></a>Raw input and output</h1><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p><a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/03.rawInputAndOutput.html" >原文链接<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="Press-Ctrl-Q-to-quit-按-Ctrl-Q-退出"><a href="#Press-Ctrl-Q-to-quit-按-Ctrl-Q-退出" class="headerlink" title="Press Ctrl-Q to quit 按 Ctrl-Q 退出"></a>Press <code>Ctrl-Q</code> to quit 按 <code>Ctrl-Q</code> 退出</h2><p>在上一章中，我们看到 <code>Ctrl</code> 键和字母键组合起来似乎可以映射到字节1–26。我们可以使用它来检测 <code>Ctrl</code> 键组合，并将其映射到编辑器中的不同操作。首先，将 <code>Ctrl-Q</code> 映射到quit操作。</p>
<h3 id="Step-20"><a href="#Step-20" class="headerlink" title="Step 20"></a>Step 20</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;c, <span class="number">1</span>) == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">iscntrl</span>(c)) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, c);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d (&#x27;%c&#x27;)\r\n&quot;</span>, c, c);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">if</span> (c == CTRL_KEY(<span class="string">&#x27;q&#x27;</span>)) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/ctrl-q" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>CTRL_KEY</code>宏按位与二进制值 <code>00011111</code> 的字符进行“与”运算。 （在C语言中，通常使用十六进制指定位掩码，因为C没有二进制文字，一旦习惯了十六进制，十六进制更简洁易读。）换句话说，它将字符的高3位设置为 <code>0</code> 。这反映了 <code>Ctrl</code> 键在终端中的作用：它将您与 <code>Ctrl</code> 组合在一起按下的键中剥离了第5位和第6位，再将其发送。 （按照惯例，位编号从0开始。）ASCII字符集似乎是故意以此方式设计的。 （它的设计也类似，因此您可以设置和清除第5位以在小写和大写之间切换。）</p>
<br>
<br>

<h2 id="Refactor-keyboard-input-重构键盘输入"><a href="#Refactor-keyboard-input-重构键盘输入" class="headerlink" title="Refactor keyboard input 重构键盘输入"></a>Refactor keyboard input 重构键盘输入</h2><p>让我们创建一个用于读取底层按键的功能，以及一个用于将按键映射到编辑器操作的功能。另外，使用这两个功能时，我们还将停止打印按键。</p>
<h3 id="Step-21"><a href="#Step-21" class="headerlink" title="Step 21"></a>Step 21</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> c = editorReadKey();</span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">exit</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/refactor-input" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>editorReadKey()</code> 的工作是等待一次按键，然后将其返回。之后，我们将扩展此功能以处理转义序列，这涉及读取代表单个按键的多个字节，如箭头键一样。</p>
<p><code>editorProcessKeypress()</code> 等待一次按键，然后对其进行处理。之后，它将各种 <code>Ctrl</code> 组合键和其他特殊键映射到不同的编辑器功能，并将任何字母数字和其他可打印键的字符插入正在编辑的文本中。</p>
<p>请注意，<code>editorReadKey()</code> 属于 <code>/*** 终端 ***/</code> 部分，因为它处理底层终端输入，而<code>editorProcessKeypress()</code> 属于<code>/*** 输入 ***/</code>部分，因为它处理将键映射到更高级别的编辑器功能。</p>
<p>现在我们已经大大简化了 <code>main()</code>函数，我们将尝试保持这种状态。</p>
<br>
<br>

<h2 id="Clear-the-screen-清除屏幕"><a href="#Clear-the-screen-清除屏幕" class="headerlink" title="Clear the screen 清除屏幕"></a>Clear the screen 清除屏幕</h2><p>现在我们要将用户的按键渲染到屏幕上了。让我们从清除屏幕开始。</p>
<h3 id="Step-21-1"><a href="#Step-21-1" class="headerlink" title="Step 21"></a>Step 21</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/clear-screen" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>write()</code> 和 <code>STDOUT_FILENO</code> 来自头文件 <code>&lt;unistd.h&gt;</code>.</p>
<p><code>write()</code> 函数中的 <code>4</code> 表示我们正在向终端写入 <code>4</code> 个字节。第一个字节是 <code>\x1b</code>，它是转义字符(<code>escape character</code>)，十进制的 <code>27</code>。 （尝试记住 <code>\x1b</code>，我们将大量使用它。）其他三个字节为 <code>[2J</code>。</p>
<p>我们正在向终端写一个转义序列(<code>escape sequence</code>)。转义序列始终以转义字符（<code>27</code>）开头，后跟 <code>[</code> 字符。转义序列指示终端执行各种文本格式设置任务，例如为文本着色，移动光标和清除屏幕部分。</p>
<p>我们正在使用 <code>J</code> 命令（<a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt100-ug/chapter3.html#ED" >Erase In Display<i class="fas fa-external-link-alt"></i></a>）来清除屏幕。转义序列命令带有参数，该参数位于命令之前。此处的情况是，参数为 <code>2</code>，表示要清除整个屏幕。<code>&lt;esc&gt;[1J</code> 将清除屏幕直到光标所在的位置，而<code>&lt;esc&gt;[0J</code>将清除屏幕，从光标开始直到屏幕结尾的位置。另外，<code>0</code> 是 <code>J</code> 的默认参数，因此，仅 <code>&lt;esc&gt;[J</code> 本身也可以将屏幕从光标移到末尾。</p>
<p>对于我们的文本编辑器，我们将主要使用 <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/VT100" >VT100<i class="fas fa-external-link-alt"></i></a> 转义序列，现代终端仿真器广泛支持VT100转义序列。有关每个转义序列的完整文档，请参阅 <a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt100-ug/chapter3.html" >《VT100用户指南》<i class="fas fa-external-link-alt"></i></a>。</p>
<p>如果要支持指定终端的最大数量，可以使用 <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ncurses" >ncurses<i class="fas fa-external-link-alt"></i></a>库，该库使用 <a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Terminfo" >terminfo<i class="fas fa-external-link-alt"></i></a> 数据库来确定终端的能力以及该特定终端要使用的转义序列。</p>
<br>
<br>

<h2 id="Reposition-the-cursor"><a href="#Reposition-the-cursor" class="headerlink" title="Reposition the cursor"></a>Reposition the cursor</h2><p>您可能会注意到 <code>&lt;esc&gt;[2J</code>命令将光标留在了屏幕底部。让我们将其重新放置在左上角，以便我们准备从上到下绘制编辑器界面。</p>
<h3 id="Step-23"><a href="#Step-23" class="headerlink" title="Step 23"></a>Step 23</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/cursor-home" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>此转义序列只有 <code>3</code> 个字节长，并使用 <code>H</code> 命令（<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#CUP" >Cursor Position<i class="fas fa-external-link-alt"></i></a>）定位光标。 <code>H</code> 命令实际上接受两个参数：将光标定位在的行号和列号。因此，如果您有一个80×24大小的终端，并且希望光标位于屏幕的中央，则可以使用命令 <code>&lt;esc&gt; [12;40H]</code> （多个参数用;字符分隔）。<code>H</code> 的默认参数都为 <code>1</code>，因此我们可以将这两个参数都省略掉，它将把光标定位在第一行和第一列，就像我们使用了 <code>&lt;esc&gt;[1;1H</code> 命令一样（行和列的编号从 <code>1</code> 开始，而不是 <code>0</code>）。</p>
<br>
<br>

<h2 id="Clear-the-screen-on-exit-推出时清屏"><a href="#Clear-the-screen-on-exit-推出时清屏" class="headerlink" title="Clear the screen on exit 推出时清屏"></a>Clear the screen on exit 推出时清屏</h2><p>退出程序后，让我们清除屏幕并重新定位光标。如果在渲染屏幕的过程中发生错误，我们不希望在屏幕上留下一堆垃圾，并且，此时无论光标在哪，我们不希望打印该错误。</p>
<h3 id="Step-24"><a href="#Step-24" class="headerlink" title="Step 24"></a>Step 24</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  perror(s);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/clean-exit" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们有两个要清除屏幕的地方：<code>die()</code> ，和当用户按下 <code>Ctrl-Q</code> 退出时。</p>
<p>我们可以在程序退出时使用 <code>atexit()</code>来清除屏幕，但随后 <code>die()</code> 打印的错误消息将在打印后立即消除。</p>
<br>
<br>

<h2 id="Tildes"><a href="#Tildes" class="headerlink" title="Tildes"></a>Tildes</h2><p>是时候开始绘制了。让我们在屏幕的左侧绘制波浪号（ <code>〜</code> ）列，就像 <a class="link"   target="_blank" rel="noopener" href="http://www.vim.org/" >vim<i class="fas fa-external-link-alt"></i></a> 一样。在我们的文本编辑器中，我们将在要编辑的文件结尾之后的所有行的开头绘制波浪号。</p>
<h3 id="Step-25"><a href="#Step-25" class="headerlink" title="Step 25"></a>Step 25</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; <span class="number">24</span>; y++) &#123;</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;~\r\n&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  editorDrawRows();</span><br><span class="line">  write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/tildes" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>editorDrawRows()</code> 将处理编辑的文本缓冲区的每一行的绘制。目前，它在每行中都显示一个波浪号，这意味着该行不属于文件，并且不能包含任何文本。</p>
<p>我们尚不知道终端的大小，因此我们不知道要绘制多少行。现在，我们先绘制 <code>24</code>行。</p>
<p>完成绘制后，我们执行另一个 <code>&lt;esc&gt;[H</code> 转义序列以将光标重新定位回到左上角。<br><br><br><br></p>
<h2 id="Global-state"><a href="#Global-state" class="headerlink" title="Global state"></a>Global state</h2><p>我们的下一个目标是获取终端的大小，这样我们就能知道在 <code>editorDrawRows()</code> 中需要绘制多少行。但是首先，让我们定义一个包含我们的编辑器状态的全局结构，该结构将用于存储终端的宽度和高度。现在，让我们将 <code>orig_termios</code> 全局变量放入结构中。</p>
<h3 id="Step-26"><a href="#Step-26" class="headerlink" title="Step 26"></a>Step 26</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tcsetattr(STDIN_FILENO, TCSAFLUSH, &amp;E.orig_termios) == <span class="number">-1</span>)</span><br><span class="line">    die(<span class="string">&quot;tcsetattr&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tcgetattr(STDIN_FILENO, &amp;E.orig_termios) == <span class="number">-1</span>) die(<span class="string">&quot;tcgetattr&quot;</span>);</span><br><span class="line">  atexit(disableRawMode);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">raw</span> =</span> E.orig_termios;</span><br><span class="line">  raw.c_iflag &amp;= ~(BRKINT | ICRNL | INPCK | ISTRIP | IXON);</span><br><span class="line">  raw.c_oflag &amp;= ~(OPOST);</span><br><span class="line">  raw.c_cflag |= (CS8);</span><br><span class="line">  raw.c_lflag &amp;= ~(ECHO | ICANON | IEXTEN | ISIG);</span><br><span class="line">  raw.c_cc[VMIN] = <span class="number">0</span>;</span><br><span class="line">  raw.c_cc[VTIME] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tcsetattr(STDIN_FILENO, TCSAFLUSH, &amp;raw) == <span class="number">-1</span>) die(<span class="string">&quot;tcsetattr&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/global-state" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们将包含编辑器状态的全局变量命名为 <code>E</code>。我们必须用 <code>E.orig_termios</code> 替换所有出现的<code>orig_termios</code>。</p>
<br>
<br>

<h2 id="Window-size-the-easy-way-使用简单方式获取窗口大小"><a href="#Window-size-the-easy-way-使用简单方式获取窗口大小" class="headerlink" title="Window size, the easy way 使用简单方式获取窗口大小"></a>Window size, the easy way 使用简单方式获取窗口大小</h2><p>在大多数系统上，您应该能够通过使用 <code>TIOCGWINSZ</code> 请求和简单地调用 <code>ioctl()</code> 来获得终端的大小。 （据我所知，缩写 <code>TIOCGWINSZ</code> 代表 <strong>T</strong>erminal <strong>IOC</strong>tl <strong>G</strong>et <strong>WIN</strong>dow <strong>S</strong>i<strong>Z</strong>e， <code>IOCtl</code> 代表 <strong>I</strong>nput/<strong>O</strong>utput <strong>C</strong>on<strong>t</strong>ro<strong>l</strong>）</p>
<h3 id="Step-27"><a href="#Step-27" class="headerlink" title="Step 27"></a>Step 27</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">ws</span>;</span></span><br><span class="line">  <span class="keyword">if</span> (ioctl(STDOUT_FILENO, TIOCGWINSZ, &amp;ws) == <span class="number">-1</span> || ws.ws_col == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *cols = ws.ws_col;</span><br><span class="line">    *rows = ws.ws_row;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/ioctl" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>ioctl()</code>, <code>TIOCGWINSZ</code>, 和 <code>struct winsize</code> 均来自 <code>&lt;sys/ioctl.h&gt;</code>.</p>
<p>成功时，<code>ioctl()</code> 将把终端的列宽和行高处放入给定的 <code>winsize</code> 结构中。失败时，<code>ioctl()</code> 返回 <code>-1</code>。我们还检查以确保返回的值不为 <code>0</code>，因为显然是个错误的结果。无论<code>ioctl()</code> 函数怎么失败的，通过返回 <code>-1</code> 来使 <code>getWindowSize()</code> 报告失败。如果成功，则通过设置传递给函数的 <code>int</code> 指针将值传递回去。 （这是C中函数返回多个值的常用方法。它还允许您使用返回值指示成功或失败。）</p>
<p>现在，我们将 <code>screenrows</code> 和 <code>screencols</code> 添加到我们的全局编辑器状态中，然后调用<code>getWindowSize()</code> 来填上这些值。</p>
<h3 id="Step-28"><a href="#Step-28" class="headerlink" title="Step 28"></a>Step 28</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  enableRawMode();</span><br><span class="line">  initEditor();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    editorRefreshScreen();</span><br><span class="line">    editorProcessKeypress();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/init-editor" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>initEditor()</code> 的工作将是初始化 <code>E</code> 结构体中的所有字段。</p>
<p>现在，我们准备在屏幕上显示适当数量的波浪号：</p>
<h3 id="Step-29"><a href="#Step-29" class="headerlink" title="Step 29"></a>Step 29</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;~\r\n&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/screenrows" >源代码<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="Window-size-the-hard-way-复杂方式获得窗口大小"><a href="#Window-size-the-hard-way-复杂方式获得窗口大小" class="headerlink" title="Window size, the hard way 复杂方式获得窗口大小"></a>Window size, the hard way 复杂方式获得窗口大小</h2><p><code>ioctl()</code>不能保证能够在所有系统上请求窗口大小，因此我们将提供一种获取窗口大小的备用方法。</p>
<p>策略是将光标定位在屏幕的右下角，然后使用转义序列让我们查询光标的位置。这告诉我们屏幕上有多少行和几列。</p>
<p>首先将光标移到右下角。</p>
<h3 id="Step-30"><a href="#Step-30" class="headerlink" title="Step 30"></a>Step 30</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">ws</span>;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">1</span> || ioctl(STDOUT_FILENO, TIOCGWINSZ, &amp;ws) == <span class="number">-1</span> || ws.ws_col == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (write(STDOUT_FILENO, <span class="string">&quot;\x1b[999C\x1b[999B&quot;</span>, <span class="number">12</span>) != <span class="number">12</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    editorReadKey();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *cols = ws.ws_col;</span><br><span class="line">    *rows = ws.ws_row;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/bottom-right" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>正如您可能从代码中看到的那样，没有简单的“将光标移至右下角”命令。</p>
<p>我们正在依次发送两个转义序列。 <code>C</code> 命令（<a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt100-ug/chapter3.html#CUF" >Cursor Forward<i class="fas fa-external-link-alt"></i></a>）将光标向右移动，而 <code>B</code> 命令（<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#CUD" >Cursor Down<i class="fas fa-external-link-alt"></i></a>）将光标向下移动。参数说明了将其向右或向下移动多少。我们使用一个非常大的值，<code>999</code>，来确保光标到达屏幕的右边缘和下边缘。</p>
<p>特别指定 <a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#CUD" >documented<i class="fas fa-external-link-alt"></i></a> 了 <code>C</code> 和 <code>B</code> 命令，以阻止光标越过屏幕边缘。我们不使用<code> &lt;esc&gt;[999;999H</code>命令的原因是，文档(<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#CUP" >documentation<i class="fas fa-external-link-alt"></i></a>)没有指定尝试将光标移到屏幕外时会发生的情况。</p>
<p>请注意，我们用 <code>1 ||</code> 置于if条件的最前面，以便我们可以测试我们正在开发的这个后备方案。</p>
<p>此时，由于我们总是 <code>从getWindowSize()</code> 返回-1（表示发生错误），因此我们对 <code>editorReadKey()</code> 进行了调用，因此我们可以在程序调用 <code>die()</code> 之前观察转义序列的结果，并清除屏幕。运行该程序时，您应该看到光标位于屏幕的右下角，然后当您按下某个键时，它会在清除屏幕后看到 <code>die()</code> 打印的错误消息。</p>
<p>接下来，我们需要获取光标位置。 <code>n</code> 命令（<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#DSR" >Device Status Report<i class="fas fa-external-link-alt"></i></a>）可用于向终端查询状态信息。我们想给它一个参数<code>6</code> 来要求光标位置。然后，我们可以从标准输入中读取答复。让我们从标准输入中打印出每个字符，以查看回复的样子。</p>
<h3 id="Step-31"><a href="#Step-31" class="headerlink" title="Step 31"></a>Step 31</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (write(STDOUT_FILENO, <span class="string">&quot;\x1b[6n&quot;</span>, <span class="number">4</span>) != <span class="number">4</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> (read(STDIN_FILENO, &amp;c, <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">iscntrl</span>(c)) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, c);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d (&#x27;%c&#x27;)\r\n&quot;</span>, c, c);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">ws</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">1</span> || ioctl(STDOUT_FILENO, TIOCGWINSZ, &amp;ws) == <span class="number">-1</span> || ws.ws_col == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (write(STDOUT_FILENO, <span class="string">&quot;\x1b[999C\x1b[999B&quot;</span>, <span class="number">12</span>) != <span class="number">12</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> getCursorPosition(rows, cols);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *cols = ws.ws_col;</span><br><span class="line">    *rows = ws.ws_row;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/cursor-query" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>答复是一个转义序列(<code>escape sequence</code>)！ 它是转义字符（<code>27</code>），后跟 <code>[</code> 字符，然后是实际响应 <code>:24;80R</code>(或者类似)。 （此转义序列在文档 <a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt100-ug/chapter3.html#CPR" >Cursor Position Report<i class="fas fa-external-link-alt"></i></a> 有专门记录）</p>
<p>和以前一样，我们插入了对 <code>editorReadKey()</code> 的临时调用代码，以让我们在退出屏幕清除之前观察调试输出。</p>
<p>（注意：如果是 <code>Bash on Windows</code>，则 <code>read()</code> 不会超时，因此会陷入无限循环。您必须在外部终止进程，或者退出并重新打开命令提示符窗口。 ）</p>
<p>我们必须要解析此响应。但首先，让我们将其读入缓冲区。我们将持续读取字符，直到到达 <code>R</code> 字符为止。</p>
<h3 id="Step-32"><a href="#Step-32" class="headerlink" title="Step 32"></a>Step 32</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(STDOUT_FILENO, <span class="string">&quot;\x1b[6n&quot;</span>, <span class="number">4</span>) != <span class="number">4</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (i &lt; <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;buf[i], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (buf[i] == <span class="string">&#x27;R&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  buf[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\r\n&amp;buf[1]: &#x27;%s&#x27;\r\n&quot;</span>, &amp;buf[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/response-buffer" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>当我们打印缓冲区时，我们不想打印 <code>&#39;\x1b&#39;</code> 字符，因为终端会将其解释为转义序列，而不显示它。因此，我们通过将 <code>＆buf[1]</code> 传递给 <code>printf()</code> 来跳过 <code>buf</code> 中的第一个字符。 <code>printf()</code> 期望字符串以字节 <code>0</code> 结尾，因此我们需确保将 <code>&#39;\0&#39;</code> 分配给 <code>buf</code> 的最后一个字节。</p>
<p>如果您运行该程序，则会看到我们 <code>buf</code> 里的响应的格式为 <code>&lt;esc&gt;[24;80</code> 。让我们使用<code>sscanf()</code> 解析出里面的两个数字：</p>
<h3 id="Step-33"><a href="#Step-33" class="headerlink" title="Step 33"></a>Step 33</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(STDOUT_FILENO, <span class="string">&quot;\x1b[6n&quot;</span>, <span class="number">4</span>) != <span class="number">4</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (i &lt; <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;buf[i], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (buf[i] == <span class="string">&#x27;R&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  buf[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buf[<span class="number">0</span>] != <span class="string">&#x27;\x1b&#x27;</span> || buf[<span class="number">1</span>] != <span class="string">&#x27;[&#x27;</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">sscanf</span>(&amp;buf[<span class="number">2</span>], <span class="string">&quot;%d;%d&quot;</span>, rows, cols) != <span class="number">2</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/parse-response" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>sscanf()</code> 来自 <code>&lt;stdio.h&gt;</code>。</p>
<p>首先，我们确保响应是一个转义序列。然后，我们将指向 <code>buf</code> 的第三个字符的指针传递给<code>sscanf()</code> 函数，跳过 <code>&#39;\ x1b&#39;</code> 和 <code>&#39;[&#39;</code> 字符。因此，我们将形式为 <code>24;80</code> 的字符串传递给 <code>sscanf()</code>。我们还将字符串 <code>％d;％d</code> 传递给它，该字符串告诉它解析 <strong>用<code>;</code>分隔的两个整数</strong>，然后将值放入 <code>rows</code> 和 <code>cols</code> 变量中。</p>
<p>现在，我们用于获取窗口大小的后备方案已经完成。您应该看到 <code>editorDrawRows()</code> 根据终端的高度打印了正确的波浪号。</p>
<p>现在，我们知道后备方案起作用了，让我们删除 <code>if</code> 条件中的暂时逻辑， <code>1 ||</code>逻辑。</p>
<h3 id="Step-34"><a href="#Step-34" class="headerlink" title="Step 34"></a>Step 34</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">ws</span>;</span></span><br><span class="line">  <span class="keyword">if</span> (ioctl(STDOUT_FILENO, TIOCGWINSZ, &amp;ws) == <span class="number">-1</span> || ws.ws_col == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (write(STDOUT_FILENO, <span class="string">&quot;\x1b[999C\x1b[999B&quot;</span>, <span class="number">12</span>) != <span class="number">12</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> getCursorPosition(rows, cols);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *cols = ws.ws_col;</span><br><span class="line">    *rows = ws.ws_row;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/back-to-ioctl" >源代码<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="The-last-line-最后一行"><a href="#The-last-line-最后一行" class="headerlink" title="The last line 最后一行"></a>The last line 最后一行</h2><p>也许您注意到屏幕的最后一行似乎没有波浪号。那是因为我们的代码中有一个小错误。当我们打印最后的波浪号时，然后像在其他任何行上一样打印 <code>&quot;\r\n&quot;</code>，但这会导致终端滚动以便为新的空白行腾出空间。让我们在打印 <code>&quot;\r\n&quot;</code> 时将最后一行作为例外。</p>
<h3 id="Step-35"><a href="#Step-35" class="headerlink" title="Step 35"></a>Step 35</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/last-line" >源代码<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="Append-buffer-缓冲区追加"><a href="#Append-buffer-缓冲区追加" class="headerlink" title="Append buffer 缓冲区追加"></a>Append buffer 缓冲区追加</h2><p>每次刷新屏幕时都使用一堆小的 <code>write()</code> 并不是一个好主意。最好做一个大的 <code>write()</code>，以确保整个屏幕立即刷新。不然的话，小的<code>write()</code>之间可能会有无法预测的停顿，这将导致令人讨厌的闪烁效果。</p>
<p>我们想用将字符串追加到缓冲区的代码替换所有的 <code>write()</code> 调用，然后在最后将缓冲区 <code>write()</code>出。不幸的是，C没有动态字符串，因此我们将创建我们动态字符串类型来支持一个操作：追加。</p>
<p>首先，创建一个新的 <code>/*** 追加缓冲区 ***/</code>部分，并在其下定义 <code>abuf</code> 结构。</p>
<h3 id="Step-36"><a href="#Step-36" class="headerlink" title="Step 36"></a>Step 36</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *b;</span><br><span class="line">  <span class="keyword">int</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ABUF_INIT &#123;NULL, 0&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/abuf-struct" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>缓冲区追加(结构体)由指向内存中我们缓冲区的指针和一个长度组成。我们定义一个 <code>ABUF_INIT</code> 常量，表示一个空缓冲区。这充当我们 <code>abuf</code> 类型的构造函数。</p>
<p>接下来，让我们定义 <code>abAppend()</code> 操作以及 <code>abFree()</code> 析构函数。</p>
<h3 id="Step-37"><a href="#Step-37" class="headerlink" title="Step 37"></a>Step 37</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> &#123;</span> … &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ABUF_INIT &#123;NULL, 0&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">abAppend</span><span class="params">(struct abuf *ab, <span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *<span class="keyword">new</span> = <span class="built_in">realloc</span>(ab-&gt;b, ab-&gt;len + len);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">new</span> == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;<span class="keyword">new</span>[ab-&gt;len], s, len);</span><br><span class="line">  ab-&gt;b = <span class="keyword">new</span>;</span><br><span class="line">  ab-&gt;len += len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">abFree</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(ab-&gt;b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/abuf-append" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>realloc()</code> 和 <code>free()</code> 来自 <code>&lt;stdlib.h&gt;</code>. <code>memcpy()</code> 来自 <code>&lt;string.h&gt;</code>.</p>
<p>要将字符串 <code>s</code> 附加到 <code>abuf</code> 中，我们要做的第一件事是确保分配足够的内存来容纳新字符串。我们要求 <code>realloc()</code> 给我们一个内存块，它是当前字符串的大小加上我们要追加的字符串的大小。 <code>realloc()</code> 将扩展我们已经分配的内存块的大小，或者将 <code>free()</code> 释放当前的内存块并在足以容纳我们新字符串的其他地方分配新的内存块。</p>
<p>然后，我们在缓冲区中使用 <code>memcpy()</code>将字符串 <code>s</code> 复制到当前数据末尾，然后将 <code>abuf</code> 的指针和长度更新为新值。</p>
<p><code>abFree()</code> 是一个析构函数，用于释放 <code>abuf</code> 使用的动态内存。</p>
<p>好的，现在我们的 <code>abuf</code> 类型随时可以使用了。</p>
<h3 id="Step-38"><a href="#Step-38" class="headerlink" title="Step 38"></a>Step 38</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/use-abuf" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>在 <code>editorRefreshScreen()</code> 中，我们首先通过 <code>ABUF_INIT</code> 来初始化一个名为 <code>ab</code> 的新 <code>abuf</code>。然后，我们用 <code>abAppend(&amp;ab, ...)</code> 替换每次出现的 <code>write(STDOUT_FILENO, ...)</code>。我们还将 <code>ab</code> 传递给 <code>editorDrawRows()</code>，让 <code>editorDrawRows()</code> 也可以使用 <code>abAppend()</code>。最后，我们将缓冲区的内容 <code>write()</code> 到标准输出中，释放 <code>abuf</code> 使用的内存。<br><br><br><br></p>
<h2 id="Hide-the-cursor-when-repainting-重绘时隐藏光标"><a href="#Hide-the-cursor-when-repainting-重绘时隐藏光标" class="headerlink" title="Hide the cursor when repainting 重绘时隐藏光标"></a>Hide the cursor when repainting 重绘时隐藏光标</h2><p>可能还有另一个可能的会引发烦人的闪烁效果，让我们现在来解决它。终端绘制屏幕时，光标可能会在屏幕中间某个地方短暂显示以下。为了确保不会发生这种情况，让我们在刷新屏幕之前先隐藏光标，然后在刷新完成后立即再次显示。</p>
<h3 id="Step-39"><a href="#Step-39" class="headerlink" title="Step 39"></a>Step 39</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  </span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line">  </span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  </span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/hide-cursor" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们使用转义序列来告诉终端隐藏/显示光标。 <code>h</code> 和 <code>l</code>命令（<a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt100-ug/chapter3.html#SM" >Set Mode<i class="fas fa-external-link-alt"></i></a>，<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#RM" >Reset Mode<i class="fas fa-external-link-alt"></i></a>]）用于打开和关闭各种终端功能或<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#S3.3.4" >“modes”<i class="fas fa-external-link-alt"></i></a>。链接中的《VT100用户指南》并没有记录我们上面使用的参数 <code>?25</code>。光标隐藏/显示功能似乎是在 <a class="link"   target="_blank" rel="noopener" href="http://vt100.net/docs/vt510-rm/DECTCEM.html" >later VT models<i class="fas fa-external-link-alt"></i></a> 中出现的。某些终端可能不支持隐藏/显示光标，但是如果不支持，则它们只会忽略这些转义序列，所以，不支持显示隐藏的终端添加以上代码也没有问题。</p>
<br>
<br>

<h2 id="Clear-lines-one-at-a-time"><a href="#Clear-lines-one-at-a-time" class="headerlink" title="Clear lines one at a time"></a>Clear lines one at a time</h2><p>与其在每次刷新之前清除整个屏幕，不如在重新绘制它们时清除每一行似乎更为理想。让我们删除 <code>&lt;esc&gt;[2J</code>（清除整个屏幕）转义序列，然后在我们绘制的每行末尾放置一个 <code>&lt;esc&gt;[K</code> 序列。</p>
<h3 id="Step-40"><a href="#Step-40" class="headerlink" title="Step 40"></a>Step 40</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/clear-line" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>K</code> 命令（<a class="link"   target="_blank" rel="noopener" href="https://vt100.net/docs/vt100-ug/chapter3.html#EL" >Erase In Line<i class="fas fa-external-link-alt"></i></a>）擦除当前行的一部分。其参数类似于 <code>J</code> 命令的参数：<code>2</code> 擦除整行，<code>1</code> 擦除光标左侧的行部分，<code>0</code> 擦除光标右侧的行部分。 <code>0</code> 是默认参数，这就是我们想要的，因此我们省略该参数，直接使用 <code>&lt;esc&gt;[K</code>。<br><br><br><br></p>
<h2 id="Welcome-message-欢迎消息"><a href="#Welcome-message-欢迎消息" class="headerlink" title="Welcome message 欢迎消息"></a>Welcome message 欢迎消息</h2><p>是时候显示欢迎消息了。让我们在屏幕下方三分之一处显示编辑器的名称和版本号。</p>
<h3 id="Step-41"><a href="#Step-41" class="headerlink" title="Step 41"></a>Step 41</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">      <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">        <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">      <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">      abAppend(ab, welcome, welcomelen);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/welcome" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>snprintf()</code> 来自 <code>&lt;stdio.h&gt;</code>。</p>
<p>我们使用 <code>welcome</code> 缓冲区和 <code>snprintf()</code> 将 <code>KILO_VERSION</code> 字符串插入到欢迎消息中。如果终端太小而无法容纳我们的欢迎信息，我们还将截断字符串的长度。</p>
<p>现在，将其居中。</p>
<h3 id="Step-42"><a href="#Step-42" class="headerlink" title="Step 42"></a>Step 42</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> y;</span><br><span class="line">  <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; E.screenrows; y++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (y == E.screenrows / <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">char</span> welcome[<span class="number">80</span>];</span><br><span class="line">      <span class="keyword">int</span> welcomelen = <span class="built_in">snprintf</span>(welcome, <span class="keyword">sizeof</span>(welcome),</span><br><span class="line">        <span class="string">&quot;Kilo editor -- version %s&quot;</span>, KILO_VERSION);</span><br><span class="line">      <span class="keyword">if</span> (welcomelen &gt; E.screencols) welcomelen = E.screencols;</span><br><span class="line">      <span class="keyword">int</span> padding = (E.screencols - welcomelen) / <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">if</span> (padding) &#123;</span><br><span class="line">        abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        padding--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (padding--) abAppend(ab, <span class="string">&quot; &quot;</span>, <span class="number">1</span>);</span><br><span class="line">      abAppend(ab, welcome, welcomelen);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;~&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    abAppend(ab, <span class="string">&quot;\x1b[K&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (y &lt; E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">      abAppend(ab, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/center" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>要使字符串居中，我们将屏幕宽度除以 <code>2</code>，然后从中减去字符串长度的一半。也就是：<code>E.screencols/2 - welcomelen/2</code>，简化一下得 <code>(E.screencols - welcomelen) / 2</code>。它告诉您应该从屏幕的左边缘得什么位置开始打印。因此，我们用空格字符填充该空间，但第一个字符除外，第一个字符应为波浪号。<br><br><br><br></p>
<h2 id="Move-the-cursor-移动光标"><a href="#Move-the-cursor-移动光标" class="headerlink" title="Move the cursor 移动光标"></a>Move the cursor 移动光标</h2><p>现在让我们专注于输入。我们希望用户能够移动他们的光标。第一步是在全局编辑器状态下跟踪光标的x和y位置。</p>
<h3 id="Step-43"><a href="#Step-43" class="headerlink" title="Step 43"></a>Step 43</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> cx, cy;</span><br><span class="line">  <span class="keyword">int</span> screenrows;</span><br><span class="line">  <span class="keyword">int</span> screencols;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">orig_termios</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">editorConfig</span> <span class="title">E</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E.cx = <span class="number">0</span>;</span><br><span class="line">  E.cy = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (getWindowSize(&amp;E.screenrows, &amp;E.screencols) == <span class="number">-1</span>) die(<span class="string">&quot;getWindowSize&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/cx-cy" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>E.cx</code> 是光标的水平坐标（列），<code>E.cy</code> 是垂直坐标（行）。我们希望将它们都初始化为 <code>0</code>，因为我们希望光标从屏幕的左上角开始。 （由于C语言使用从 <code>0</code> 开始的索引，因此我们将尽可能使用0索引的值。）</p>
<p>现在，让我们添加点代码到 <code>editorRefreshScreen()</code> 中，将光标坐标存 <code>E.cx</code> 和 <code>E.cy</code>中。</p>
<h3 id="Step-44"><a href="#Step-44" class="headerlink" title="Step 44"></a>Step 44</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorDrawRows</span><span class="params">(struct abuf *ab)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorRefreshScreen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">abuf</span> <span class="title">ab</span> =</span> ABUF_INIT;</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25l&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  editorDrawRows(&amp;ab);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;\x1b[%d;%dH&quot;</span>, E.cy + <span class="number">1</span>, E.cx + <span class="number">1</span>);</span><br><span class="line">  abAppend(&amp;ab, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">  abAppend(&amp;ab, <span class="string">&quot;\x1b[?25h&quot;</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  write(STDOUT_FILENO, ab.b, ab.len);</span><br><span class="line">  abFree(&amp;ab);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/set-cursor-position" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p><code>strlen()</code> 来自 <code>&lt;string.h&gt;</code>。</p>
<p>我们将旧的 <code>H</code> 命令更改为带有参数的 <code>H</code> 命令，指定了我们希望光标移动到的确切位置。 （请确保您删除了旧的 <code>H</code> 命令，因为上面的diff所显示一样，这一点很容易错过。）</p>
<p>我们在 <code>E.cy</code> 和 <code>E.cx</code> 上加1，以将 <code>0</code> 索引值转换为终端使用的 <code>1</code> 索引值。</p>
<p>此时，您可以尝试将 <code>E.cx</code> 初始化为 <code>10</code> 或类似的值，或者将 <code>E.cx++</code> 插入主循环中，以确认代码到目前为止是否可以正常工作。</p>
<p>接下来，我们将允许用户使用 <code>w</code> <code>a</code> <code>s</code> <code>d</code> 键移动光标。 （如果您不熟悉将这些键用作箭头键：<code>w</code> 是向上箭头，<code>s</code> 是向下箭头，<code>a</code> 是左箭头，<code>d</code> 是右箭头。）</p>
<h3 id="Step-45"><a href="#Step-45" class="headerlink" title="Step 45"></a>Step 45</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">*** includes ***/</span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">char</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">      E.cx--;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">      E.cx++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">      E.cy--;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">      E.cy++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> c = editorReadKey();</span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/move-cursor" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，您应该能够使用这些键移动光标。<br><br><br><br></p>
<h2 id="Arrow-keys-箭头键"><a href="#Arrow-keys-箭头键" class="headerlink" title="Arrow keys 箭头键"></a>Arrow keys 箭头键</h2><p>现在，我们可以映射按键来移动光标，让我们用箭头键替换 <code>w</code> <code>a</code> <code>s</code> <code>d</code>键。在上一章中，我们 <a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/02.enteringRawMode.html#display-keypresses" >看<i class="fas fa-external-link-alt"></i></a> 到按箭头键会将多个字节作为输入发送到我们的程序。这些字节采用转义序列的形式，以 <code>&#39;\x1b&#39;</code>，<code>&#39;[&#39;</code> 开头，然后是 <code>&#39;A&#39;</code>，<code>&#39;B&#39;</code>，<code>&#39;C&#39;</code> 或 <code>&#39;D&#39;</code>(具体取决于具体的箭头)。让我们修改 <code>editorReadKey()</code> 将这些转义序列以单个按键的方式阅读。</p>
<h3 id="Step-46"><a href="#Step-46" class="headerlink" title="Step 46"></a>Step 46</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> seq[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">0</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">1</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;w&#x27;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/detect-arrow-keys" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果读取到一个转义字符，则立即将另外两个字节读取到 <code>seq</code> 缓冲区中。如果这些读取中的任何一个都超时（在0.1秒后），那么我们假设用户只是按下了 <code>Escape</code> 键并返回该键。否则，我们将检查转义序列是否为箭头键转义序列。如果是的话，我们暂时返回相应的<code>w</code> <code>a</code> <code>s</code> <code>d</code>字符。如果不是我们识别出的转义序列，我们只返回转义字符。</p>
<p>我们将 <code>seq</code> 缓冲区的长度设置为 <code>3</code> 个字节，因为将来我们将处理更长的转义序列。</p>
<p>我们基本上已经将箭头键化为<code>w</code> <code>a</code> <code>s</code> <code>d</code>键。这样可以使箭头键立即生效，但将<code>w</code> <code>a</code> <code>s</code> <code>d</code>键仍映射到<code>editorMoveCursor()</code> 函数。我们想要的是<code>editorReadKey()</code> 为每个箭头键返回特殊值，以使我们能够确定按下的是特定的箭头键。</p>
<p>首先，用常数 <code>ARROW_UP</code>，<code>ARROW_LEFT</code>，<code>ARROW_DOWN</code> 和 <code>ARROW_RIGHT</code> 替换<code>w</code> <code>a</code> <code>s</code> <code>d</code>字符的每个实例。</p>
<h3 id="Step-47"><a href="#Step-47" class="headerlink" title="Step 47"></a>Step 47</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span></span><br><span class="line">  ARROW_LEFT = <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">  ARROW_RIGHT = <span class="string">&#x27;d&#x27;</span>,</span><br><span class="line">  ARROW_UP = <span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">  ARROW_DOWN = <span class="string">&#x27;s&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> seq[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">0</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">1</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>: <span class="keyword">return</span> ARROW_UP;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">return</span> ARROW_DOWN;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> ARROW_RIGHT;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> ARROW_LEFT;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">char</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      E.cx--;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      E.cx++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      E.cy--;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      E.cy++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> c = editorReadKey();</span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/arrow-keys-enum" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在，我们只需要对于 <code>editorKey</code> 枚举，为箭头键选择与<code>w</code> <code>a</code> <code>s</code> <code>d</code>不冲突的表示形式。我们将给它们一个大的整数值，该值超出了 <code>char</code> 表示的范围，这样它们就不会与任何普通的按键冲突。我们还必须将所有存储按键的变量更改为 <code>int</code> 类型而不是 <code>char</code> 类型。</p>
<h3 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span></span><br><span class="line">  ARROW_LEFT = <span class="number">1000</span>,</span><br><span class="line">  ARROW_RIGHT,</span><br><span class="line">  ARROW_UP,</span><br><span class="line">  ARROW_DOWN</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> seq[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">0</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">1</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>: <span class="keyword">return</span> ARROW_UP;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">return</span> ARROW_DOWN;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> ARROW_RIGHT;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> ARROW_LEFT;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      E.cx--;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      E.cx++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      E.cy--;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      E.cy++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/arrow-keys-int" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>通过将枚举中的第一个常数设置为1000，其余常数将获得递增值1001、1002、1003，依此类推。</p>
<p>至此我们的箭头键处理代码结束了。此时，尝试在程序运行时手动输入一个转义序列可能会很有趣。尝试快速依次按 <code>Escape</code> 键，<code>[</code> 键和 <code>Shift + C</code>，您可能会发现按键被解释为按下了向右箭头键。您必须非常快地执行此操作，因此您可能需要临时调整 <code>enableRawMode()</code>中的VTIME值，以使其更容易此操作。 （这也有助于知道按 <code>Ctrl-[</code> 与按 <code>Escape</code> 键是相同的，原因与 <code>Ctrl-M</code> 与按 <code>Enter</code> 相同：<code>Ctrl</code> 会清除您组合键的字符的第6位和第7位。）</p>
<br>
<br>

<h2 id="Prevent-moving-the-cursor-off-screen-防止光标越界"><a href="#Prevent-moving-the-cursor-off-screen-防止光标越界" class="headerlink" title="Prevent moving the cursor off screen 防止光标越界"></a>Prevent moving the cursor off screen 防止光标越界</h2><p>当前，您可以使 <code>E.cx</code> 和 <code>E.cy</code> 值变为负值，或者超过屏幕的右边缘和下边缘。让我们通过在 <code>editorMoveCursor()</code>中进行一些边界检查来防止这种情况的发生。</p>
<h3 id="Step-49"><a href="#Step-49" class="headerlink" title="Step 49"></a>Step 49</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cx--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      <span class="keyword">if</span> (E.cx != E.screencols - <span class="number">1</span>) &#123;</span><br><span class="line">        E.cx++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != <span class="number">0</span>) &#123;</span><br><span class="line">        E.cy--;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (E.cy != E.screenrows - <span class="number">1</span>) &#123;</span><br><span class="line">        E.cy++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/off-screen" >源代码<i class="fas fa-external-link-alt"></i></a><br><br><br><br></p>
<h2 id="The-Page-Up-and-Page-Down-keys-翻页键"><a href="#The-Page-Up-and-Page-Down-keys-翻页键" class="headerlink" title="The Page Up and Page Down keys 翻页键"></a>The Page Up and Page Down keys 翻页键</h2><p>为了完成我们终端的底层代码，我们需要检测更多 和箭头键一样使用转义序列的特殊按键。我们将从 <code>Page Up</code> 和 <code>Page Down</code> 键开始。 <code>Page Up</code> 是 <code>&lt;esc&gt;[5〜</code>，<code>Page Down</code> 是 <code>&lt;esc&gt;[6〜</code>。</p>
<h3 id="Step-50"><a href="#Step-50" class="headerlink" title="Step 50"></a>Step 50</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span></span><br><span class="line">  ARROW_LEFT = <span class="number">1000</span>,</span><br><span class="line">  ARROW_RIGHT,</span><br><span class="line">  ARROW_UP,</span><br><span class="line">  ARROW_DOWN,</span><br><span class="line">  PAGE_UP,</span><br><span class="line">  PAGE_DOWN</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> seq[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">0</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">1</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (seq[<span class="number">1</span>] &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; seq[<span class="number">1</span>] &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">2</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (seq[<span class="number">2</span>] == <span class="string">&#x27;~&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>: <span class="keyword">return</span> PAGE_UP;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>: <span class="keyword">return</span> PAGE_DOWN;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>: <span class="keyword">return</span> ARROW_UP;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">return</span> ARROW_DOWN;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> ARROW_RIGHT;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> ARROW_LEFT;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/detect-page-up-down" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>现在您了解了为什么我们声明 <code>seq</code> 时给它3个字节。如果 <code>[</code> 后面的字节是数字，我们读取另一个字节，期望它是 <code>〜</code>。然后，我们测试数字以查看它是 <code>5</code> 还是 <code>6</code>。</p>
<p>让我们让 <code>Page Up</code> 和 <code>Page Down</code> 也做点什么。现在，先（暂时）让它们将光标移动到屏幕顶部或屏幕底部。</p>
<h3 id="Step-51"><a href="#Step-51" class="headerlink" title="Step 51"></a>Step 51</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/page-up-down-simple" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们使用一对大括号创建一个代码块，以便我们可以声明 <code>times</code> 变量。 （您不能在 <code>switch</code> 语句中直接声明变量。）我们模拟用户按下 <code>↑</code> 或 <code>↓</code> 键足够多的时间以移动到屏幕顶部或底部。当我们实现滚动时，我们将以这种方式实现 <code>Page Up</code> 和 <code>Page Down</code>。</p>
<p>如果您使用带 <code>Fn</code> 键的笔记本电脑，则可以按 <code>Fn + ↑</code> 和 <code>Fn + ↓ </code>来模拟按 <code>Page Up</code> 和 <code>Page Down</code>键。<br><br><br><br></p>
<h2 id="The-Home-and-End-keys-Home-和-End-键"><a href="#The-Home-and-End-keys-Home-和-End-键" class="headerlink" title="The Home and End keys Home 和 End 键"></a>The <code>Home</code> and <code>End</code> keys <code>Home</code> 和 <code>End</code> 键</h2><p>现在，实现 <code>Home</code> 和 <code>End</code> 键。与先前的键一样，这些键也发送转义序列。与以前的键不同，这些键可以发送许多不同的转义序列，具体取决于您的操作系统或终端。 <code>Home</code> 键可以作为 <code>&lt;esc&gt;[1〜</code>，<code>&lt;esc&gt;[7〜</code>，<code>&lt;esc&gt;[H</code> 或 <code>&lt;esc&gt;OH]</code>。同样， <code>End</code> 键可以作为<code>&lt;esc&gt;[4〜</code>， <code>&lt;esc&gt;[8〜</code>， <code>&lt;esc&gt;[F</code> 或 <code>&lt;esc&gt;OF&gt;</code>。让我们处理所有这些情况。</p>
<h3 id="Step-52"><a href="#Step-52" class="headerlink" title="Step 52"></a>Step 52</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span></span><br><span class="line">  ARROW_LEFT = <span class="number">1000</span>,</span><br><span class="line">  ARROW_RIGHT,</span><br><span class="line">  ARROW_UP,</span><br><span class="line">  ARROW_DOWN,</span><br><span class="line">  HOME_KEY,</span><br><span class="line">  END_KEY,</span><br><span class="line">  PAGE_UP,</span><br><span class="line">  PAGE_DOWN</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> seq[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">0</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">1</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (seq[<span class="number">1</span>] &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; seq[<span class="number">1</span>] &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">2</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (seq[<span class="number">2</span>] == <span class="string">&#x27;~&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>: <span class="keyword">return</span> PAGE_UP;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>: <span class="keyword">return</span> PAGE_DOWN;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;8&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>: <span class="keyword">return</span> ARROW_UP;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">return</span> ARROW_DOWN;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> ARROW_RIGHT;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> ARROW_LEFT;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;O&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/detect-home-end" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>我们来让 <code>Home</code> 和 <code>End</code> 做点事情。现在，我们先让它们移动光标到屏幕左右边缘。</p>
<h3 id="Step-53"><a href="#Step-53" class="headerlink" title="Step 53"></a>Step 53</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorMoveCursor</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123; … &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editorProcessKeypress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> c = editorReadKey();</span><br><span class="line">  <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">case</span> <span class="title">CTRL_KEY</span><span class="params">(<span class="string">&#x27;q&#x27;</span>)</span>:</span></span><br><span class="line"><span class="function">      <span class="title">write</span><span class="params">(STDOUT_FILENO, <span class="string">&quot;\x1b[2J&quot;</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">      write(STDOUT_FILENO, <span class="string">&quot;\x1b[H&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HOME_KEY:</span><br><span class="line">      E.cx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> END_KEY:</span><br><span class="line">      E.cx = E.screencols - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> PAGE_DOWN:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">int</span> times = E.screenrows;</span><br><span class="line">        <span class="keyword">while</span> (times--)</span><br><span class="line">          editorMoveCursor(c == PAGE_UP ? ARROW_UP : ARROW_DOWN);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ARROW_UP:</span><br><span class="line">    <span class="keyword">case</span> ARROW_DOWN:</span><br><span class="line">    <span class="keyword">case</span> ARROW_LEFT:</span><br><span class="line">    <span class="keyword">case</span> ARROW_RIGHT:</span><br><span class="line">      editorMoveCursor(c);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/home-end-simple" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果您使用的是带有 <code>Fn</code> 键的笔记本电脑，则可以按 <code>Fn + ←</code> 和 <code>Fn + →</code> 来模拟按<code>Home</code> 和 <code>End</code> 键。</p>
<br>
<br>

<h2 id="The-Delete-key-删除键"><a href="#The-Delete-key-删除键" class="headerlink" title="The Delete key 删除键"></a>The <code>Delete</code> key 删除键</h2><p>最后，让我们检测一下Delete键。它只发送一个转义序列 <code>&lt;esc&gt;[3〜</code>，因此很容易添加到我们的switch语句中。我们暂时不会将此键做任何事情。</p>
<h3 id="Step-54"><a href="#Step-54" class="headerlink" title="Step 54"></a>Step 54</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** includes ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** defines ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KILO_VERSION <span class="meta-string">&quot;0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTRL_KEY(k) ((k) &amp; 0x1f)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">editorKey</span> &#123;</span></span><br><span class="line">  ARROW_LEFT = <span class="number">1000</span>,</span><br><span class="line">  ARROW_RIGHT,</span><br><span class="line">  ARROW_UP,</span><br><span class="line">  ARROW_DOWN,</span><br><span class="line">  DEL_KEY,</span><br><span class="line">  HOME_KEY,</span><br><span class="line">  END_KEY,</span><br><span class="line">  PAGE_UP,</span><br><span class="line">  PAGE_DOWN</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** data ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** terminal ***/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enableRawMode</span><span class="params">()</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">editorReadKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> nread;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">  <span class="keyword">while</span> ((nread = read(STDIN_FILENO, &amp;c, <span class="number">1</span>)) != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno != EAGAIN) die(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;\x1b&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">char</span> seq[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">0</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">1</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (seq[<span class="number">1</span>] &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; seq[<span class="number">1</span>] &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (read(STDIN_FILENO, &amp;seq[<span class="number">2</span>], <span class="number">1</span>) != <span class="number">1</span>) <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (seq[<span class="number">2</span>] == <span class="string">&#x27;~&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>: <span class="keyword">return</span> DEL_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>: <span class="keyword">return</span> PAGE_UP;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>: <span class="keyword">return</span> PAGE_DOWN;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;8&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>: <span class="keyword">return</span> ARROW_UP;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">return</span> ARROW_DOWN;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">return</span> ARROW_RIGHT;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: <span class="keyword">return</span> ARROW_LEFT;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seq[<span class="number">0</span>] == <span class="string">&#x27;O&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (seq[<span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>: <span class="keyword">return</span> HOME_KEY;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>: <span class="keyword">return</span> END_KEY;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\x1b&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCursorPosition</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWindowSize</span><span class="params">(<span class="keyword">int</span> *rows, <span class="keyword">int</span> *cols)</span> </span>&#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** append buffer ***/</span></span><br><span class="line"><span class="comment">/*** output ***/</span></span><br><span class="line"><span class="comment">/*** input ***/</span></span><br><span class="line"><span class="comment">/*** init ***/</span></span><br></pre></td></tr></table></figure>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/snaptoken/kilo-src/tree/detect-delete-key" >源代码<i class="fas fa-external-link-alt"></i></a></p>
<p>如果您使用的是带 <code>Fn</code> 键的笔记本电脑，则可以按 <code>Fn + Backspace</code> 来模拟按 <code>Delete</code>键。</p>
<p>在 <a class="link"   target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/04.aTextViewer.html" >下一章<i class="fas fa-external-link-alt"></i></a> 中，我们将使我们的程序显示文本文件，包括垂直和水平滚动以及状态栏。</p>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/03/02/%E5%8D%83%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA%E4%B8%AA%E4%BA%BA%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%88%E5%9B%9B%EF%BC%89A-Text-Viewer/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">千行代码构建个人文本编辑器（四）A text viewer</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/02/26/%E5%8D%83%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA%E4%B8%AA%E4%BA%BA%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%EF%BC%88%E4%BA%8C%EF%BC%89Entering-raw-mode/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">千行代码构建个人文本编辑器（二）Entering raw mode</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Ling</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.0</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>



<script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/dark-light-toggle.js"></script>







<div class="post-scripts">
    
</div>



</body>
</html>
